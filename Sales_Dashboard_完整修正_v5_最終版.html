<!DOCTYPE html>

<html lang="zh-TW">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="no-cache, no-store, must-revalidate" http-equiv="Cache-Control"/>
<meta content="no-cache" http-equiv="Pragma"/>
<meta content="0" http-equiv="Expires"/>
<title>Sales Performance Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1E40AF;
            --primary-hover: #1E3A8A;
            --text: #000000;
            --text-secondary: #374151;
            --text-light: #6B7280;
            --bg: #F9FAFB;
            --card-bg: #FFFFFF;
            --border: #9CA3AF;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            margin: 0;
            padding: 0;
        }

        /* 側邊導航欄 */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 60px;
            height: 100vh;
            background: #1F2937;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem 0;
            z-index: 1000;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
            transition: width 0.3s ease;
        }

        .sidebar.expanded {
            width: 220px;
        }

        .sidebar-item {
            width: 100%;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            color: #9CA3AF;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .sidebar-item:hover {
            background: #374151;
            color: white;
            border-left-color: var(--primary);
        }

        .sidebar-item.active {
            background: #374151;
            color: white;
            border-left-color: var(--primary);
        }

        .sidebar-icon {
            min-width: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-icon svg {
            stroke: currentColor;
        }

        .sidebar-text {
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar.expanded .sidebar-text {
            opacity: 1;
        }

        .sidebar-toggle {
            margin-bottom: 1rem;
            padding: 0.75rem;
        }

        /* 主要內容區域調整 */
        .main-content {
            margin-left: 60px;
            transition: margin-left 0.3s ease;
        }

        .sidebar.expanded ~ .main-content {
            margin-left: 220px;
        }

        .topbar {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
        }

        .topbar h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text);
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* 搜尋框 */
        .search-box {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            min-width: 300px;
            transition: all 0.2s ease;
        }

        .search-box:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .search-box svg {
            color: var(--text-light);
        }

        .search-box input {
            border: none;
            background: none;
            outline: none;
            flex: 1;
            font-size: 0.875rem;
            color: var(--text);
        }

        .search-box input::placeholder {
            color: var(--text-light);
        }

        .search-box kbd {
            font-size: 0.75rem;
            padding: 0.125rem 0.375rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--card-bg);
            color: var(--text-light);
        }

        /* 篩選按鈕 */
        .filter-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            background: var(--bg);
            border-color: var(--primary);
        }

        .filter-btn svg {
            stroke: currentColor;
        }

        /* 用戶資訊 */
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .user-info:hover {
            background: var(--border);
        }

        .user-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        /* 用戶下拉選單 */
        .user-menu {
            position: absolute;
            top: 60px;
            right: 2rem;
            width: 280px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            display: none;
        }

        .user-menu.show {
            display: block;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-menu-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.25rem;
        }

        .user-avatar-large {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.25rem;
        }

        .user-menu-name {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.125rem;
        }

        .user-menu-email {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .user-menu-divider {
            height: 1px;
            background: var(--border);
            margin: 0.5rem 0;
        }

        .user-menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.25rem;
            color: var(--text);
            text-decoration: none;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-menu-item:hover {
            background: var(--bg);
        }

        .user-menu-item svg {
            color: var(--text-secondary);
        }

        .user-menu-item:hover svg {
            color: var(--primary);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .upload-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .upload-section h2 {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text);
        }

        .upload-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .upload-card {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-card:hover {
            border-color: var(--primary);
            background: #F0FDF4;
        }

        .upload-card.uploaded {
            border-color: var(--primary);
            border-style: solid;
            background: #F0FDF4;
        }

        .upload-card h3 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .upload-card p {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .file-name {
            font-size: 0.75rem;
            color: var(--primary);
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .btn-generate {
            width: 100%;
            padding: 0.875rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-generate:hover:not(:disabled) {
            background: var(--primary-hover);
        }

        .btn-generate:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .dashboard {
            display: none;
        }

        .dashboard.show {
            display: block;
        }

        .dashboard-header {
            margin-bottom: 2rem;
        }

        .dashboard-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .dashboard-header p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .stat-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-total {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text);
        }

        .chart-container {
            position: relative;
            height: 220px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 2rem;
            overflow-y: auto;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            max-width: 1000px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: var(--bg);
            color: var(--text);
        }

        .bar-chart-container {
            height: 450px;
            margin-bottom: 1rem;
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.875rem;
        }

        .detail-table th,
        .detail-table td {
            padding: 0.875rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .detail-table th {
            background: var(--bg);
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        .detail-table tbody tr {
            transition: background 0.15s ease;
        }

        .detail-table tbody tr:hover {
            background: var(--bg);
        }

        .file-input {
            display: none;
        }

        .processing {
            display: none;
            text-align: center;
            padding: 4rem 2rem;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .processing.show {
            display: block;
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 0.7s linear infinite;
            margin: 0 auto 1rem;
        }

        .processing h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .processing p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .stats-grid,
            .upload-grid {
                grid-template-columns: 1fr;
            }
        }

        .table-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .result-table {
            width: 100%;
            min-width: 1600px;
            border-collapse: collapse;
            font-size: 0.8125rem;
        }

        .result-table th,
        .result-table td {
            padding: 0.625rem 0.5rem;
            text-align: center;
            border: 1px solid var(--border);
        }

        .result-table th {
            background: #F9FAFB;
            font-weight: 600;
        }

        .result-table td:first-child,
        .result-table th:first-child {
            font-weight: 700;
            background: #F9FAFB;
            position: sticky;
            left: 0;
            z-index: 10;
        }

        .single-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        .single-table th,
        .single-table td {
            padding: 0.75rem;
            text-align: center;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
            font-weight: 400;
        }

        .single-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        .single-table td:first-child,
        .single-table th:first-child {
            font-weight: 700;
            background: #F9FAFB;
            color: var(--text);
        }
        
        /* Sales Result 表格：所有數字欄位靠右 */
        #detailedPerformanceTable tbody td {
            text-align: right !important;
            padding: 0.75rem !important;
        }
        
        /* Region 欄位（第一欄）置中 */
        #detailedPerformanceTable tbody td:first-child {
            text-align: center !important;
        }
        
        /* 表頭保持置中 */
        #detailedPerformanceTable thead th {
            text-align: center !important;
        }

        .single-table tbody tr:hover {
            background: #F9FAFB;
        }

        .single-total-row {
            background: #FEF3C7 !important;
            font-weight: 700;
        }

        .single-total-row td:first-child {
            background: #FDE68A !important;
        }

        /* 熱力圖樣式 */
        .heatmap-cell {
            position: relative;
        }

        .heatmap-level-0 { background-color: #F0FDF4 !important; } /* 最低 - 淺綠 */
        .heatmap-level-1 { background-color: #DCFCE7 !important; }
        .heatmap-level-2 { background-color: #BBF7D0 !important; }
        .heatmap-level-3 { background-color: #86EFAC !important; }
        .heatmap-level-4 { background-color: #4ADE80 !important; }
        .heatmap-level-5 { background-color: #22C55E !important; color: white; } /* 最高 - 深綠 */

        /* 趨勢圖樣式 */
        .trend-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .trend-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .trend-card h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text);
        }

        .trend-chart-container {
            height: 300px;
            position: relative;
        }

        .trend-card-large {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .trend-card-large h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text);
        }

        .trend-chart-container-large {
            height: 350px;
            position: relative;
        }

        .section-subtitle {
            margin-bottom: 1.5rem;
        }

        .section-subtitle h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .section-subtitle p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        @media (max-width: 1024px) {
            .trend-section {
                grid-template-columns: 1fr;
            }
        }

        /* KPI 卡片樣式 */
        .kpi-section {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .kpi-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px);
            border-color: var(--primary);
        }

        .kpi-card:active {
            transform: translateY(-2px);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .kpi-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .kpi-label::after {
            content: '→';
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .kpi-card:hover .kpi-label::after {
            opacity: 0.5;
        }

        .kpi-icon {
            font-size: 1.5rem;
            opacity: 0.5;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .kpi-trend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .trend-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .trend-badge.trend-up {
            background: #D1FAE5;
            color: #065F46;
        }

        .trend-badge.trend-down {
            background: #FEE2E2;
            color: #991B1B;
        }

        .trend-badge svg {
            stroke: currentColor;
        }

        .trend-label {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        @media (max-width: 1024px) {
            .kpi-section {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .kpi-section {
                grid-template-columns: 1fr;
            }
        }

        /* 篩選面板 */
        .filter-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: var(--card-bg);
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .filter-panel.show {
            right: 0;
        }

        .filter-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filter-header h3 {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text);
        }

        .close-filter {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .close-filter:hover {
            background: var(--bg);
            color: var(--text);
        }

        .filter-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .filter-group {
            margin-bottom: 1.5rem;
        }

        .filter-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.75rem;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 400;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background 0.2s ease;
        }

        .checkbox-group label:hover {
            background: var(--bg);
        }

        .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .filter-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.875rem;
            color: var(--text);
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 0.75rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .btn-reset,
        .btn-apply {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-reset {
            background: var(--bg);
            color: var(--text-secondary);
        }

        .btn-reset:hover {
            background: var(--border);
        }

        .btn-apply {
            background: var(--primary);
            color: white;
        }

        .btn-apply:hover {
            background: var(--primary-hover);
        }

        /* 篩選遮罩 */
        .filter-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            display: none;
        }

        .filter-overlay.show {
            display: block;
        }

        .month-header {
            background: var(--primary) !important;
            color: white !important;
            font-size: 0.875rem;
        }

        .subheader {
            background: #1E40AF !important;
            color: white !important;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .total-row {
            background: #FEF3C7 !important;
            font-weight: 700;
        }

        .total-row td:first-child {
            background: #FDE68A !important;
        }

        .btn-download {
            width: 100%;
            padding: 0.875rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-download:hover {
            background: var(--primary-hover);
        }

        /* 設定模態框 */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .settings-modal.show {
            display: flex;
        }

        .settings-content {
            background: var(--card-bg);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .settings-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text);
            margin: 0;
        }

        .close-settings {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .close-settings:hover {
            background: var(--bg);
            color: var(--text);
        }

        .settings-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            max-height: calc(90vh - 200px);
        }

        .settings-section {
            margin-bottom: 2rem;
            opacity: 1;
            visibility: visible;
        }

        .settings-section:last-child {
            margin-bottom: 0;
        }

        .settings-section h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 1rem;
        }

        .settings-group {
            margin-bottom: 1.5rem;
        }

        .settings-group:last-child {
            margin-bottom: 0;
        }

        .settings-group > label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.75rem;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .checkbox-grid label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
        }

        .checkbox-grid input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .settings-select {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.875rem;
            color: var(--text);
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .settings-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .switch-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 0.75rem 0;
        }

        .switch-label span {
            font-size: 0.875rem;
            color: var(--text);
        }

        .switch-label input[type="checkbox"] {
            width: 42px;
            height: 24px;
            cursor: pointer;
        }

        .settings-footer {
            display: flex;
            gap: 0.75rem;
            padding: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .btn-secondary {
            padding: 0.625rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text);
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn-secondary:hover {
            background: var(--bg);
        }

        .btn-primary {
            padding: 0.625rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
            background: var(--primary);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        /* Toast 通知 */
        .toast-notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            font-size: 0.875rem;
            font-weight: 500;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 9999;
        }

        .toast-notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* 詳細資料模態框 */
        .detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 4000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .detail-modal.show {
            display: flex;
        }

        .detail-modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .detail-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--primary) 0%, #1E3A8A 100%);
        }

        .detail-modal-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            margin: 0;
        }

        .close-detail {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: white;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .close-detail:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .detail-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .detail-info {
            background: var(--bg);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .detail-info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .detail-info-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .detail-value {
            font-weight: 700;
            color: var(--text);
            font-size: 1.125rem;
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .detail-table th {
            background: var(--primary);
            color: white;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .detail-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .detail-table tr:hover {
            background: var(--bg);
        }
    

        /* ==================== Front-end Access Control (UI Only) ==================== */
        .auth-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.6rem;
            border: 1px solid var(--border);
            border-radius: 999px;
            background: #fff;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-left: 0.75rem;
        }
        .auth-badge strong { color: var(--text); }
        .restricted {
            opacity: 0.45;
            pointer-events: none;
            filter: grayscale(0.25);
        }
        .no-access-toast {
            position: fixed;
            right: 1rem;
            bottom: 1rem;
            z-index: 99999;
            background: #111827;
            color: #fff;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-lg);
            max-width: 340px;
            font-size: 0.9rem;
            display: none;
        }
        .no-access-toast.show { display: block; }

        /* Login Modal */
        .login-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99998;
            padding: 1rem;
        }
        .login-modal.show { display: flex; }
        .login-card {
            width: 100%;
            max-width: 520px;
            background: var(--card-bg);
            border-radius: 1.25rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .login-card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }
        .login-card-title {
            font-weight: 800;
            font-size: 1.1rem;
        }
        .login-card-body { padding: 1.25rem; }
        .login-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.9rem;
            margin-top: 0.75rem;
        }
        .login-field label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.4rem;
        }
        .login-field input,
        .login-field select {
            width: 100%;
            padding: 0.75rem 0.85rem;
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            background: #fff;
            font-size: 0.95rem;
        }
        .login-hint {
            margin-top: 0.75rem;
            padding: 0.75rem 0.85rem;
            background: #f3f4f6;
            border-radius: 0.75rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.4;
        }
        .login-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        .btn-secondary {
            background: #fff;
            color: var(--text);
            border: 1px solid var(--border);
            padding: 0.7rem 1rem;
            border-radius: 0.75rem;
            cursor: pointer;
            font-weight: 600;
        }
        .btn-primary {
            background: var(--primary);
            color: #fff;
            border: 1px solid var(--primary);
            padding: 0.7rem 1rem;
            border-radius: 0.75rem;
            cursor: pointer;
            font-weight: 700;
        }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-secondary:hover { background: #f9fafb; }
        .login-error {
            display: none;
            margin-top: 0.75rem;
            padding: 0.65rem 0.85rem;
            border-radius: 0.75rem;
            background: #fee2e2;
            color: #991b1b;
            font-size: 0.9rem;
        }
        .login-error.show { display: block; }

        /* Dashboard Tabs */
        .dashboard-tabs { margin-top: 1.5rem; }
        .tab-nav {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
            position: sticky;
            top: 0.75rem;
            z-index: 5;
        }
        .tab-btn {
            appearance: none;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            color: #111827;
            padding: 0.6rem 0.9rem;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .tab-btn:hover { background: #f3f4f6; }
        .tab-btn.active {
            background: #111827;
            color: #ffffff;
            border-color: #111827;
        }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        .kpi-target-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        .kpi-target-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        }
        .kpi-target-card .label { color: #6b7280; font-size: 0.85rem; font-weight: 700; }
        .kpi-target-card .value { margin-top: 0.35rem; font-size: 1.35rem; font-weight: 800; color: #111827; }
        .kpi-target-card .note { margin-top: 0.35rem; font-size: 0.8rem; color: #6b7280; }

    
        /* KPI Target - Finalized Pro Layout */
        .kpi-target-region { margin-top: 1.5rem; }
        .kpi-target-top { display: grid; grid-template-columns: 1.35fr 0.65fr; gap: 1rem; margin-top: 1rem; align-items: stretch; }
        .kpi-scorecard { background:#fff; border:1px solid #e5e7eb; border-radius: 12px; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
        .kpi-scorecard h3 { margin:0 0 .75rem 0; font-size: .95rem; color:#111827; }
        .kpi-score-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap: .75rem; }
        .kpi-chip { border:1px solid #e5e7eb; border-radius: 10px; padding: .75rem; background: #ffffff; }
        .kpi-chip .label { font-size:.75rem; color:#6B7280; font-weight:700; }
        .kpi-chip .value { margin-top:.25rem; font-size:1.05rem; font-weight:800; color:#111827; }
        .kpi-chip .sub { margin-top:.15rem; font-size:.75rem; color:#6B7280; font-weight:700; }

        /* KPI Target - Top 4 metrics grouped (Revenue / New SI) */
        .kpi-metric-groups{ display:grid; grid-template-columns: 1fr 1fr; gap:.9rem; margin-top:.65rem; }
        .kpi-metric-group{ background:#ffffff; border:1px solid #e5e7eb; border-radius:14px; padding:.85rem; box-shadow: 0 1px 3px rgba(0,0,0,0.06); position:relative; overflow:hidden; }
        .kpi-metric-group::before{ content:''; position:absolute; left:0; top:0; bottom:0; width:6px; background:#111827; opacity:.25; }
        .kpi-metric-group .group-header{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; margin-bottom:.65rem; }
        .kpi-metric-group .group-title{ font-size:.85rem; font-weight:900; letter-spacing:.06em; text-transform:uppercase; color:#111827; }
        .kpi-metric-group .group-sub{ font-size:.75rem; font-weight:700; color:#6B7280; }
        .kpi-metric-group .group-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:.75rem; }
        .kpi-metric-group .kpi-chip{ border-radius:12px; padding:.85rem; }
        .kpi-metric-group .kpi-chip .value{ font-size:1.25rem; }
        .kpi-metric-group.revenue::before{ background: var(--primary); opacity:.35; }
        .kpi-metric-group.newsi::before{ background:#6D28D9; opacity:.25; }
        @media (max-width: 900px){ .kpi-metric-groups{ grid-template-columns: 1fr; } }
        .bullet-wrap { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
        .bullet-title { display:flex; justify-content:space-between; align-items:flex-end; gap:.5rem; margin-bottom:.75rem; }
        .bullet-title h3{ margin:0; font-size:.95rem; color:#111827; }
        .bullet-title .meta{ font-size:.75rem; color:#6B7280; font-weight:700; }
        .kpi-bullets { display:flex; flex-direction:column; gap:.6rem; }
        .bullet-row { display:grid; grid-template-columns: 120px 1fr 90px; gap:.75rem; align-items:center; }
        .bullet-row .name { font-size:.8rem; color:#374151; font-weight:800; }
        .bullet-row .right { text-align:right; font-size:.8rem; color:#374151; font-weight:800; }
        .bullet-track { position:relative; height: 14px; border-radius: 999px; background: #f3f4f6; overflow:hidden; }
        .bullet-budget { position:absolute; left:0; top:0; bottom:0; width:0%; background:#e5e7eb; }
        .bullet-actual { position:absolute; left:0; top:0; bottom:0; width:0%; background:#111827; opacity:.85; }
        .bullet-openpo { position:absolute; left:0; top:0; bottom:0; width:0%; background:#9ca3af; opacity:.55; }
        .bullet-marker { position:absolute; top:-3px; width:2px; height:20px; background:#111827; opacity:.85; }
        .bullet-hover { cursor:pointer; }
        .score-pill { display:inline-flex; align-items:center; gap:.35rem; padding:.15rem .5rem; border-radius: 999px; font-size:.75rem; font-weight:800; border:1px solid #e5e7eb; background:#fff; color:#111827; }
        .score-pill.good { border-color:#86efac; background:#f0fdf4; }
        .score-pill.warn { border-color:#fde68a; background:#fffbeb; }
        .score-pill.bad { border-color:#fecaca; background:#fef2f2; }
        @media (max-width: 1100px){ .kpi-target-top{ grid-template-columns: 1fr; } .bullet-row{ grid-template-columns: 110px 1fr 80px; } }
        @media (max-width: 900px){ .kpi-target-grid{ grid-template-columns: 1fr 1fr; } }
        @media (max-width: 520px){ .kpi-target-grid{ grid-template-columns: 1fr; } }

</style>
<style>
/* Hide KPI card decorative icons */
.kpi-card .kpi-icon,
.kpi-card .icon,
.kpi-card .emoji,
.kpi-card .kpi-emoji,
.kpi-card .kpi-card-icon,
.kpi-card .kpi-header-icon{display:none !important;}
/* If KPI header uses grid with icon col, collapse */
.kpi-card .kpi-header{grid-template-columns:1fr !important;}
</style></head>
<body>
<!-- 側邊導航欄 -->
<nav class="sidebar" id="sidebar">
<a class="sidebar-item sidebar-toggle" onclick="toggleSidebar()">
<span class="sidebar-icon">
<svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<line x1="3" x2="21" y1="12" y2="12"></line>
<line x1="3" x2="21" y1="6" y2="6"></line>
<line x1="3" x2="21" y1="18" y2="18"></line>
</svg>
</span>
<span class="sidebar-text">選單</span>
</a>
<a class="sidebar-item" onclick="scrollToSection('top')">
<span class="sidebar-icon">
<svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
</span>
<span class="sidebar-text">首頁</span>
</a>
<a class="sidebar-item" onclick="scrollToSection('upload')">
<span class="sidebar-icon">
<svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="17 8 12 3 7 8"></polyline>
<line x1="12" x2="12" y1="3" y2="15"></line>
</svg>
</span>
<span class="sidebar-text">上傳檔案</span>
</a>
<a class="sidebar-item" onclick="scrollToSection('integrated')">
<span class="sidebar-icon">
<svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<rect height="7" width="7" x="3" y="3"></rect>
<rect height="7" width="7" x="14" y="3"></rect>
<rect height="7" width="7" x="14" y="14"></rect>
<rect height="7" width="7" x="3" y="14"></rect>
</svg>
</span>
<span class="sidebar-text">整合報表</span>
</a>
<a class="sidebar-item" onclick="scrollToSection('janGap')">
<span class="sidebar-icon">
<svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<path d="M3 3v18h18"></path>
<path d="M18 17V9"></path>
<path d="M13 17V5"></path>
<path d="M8 17v-3"></path>
</svg>
</span>
<span class="sidebar-text">Jan Gap</span>
</a><a class="sidebar-item" onclick="scrollToSection('salesBudget')"><span class="sidebar-icon"><svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20"><line x1="12" x2="12" y1="1" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg></span><span class="sidebar-text">Sales Budget</span></a>
<a class="sidebar-item" onclick="scrollToSection('material2025')">
<span class="sidebar-icon">
<svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<path d="M4 7h16M4 12h16M4 17h10"></path>
</svg>
</span>
<span class="sidebar-text">VORTEX SKU Overview</span>
</a>
<a class="sidebar-item" onclick="scrollToSection('charts')">
<span class="sidebar-icon">
<svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 2a10 10 0 0 1 7.94 16.06L12 12V2z"></path>
</svg>
</span>
<span class="sidebar-text">圓餅圖</span>
</a>
<a class="sidebar-item" onclick="scrollToSection('trends')">
<span class="sidebar-icon">
<svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
</svg>
</span>
<span class="sidebar-text">趨勢分析</span>
</a>
<a class="sidebar-item" onclick="downloadResults()">
<span class="sidebar-icon">
<svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="7 10 12 15 17 10"></polyline>
<line x1="12" x2="12" y1="15" y2="3"></line>
</svg>
</span>
<span class="sidebar-text">下載報表</span>
</a>
</nav>
<!-- 主要內容區 -->
<div class="main-content">
<!-- 篩選遮罩 -->
<div class="filter-overlay" id="filterOverlay" onclick="toggleFilterPanel()"></div>
<div class="topbar">
<div class="topbar-left">
<div class="logo">📊</div>
<h1>Sales Performance Dashboard</h1>
</div>
<div class="topbar-right">
<div class="search-box">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<circle cx="11" cy="11" r="8"></circle>
<path d="m21 21-4.35-4.35"></path>
</svg>
<input id="searchInput" onkeyup="handleSearch()" placeholder="搜尋..." type="text"/>
<kbd>⌘ K</kbd>
</div>
<button class="filter-btn" onclick="toggleFilterPanel()">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
</svg>
                篩選
            </button>
<div class="auth-badge" title="前端 UI 權限（非後端安全控管）"><span>🔐</span><span id="authBadgeText">未登入</span></div>
<div class="user-info" onclick="toggleUserMenu()">
<span class="user-name">Daniel</span>
<div class="user-avatar">D</div>
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" style="margin-left: 0.25rem;" viewbox="0 0 24 24" width="16">
<polyline points="6 9 12 15 18 9"></polyline>
</svg>
</div>
<!-- 用戶下拉選單 -->
<div class="user-menu" id="userMenu">
<div class="user-menu-header">
<div class="user-avatar-large">D</div>
<div>
<div class="user-menu-name">Daniel Wang</div>
<div class="user-menu-email"><a class="__cf_email__" data-cfemail="e4adc9a0a5aaada1a8cab3a5aaa3a480818890859393ca878b89" href="/cdn-cgi/l/email-protection">[email protected]</a></div>
</div>
</div>
<div class="user-menu-divider"></div>
<a class="user-menu-item" onclick="showDataInfo()">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<circle cx="12" cy="12" r="10"></circle>
<line x1="12" x2="12" y1="16" y2="12"></line>
<line x1="12" x2="12.01" y1="8" y2="8"></line>
</svg>
                    資料資訊
                </a>
<a class="user-menu-item" onclick="exportAllData()">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="7 10 12 15 17 10"></polyline>
<line x1="12" x2="12" y1="15" y2="3"></line>
</svg>
                    匯出全部數據
                </a>
<a class="user-menu-item" onclick="printDashboard()">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<polyline points="6 9 6 2 18 2 18 9"></polyline>
<path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
<rect height="8" width="12" x="6" y="14"></rect>
</svg>
                    列印報表
                </a>
<div class="user-menu-divider"></div>
<a class="user-menu-item" onclick="showLoginModal()">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<path d="M15 3H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h9"></path>
<polyline points="10 17 15 12 10 7"></polyline>
<line x1="15" x2="21" y1="12" y2="12"></line>
</svg>
                    登入 / 切換區域
                </a>
<a class="user-menu-item" onclick="logout()">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<path d="M9 21H6a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3"></path>
<polyline points="16 17 21 12 16 7"></polyline>
<line x1="21" x2="9" y1="12" y2="12"></line>
</svg>
                    登出
                </a>
<div class="user-menu-divider"></div>
<a class="user-menu-item" onclick="showSettings()">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<circle cx="12" cy="12" r="3"></circle>
<path d="M12 1v6m0 6v6m5.657-13.657l-4.243 4.243m-2.828 2.828l-4.243 4.243m16.97-2.828l-4.243-4.243m-2.828-2.828l-4.243-4.243"></path>
</svg>
                    設定
                </a>
<a class="user-menu-item" onclick="showHelp()">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16">
<circle cx="12" cy="12" r="10"></circle>
<path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
<line x1="12" x2="12.01" y1="17" y2="17"></line>
</svg>
                    說明文件
                </a>
</div>
</div>
</div>
<div class="container">
<!-- 詳細資料模態框 -->
<div class="detail-modal" id="cellDetailModal">
<div class="detail-modal-content">
<div class="detail-modal-header">
<h2 id="detailModalTitle">詳細資料</h2>
<button class="close-detail" onclick="closeCellDetail()">×</button>
</div>
<div class="detail-modal-body" id="detailModalBody">
<!-- 詳細資料將在這裡顯示 -->
</div>
</div>
</div>
<!-- 設定模態框 -->
<div class="settings-modal" id="settingsModal">
<div class="settings-content">
<div class="settings-header">
<h2>設定</h2>
<button class="close-settings" onclick="closeSettings()">×</button>
</div>
<div class="settings-body">
<div class="settings-section">
<h3>預設篩選</h3>
<div class="settings-group">
<label>預設顯示區域</label>
<div class="checkbox-grid">
<label><input checked="" id="defaultTW" type="checkbox"/> TW</label>
<label><input checked="" id="defaultANZ" type="checkbox"/> ANZ</label>
<label><input checked="" id="defaultEU" type="checkbox"/> EU</label>
<label><input checked="" id="defaultVJP" type="checkbox"/> VJP</label>
<label><input checked="" id="defaultMN" type="checkbox"/> MN</label>
<label><input checked="" id="defaultDEJ" type="checkbox"/> DEJ</label>
<label><input checked="" id="defaultVU" type="checkbox"/> VU</label>
</div>
</div>
<div class="settings-group">
<label>預設月份範圍</label>
<select class="settings-select" id="defaultMonthRange">
<option value="all">全年</option>
<option value="q1">Q1 (Jan-Mar)</option>
<option value="q2">Q2 (Apr-Jun)</option>
<option value="q3">Q3 (Jul-Sep)</option>
<option value="q4">Q4 (Oct-Dec)</option>
<option value="h1">上半年 (Jan-Jun)</option>
<option value="h2">下半年 (Jul-Dec)</option>
</select>
</div>
</div>
<div class="settings-section">
<h3>顯示選項</h3>
<div class="settings-group">
<label class="switch-label">
<input checked="" id="showHeatmap" type="checkbox"/>
<span>顯示熱力圖</span>
</label>
</div>
<div class="settings-group">
<label class="switch-label">
<input checked="" id="autoRefresh" type="checkbox"/>
<span>自動更新圖表</span>
</label>
</div>
<div class="settings-group">
<label class="switch-label">
<input checked="" id="showLegend" type="checkbox"/>
<span>顯示圖表圖例</span>
</label>
</div>
</div>
<div class="settings-section">
<h3>數字格式</h3>
<div class="settings-group">
<label>千位分隔符</label>
<select class="settings-select" id="numberFormat">
<option value="comma">逗號 (1,000)</option>
<option value="space">空格 (1 000)</option>
<option value="none">無 (1000)</option>
</select>
</div>
<div class="settings-group">
<label>小數位數</label>
<select class="settings-select" id="decimalPlaces">
<option selected="" value="0">0 位</option>
<option value="1">1 位</option>
<option value="2">2 位</option>
</select>
</div>
</div>
</div>
<div class="settings-footer">
<button class="btn-secondary" onclick="resetSettings()">恢復預設</button>
<button class="btn-secondary" onclick="previewSettings()">預覽效果</button>
<button class="btn-primary" onclick="saveSettings()">儲存並套用</button>
</div>
</div>
</div>
<!-- 篩選面板 -->
<div class="filter-panel" id="filterPanel">
<div class="filter-header">
<h3>篩選選項</h3>
<button class="close-filter" onclick="toggleFilterPanel()">×</button>
</div>
<div class="filter-content">
<div class="filter-group">
<label>選擇區域</label>
<div class="checkbox-group">
<label><input checked="" onchange="applyFilters()" type="checkbox" value="TW"/> TW</label>
<label><input checked="" onchange="applyFilters()" type="checkbox" value="ANZ"/> ANZ</label>
<label><input checked="" onchange="applyFilters()" type="checkbox" value="EU"/> EU</label>
<label><input checked="" onchange="applyFilters()" type="checkbox" value="VJP"/> VJP</label>
<label><input checked="" onchange="applyFilters()" type="checkbox" value="MN"/> MN</label>
<label><input checked="" onchange="applyFilters()" type="checkbox" value="DEJ"/> DEJ</label>
<label><input checked="" onchange="applyFilters()" type="checkbox" value="VU"/> VU</label>
</div>
</div>
<div class="filter-group">
<label>月份範圍</label>
<select id="monthRangeFilter" onchange="applyFilters()">
<option value="all">全年</option>
<option value="q1">Q1 (Jan-Mar)</option>
<option value="q2">Q2 (Apr-Jun)</option>
<option value="q3">Q3 (Jul-Sep)</option>
<option value="q4">Q4 (Oct-Dec)</option>
<option value="h1">上半年 (Jan-Jun)</option>
<option value="h2">下半年 (Jul-Dec)</option>
</select>
</div>
<div class="filter-group">
<label>顯示數據</label>
<div class="checkbox-group">
<label><input checked="" id="showBudget" onchange="applyFilters()" type="checkbox"/> Sales Budget</label>
<label><input checked="" id="showRolling" onchange="applyFilters()" type="checkbox"/> Rolling</label>
<label><input checked="" id="showActual" onchange="applyFilters()" type="checkbox"/> Actual</label>
<label><input checked="" id="showOpenPO" onchange="applyFilters()" type="checkbox"/> Open PO</label>
</div>
</div>
<div class="filter-actions">
<button class="btn-reset" onclick="resetFilters()">重置</button>
<button class="btn-apply" onclick="applyFilters(); toggleFilterPanel()">套用</button>
</div>
</div>
</div>
<div class="upload-section" id="upload">
<h2>📁 上傳資料檔案</h2>
<div class="upload-grid">
<div class="upload-card" id="openpoCard" onclick="document.getElementById('openpoInput').click()">
<h3>OPEN PO</h3>
<p>點擊上傳 Excel 檔案</p>
<input accept=".xlsx,.xls" class="file-input" id="openpoInput" onchange="handleFileUpload('openpo', this.files[0])" type="file"/>
<div class="file-name" id="openpoName"></div>
</div>
<div class="upload-card" id="budgetCard" onclick="document.getElementById('budgetInput').click()">
<h3>Sales Budget</h3>
<p>點擊上傳 Excel 檔案</p>
<input accept=".xlsx,.xls" class="file-input" id="budgetInput" onchange="handleFileUpload('budget', this.files[0])" type="file"/>
<div class="file-name" id="budgetName"></div>
</div>
<div class="upload-card" id="rollingCard" onclick="document.getElementById('rollingInput').click()">
<h3>Rolling</h3>
<p>點擊上傳 Excel 檔案</p>
<input accept=".xlsx,.xls" class="file-input" id="rollingInput" onchange="handleFileUpload('rolling', this.files[0])" type="file"/>
<div class="file-name" id="rollingName"></div>
</div>
<div class="upload-card" id="actualCard" onclick="document.getElementById('actualInput').click()">
<h3>Actual</h3>
<p>點擊上傳 Excel 檔案</p>
<input accept=".xlsx,.xls" class="file-input" id="actualInput" onchange="handleFileUpload('actual', this.files[0])" type="file"/>
<div class="file-name" id="actualName"></div>
</div>
<div class="upload-card" id="material2025Card" onclick="document.getElementById('material2025Input').click()">
<h3>VORTEX SKU Overview</h3>
<p>2025_0105 物料明細</p>
<input accept=".xlsx,.xls" class="file-input" id="material2025Input" onchange="handleFileUpload('material2025', this.files[0])" type="file"/>
<div class="file-name" id="material2025Name"></div>
</div>
<div class="upload-card" id="materialRefCard" onclick="document.getElementById('materialRefInput').click()">
<h3>物料參考資料</h3>
<p>All_VORTEX_Models_硬體</p>
<input accept=".xlsx,.xls" class="file-input" id="materialRefInput" onchange="handleFileUpload('materialRef', this.files[0])" type="file"/>
<div class="file-name" id="materialRefName"></div>
</div>
<div class="upload-card" id="rollingDemandCard" onclick="document.getElementById('rollingDemandInput').click()">
<h3>Rolling Demand History</h3>
<p>All_Regional_Reports</p>
<input accept=".xlsx,.xls" class="file-input" id="rollingDemandInput" onchange="handleFileUpload('rollingDemand', this.files[0])" type="file"/>
<div class="file-name" id="rollingDemandName"></div>
</div>
</div>
<button class="btn-generate" disabled="" id="processBtn" onclick="processAllFiles()">
                生成 Dashboard
            </button>
</div>
<div class="processing" id="processing">
<div class="spinner"></div>
<h3>處理中...</h3>
<p>正在整合三個檔案的數據，請稍候</p>
</div>
<div class="dashboard" id="dashboard">
<div class="dashboard-tabs">
<div aria-label="Dashboard Tabs" class="tab-nav" role="tablist">
<button aria-selected="true" class="tab-btn active" id="tabBtnOverview" onclick="switchDashboardTab('overview')" role="tab">📊 Overview</button>
<button aria-selected="false" class="tab-btn" id="tabBtnKpiTarget" onclick="switchDashboardTab('kpiTarget')" role="tab">🎯 KPI Target</button>
</div>
<div aria-labelledby="tabBtnOverview" class="tab-pane active" id="dashboardOverview" role="tabpanel">
<!-- KPI 卡片區 -->
<div class="kpi-section">
<div class="kpi-card" onclick="showTableModal('budget')" style="cursor: pointer;">
<div class="kpi-header">
<span class="kpi-label">Total Budget (USD, K)</span>

</div>
<div class="kpi-value" id="kpiBudget">-</div>
<div class="kpi-trend">
<span class="trend-label">Annual Budget Sum (點擊查看表格)</span>
</div>
</div>
<div class="kpi-card" onclick="showTableModal('rolling')" style="cursor: pointer;">
<div class="kpi-header">
<span class="kpi-label">Total Rolling (USD, K)</span>

</div>
<div class="kpi-value" id="kpiRolling">-</div>
<div class="kpi-trend">
<span class="trend-label" id="kpiRollingTrend">Forecast Total (點擊查看表格)</span>
</div>
</div>
<div class="kpi-card" onclick="showTableModal('openpo')" style="cursor: pointer;">
<div class="kpi-header">
<span class="kpi-label">Total Open PO (USD, K)</span>

</div>
<div class="kpi-value" id="kpiOpenPO">-</div>
<div class="kpi-trend">
<span class="trend-label">Outstanding Orders (點擊查看表格)</span>
</div>
</div>
<div class="kpi-card" onclick="scrollToSection('actual')" style="cursor: pointer;">
<div class="kpi-header">
<span class="kpi-label">Actual Hardware (USD, K)</span>

</div>
<div class="kpi-value" id="kpiActualHW">-</div>
<div class="kpi-trend">
<span class="trend-label">Hardware Total</span>
</div>
</div>
<div class="kpi-card" onclick="scrollToSection('actual')" style="cursor: pointer;">
<div class="kpi-header">
<span class="kpi-label">Actual License (USD, K)</span>

</div>
<div class="kpi-value" id="kpiActualLic">-</div>
<div class="kpi-trend">
<span class="trend-label">License Total</span>
</div>
</div>
</div>
<!-- 表格彈窗 -->
<div class="modal" id="tableModal" onclick="closeTableModal(event)">
<div class="modal-content" onclick="event.stopPropagation()" style="max-width: 95%; max-height: 90vh; overflow: auto;">
<div style="position: sticky; top: 0; background: white; z-index: 10; padding: 1.5rem; border-bottom: 2px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
<h2 id="tableModalTitle" style="margin: 0; color: #1f2937;">表格標題</h2>
<button onclick="closeTableModal()" onmouseout="this.style.background='#ef4444'" onmouseover="this.style.background='#dc2626'" style="background: #ef4444; color: white; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">×</button>
</div>
<div id="tableModalBody" style="padding: 1.5rem;">
<!-- 表格內容將動態插入 -->
</div>
</div>
</div>
<!-- 整合報表 -->
<div class="dashboard-header" id="integrated">
<h2>整合報表 (USD, K)</h2>
<p>完整的月份數據總覽</p>
</div>
<div class="table-section">
<div class="table-wrapper">
<table class="result-table" id="resultTable"></table>
</div>
<button class="btn-download" onclick="downloadResults()">
                    📥 下載整合報表
                </button>
<button class="btn-download" onclick="generateStandaloneReport()" style="background: #10B981; margin-left: 1rem;">
                    📊 生成獨立報告（給主管）
                </button>
</div>
<!-- Jan Sales Performance Gap -->
<div class="dashboard-header" id="janGap" style="margin-top: 3rem;">
<h2>Jan Sales Performance Gap (USD, K)</h2>
<p>一月份各區域預算達成狀況 - Sales Budget vs. Actual + Open PO</p>
</div>
<div class="table-section">
<!-- 摘要統計 -->
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1.5rem;">
<div style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); border-left: 4px solid #1E40AF;">
<div style="font-size: 0.875rem; color: #6B7280; margin-bottom: 0.5rem; font-weight: 600;">Budget</div>
<div id="janBudgetTotal" style="font-size: 1.75rem; font-weight: 700; color: #1E40AF;">-</div>
</div>
<div style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); border-left: 4px solid #10B981;">
<div style="font-size: 0.875rem; color: #6B7280; margin-bottom: 0.5rem; font-weight: 600;">Actual + Open PO</div>
<div id="janActualPlusOpenPOTotal" style="font-size: 1.75rem; font-weight: 700; color: #10B981;">-</div>
</div>
<div style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); border-left: 4px solid #EF4444;">
<div style="font-size: 0.875rem; color: #6B7280; margin-bottom: 0.5rem; font-weight: 600;">Gap</div>
<div id="janGapTotal" style="font-size: 1.75rem; font-weight: 700; color: #EF4444;">-</div>
</div>
</div>
<!-- 視覺化圖表 - 預算達成狀況 -->
<div style="margin-top: 1.5rem; background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
<h3 style="margin: 0; font-size: 1rem; font-weight: 700; color: #000000;">Budget Achievement Overview</h3>
</div>
<div id="janGapVisualization" style="display: flex; flex-direction: column; gap: 1rem;">
<!-- 圖表將由 JavaScript 動態生成 -->
</div>
</div>
<!-- Gap 明細模態框 -->
<div class="modal" id="gapDetailModal" onclick="closeGapDetailModal(event)" style="display: none;">
<div class="modal-content" onclick="event.stopPropagation()" style="max-width: 900px;">
<div style="position: sticky; top: 0; background: white; z-index: 10; padding: 1.5rem; border-bottom: 2px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
<h3 id="gapDetailTitle" style="margin: 0; font-size: 1.25rem; font-weight: 700; color: #1E40AF;"></h3>
<button onclick="closeGapDetailModal()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.5rem; line-height: 1;">×</button>
</div>
<div style="padding: 2rem;">
<!-- 摘要統計 -->
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
<div style="background: #EFF6FF; border-left: 4px solid #1E40AF; padding: 1rem; border-radius: 6px;">
<div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.25rem;">Budget</div>
<div id="detailBudget" style="font-size: 1.5rem; font-weight: 700; color: #1E40AF;"></div>
</div>
<div style="background: #D1FAE5; border-left: 4px solid #10B981; padding: 1rem; border-radius: 6px;">
<div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.25rem;">Actual</div>
<div id="detailActual" style="font-size: 1.5rem; font-weight: 700; color: #10B981;"></div>
</div>
<div style="background: #DBEAFE; border-left: 4px solid #3B82F6; padding: 1rem; border-radius: 6px;">
<div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.25rem;">Open PO</div>
<div id="detailOpenPO" style="font-size: 1.5rem; font-weight: 700; color: #3B82F6;"></div>
</div>
<div style="background: #FEE2E2; border-left: 4px solid #EF4444; padding: 1rem; border-radius: 6px;">
<div style="font-size: 0.75rem; color: #6B7280; margin-bottom: 0.25rem;">Gap</div>
<div id="detailGap" style="font-size: 1.5rem; font-weight: 700; color: #EF4444;"></div>
</div>
</div>
<!-- 詳細分析 -->
<div style="background: #F9FAFB; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
<h4 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 700; color: #000000;">達成率分析</h4>
<div style="display: flex; align-items: center; gap: 1rem;">
<div style="flex: 1; background: #E5E7EB; border-radius: 999px; height: 32px; position: relative; overflow: hidden;">
<div id="detailProgressBar" style="background: linear-gradient(to right, #10B981, #059669); height: 100%; border-radius: 999px; transition: width 0.3s ease;"></div>
<div id="detailProgressText" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 0.875rem; font-weight: 700; color: #000000;"></div>
</div>
<div id="detailAchievement" style="min-width: 80px; text-align: right; font-size: 1.5rem; font-weight: 700; color: #10B981;"></div>
</div>
</div>
<!-- 月份明細表格 -->
<div>
<h4 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 700; color: #000000;">一月份明細</h4>
<table class="single-table" style="margin: 0;">
<thead>
<tr>
<th style="background-color: #1E40AF; color: white;">項目</th>
<th style="background-color: #1E40AF; color: white;">金額 (USD, K)</th>
<th style="background-color: #1E40AF; color: white;">說明</th>
</tr>
</thead>
<tbody id="gapDetailTableBody">
<!-- 動態生成 -->
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<!-- Sales Result -->
<div class="dashboard-header" style="margin-top: 3rem;">
<h2>Sales Result (USD, K)</h2>
<p>各區域 Hardware / Subscription 分項業績追蹤</p>
</div>
<div class="table-section">
<div class="table-wrapper" style="overflow-x: auto;">
<table class="single-table" id="detailedPerformanceTable" style="font-size: 0.8em;"></table>
</div>
</div>
<!-- Budget 表格 -->
<!-- 隱藏的表格區域（用於存儲數據） -->
<div style="display: none;">
<div class="dashboard-header" id="salesBudget">
<h2>Sales Budget</h2>
<p>各區域月份預算明細</p>
</div>
<div class="table-section">
<div class="table-wrapper">
<table class="single-table" id="budgetTable"></table>
</div>
</div>
<div class="dashboard-header" id="rolling">
<h2>Rolling Forecast</h2>
<p>各區域滾動預測明細（單位：千元）</p>
</div>
<div class="table-section">
<div class="table-wrapper">
<table class="single-table" id="rollingTable"></table>
</div>
</div>
<div class="dashboard-header" id="openpo">
<h2>Open PO</h2>
<p>各區域未交訂單明細（單位：千元）</p>
</div>
<div class="table-section">
<div class="table-wrapper">
<table class="single-table" id="openpoTable"></table>
</div>
</div>
</div>
<!-- VORTEX SKU Overview -->
<div class="dashboard-header" id="material2025" style="margin-top: 3rem;">
<h2>VORTEX SKU Overview – Status, Rolling History &amp; Open POs</h2>
<p>各區域的物料編號、型號、狀態與備料記錄</p>
</div>
<div class="table-section" id="material2025Content">
<!-- 物料明細表格將動態生成 -->
</div>
<!-- 圓餅圖分析 -->
<div class="dashboard-header" id="charts" style="margin-top: 3rem;">
<h2>資料分析 (USD, K)</h2>
<p>點擊圓餅圖查看各區域詳細資料</p>
</div>
<div class="stats-grid">
<div class="stat-card">
<div class="stat-header">
<span class="stat-title">Sales Budget (USD, K)</span>
<span class="stat-total" id="budgetTotal">-</span>
</div>
<div class="chart-container">
<canvas id="budgetPieChart"></canvas>
</div>
</div>
<div class="stat-card">
<div class="stat-header">
<span class="stat-title">Rolling Forecast (USD, K)</span>
<span class="stat-total" id="rollingTotal">-</span>
</div>
<div class="chart-container">
<canvas id="rollingPieChart"></canvas>
</div>
</div>
<div class="stat-card">
<div class="stat-header">
<span class="stat-title">Open PO (USD, K)</span>
<span class="stat-total" id="openpoTotal">-</span>
</div>
<div class="chart-container">
<canvas id="openpoPieChart"></canvas>
</div>
</div>
<div class="stat-card">
<div class="stat-header">
<span class="stat-title">Actual Hardware (USD, K)</span>
<span class="stat-total" id="actualHWTotal">-</span>
</div>
<div class="chart-container">
<canvas id="actualHWPieChart"></canvas>
</div>
</div>
<div class="stat-card">
<div class="stat-header">
<span class="stat-title">Actual License (USD, K)</span>
<span class="stat-total" id="actualLicTotal">-</span>
</div>
<div class="chart-container">
<canvas id="actualLicPieChart"></canvas>
</div>
</div>
</div>
<!-- 趨勢線圖 -->
<div class="dashboard-header" id="trends" style="margin-top: 3rem;">
<h2>月份趨勢分析</h2>
<p>查看各區域的月份變化趨勢</p>
</div>
<!-- 堆疊面積圖 -->
<div class="section-subtitle">
<h3>📊 總體趨勢（堆疊面積圖）</h3>
<p>顯示各區域的累積貢獻和總量變化</p>
</div>
<div class="trend-section">
<div class="trend-card-large">
<h3>Sales Budget 總體趨勢</h3>
<div class="trend-chart-container-large">
<canvas id="budgetStackedChart"></canvas>
</div>
</div>
<div class="trend-card-large">
<h3>Rolling Forecast 總體趨勢</h3>
<div class="trend-chart-container-large">
<canvas id="rollingStackedChart"></canvas>
</div>
</div>
<div class="trend-card-large">
<h3>Open PO 總體趨勢</h3>
<div class="trend-chart-container-large">
<canvas id="openpoStackedChart"></canvas>
</div>
</div>
</div>
<!-- 互動線圖 -->
<div class="section-subtitle" style="margin-top: 2rem;">
<h3>📈 區域趨勢（互動線圖）</h3>
<p>預設顯示前三大區域，點擊圖例可切換顯示其他區域</p>
</div>
<div class="trend-section">
<div class="trend-card-large">
<h3>Sales Budget 區域趨勢</h3>
<div class="trend-chart-container-large">
<canvas id="budgetTrendChart"></canvas>
</div>
</div>
<div class="trend-card-large">
<h3>Rolling Forecast 區域趨勢</h3>
<div class="trend-chart-container-large">
<canvas id="rollingTrendChart"></canvas>
</div>
</div>
<div class="trend-card-large">
<h3>Open PO 區域趨勢</h3>
<div class="trend-chart-container-large">
<canvas id="openpoTrendChart"></canvas>
</div>
</div>
</div>
</div>
</div>
</div> <!-- /#dashboardOverview -->
<div aria-labelledby="tabBtnKpiTarget" class="tab-pane" id="dashboardKpiTarget" role="tabpanel">
<div class="dashboard-header" style="margin-top: 0;">
<h2>KPI Target</h2>
<p>點選「🎯 KPI Target」後，僅顯示 VU 區的 SI 成長目標追蹤（Target = 10 代表本期需新增 10 個新的 SI）。</p>
</div>
<div id="kpiTargetContainer"></div>
<div style="margin-top: 0.75rem; color:#6B7280; font-size:0.85rem;">
  註：Rolling 以檔案中的 Rolling(USD) / 1000 轉成 K；Budget/Actual 為檔案中原本的 K。
</div>
</div> <!-- /#dashboardKpiTarget -->
</div> <!-- /.dashboard-tabs -->
<!-- Modal for bar chart -->
<div class="modal" id="barChartModal">
<div class="modal-content">
<div class="modal-header">
<h2 id="barChartTitle"></h2>
<button class="close-btn" onclick="closeModal('barChartModal')">×</button>
</div>
<div class="bar-chart-container">
<canvas id="barChart"></canvas>
</div>
</div>
</div>
<!-- Modal for detail table -->
<div class="modal" id="detailModal">
<div class="modal-content">
<div class="modal-header">
<h2 id="detailTitle"></h2>
<button class="close-btn" onclick="closeModal('detailModal')">×</button>
</div>
<div id="detailContent"></div>
</div>
</div>
<script>
        // Version: 2.0.0 - 2025-01-09
        const uploadedFiles = { openpo: null, budget: null, rolling: null };
        let processedData = null;
        // Standalone report may preload rawData via window.EMBEDDED_REPORT_DATA.
        // Do NOT overwrite it here, otherwise drilldowns (e.g., Open PO/Actual details) become empty.
        if (window.EMBEDDED_REPORT_DATA && window.EMBEDDED_REPORT_DATA.rawData) {
            window.rawData = window.EMBEDDED_REPORT_DATA.rawData;

                        // 恢復權限狀態（保持原本各區限制）
                        if (window.EMBEDDED_REPORT_DATA.authState && typeof setAuth === 'function') {
                            try {
                                setAuth(window.EMBEDDED_REPORT_DATA.authState);
                            } catch (e) {
                                console.warn('restore authState failed', e);
                            }
                        }
        } else {
            window.rawData = { openpo: [], budget: [], rolling: [], actual: [], material2025: [] };
        }
        let rawData = window.rawData; // 保持向後兼容
        let actualData = null;
        let material2025Data = null;
        let materialReferenceData = null; // 物料參考資料（Model, EOL, Slow moving等）
        let rollingDemandData = null; // Rolling Demand History (Sep/Oct/Nov/Dec)
        let pieCharts = {};
        let currentBarChart = null;

        const regionColors = {
            TW: '#EF4444',
            ANZ: '#F59E0B',
            EU: '#10B981',
            VJP: '#3B82F6',
            MN: '#8B5CF6',
            DEJ: '#EC4899',
            VU: '#14B8A6'
        };

        function handleFileUpload(type, file) {
            if (!file) return;
            uploadedFiles[type] = file;
            document.getElementById(`${type}Name`).textContent = file.name;
            document.getElementById(`${type}Card`).classList.add('uploaded');
            checkAllFilesUploaded();
        }

        function checkAllFilesUploaded() {
            const allUploaded = uploadedFiles.openpo && uploadedFiles.budget && uploadedFiles.rolling;
            document.getElementById('processBtn').disabled = !allUploaded;
        }

        async function processAllFiles() {
            document.getElementById('processing').classList.add('show');
            
            try {
                const openpoData = await processOpenPO(uploadedFiles.openpo);
                const budgetData = await processBudget(uploadedFiles.budget);
                const rollingData = await processRolling(uploadedFiles.rolling);
                
                // 處理 Actual（如果有上傳）
                let actualDataProcessed = null;
                if (uploadedFiles.actual) {
                    try {
                        actualDataProcessed = await processActual(uploadedFiles.actual);
                        actualData = actualDataProcessed; // 保存全局變數用於獨立表格
                        console.log('✓ Actual 處理完成');
                    } catch (error) {
                        console.error('Actual 處理失敗:', error);
                        actualData = null;
                        showToast('Actual 檔案處理失敗，但其他功能正常');
                    }
                } else {
                    actualData = null;
                }

                // 處理物料參考資料（如果有上傳）
                if (uploadedFiles.materialRef) {
                    try {
                        materialReferenceData = await processMaterialReference(uploadedFiles.materialRef);
                        console.log('✓ 物料參考資料處理完成');
                    } catch (error) {
                        console.error('物料參考資料處理失敗:', error);
                        materialReferenceData = null;
                        showToast('物料參考資料處理失敗，但其他功能正常');
                    }
                } else {
                    materialReferenceData = null;
                }

                // 處理 2025_0105（如果有上傳）
                if (uploadedFiles.material2025) {
                    try {
                        material2025Data = await processMaterial2025(uploadedFiles.material2025);
                        console.log('✓ 2025_0105 處理完成');
                    } catch (error) {
                        console.error('2025_0105 處理失敗:', error);
                        material2025Data = null;
                        showToast('2025_0105 檔案處理失敗，但其他功能正常');
                    }
                } else {
                    material2025Data = null;
                }

                // 處理 Rolling Demand History（如果有上傳）
                if (uploadedFiles.rollingDemand) {
                    try {
                        rollingDemandData = await processRollingDemand(uploadedFiles.rollingDemand);
                        console.log('✓ Rolling Demand History 處理完成');
                    } catch (error) {
                        console.error('Rolling Demand History 處理失敗:', error);
                        rollingDemandData = null;
                        showToast('Rolling Demand History 處理失敗，但其他功能正常');
                    }
                } else {
                    rollingDemandData = null;
                }

                processedData = integrateData(openpoData, budgetData, rollingData, actualDataProcessed);
                
                setTimeout(() => {
                    document.getElementById('processing').classList.remove('show');
                    document.getElementById('dashboard').classList.add('show');
                    
                    // 統一使用過濾版本，確保一致性
                    // 檢查是否有區域限制，並設置初始過濾器
                    const auth = getAuth();
                    if (auth && auth.region && auth.region !== 'ADMIN' && window.REGION_ONLY_MODE) {
                        // 有區域限制，設置為該區域
                        currentFilters.regions = [auth.region];
                    } else {
                        // 無限制，設置為所有區域
                        currentFilters.regions = ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'];
                    }
                    
                    // 使用統一的過濾版本函數
                    refreshDashboardWithFilters();
                }, 1000);
            } catch (error) {
                alert('處理錯誤：' + error.message);
                console.error(error);
                document.getElementById('processing').classList.remove('show');
            }
        }

        function createPieCharts() {
            let regions = ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'];
            regions = constrainRegions(regions);
            
            // Calculate totals
            const budgetTotals = {};
            const rollingTotals = {};
            const openpoTotals = {};
            
            regions.forEach(region => {
                // 檢查該區域是否有數據
                if (!processedData[region]) {
                    budgetTotals[region] = 0;
                    return;
                }
                budgetTotals[region] = processedData[region].reduce((sum, m) => sum + m.budget, 0);
            });
            
            // Rolling: 先加總原始值，再轉千位數
            regions.forEach(region => {
                if (!processedData[region]) {
                    rollingTotals[region] = 0;
                    return;
                }
                const rawTotal = processedData[region].reduce((sum, m) => sum + m.rolling, 0);
                rollingTotals[region] = Math.round(rawTotal / 1000);
            });
            
            // Open PO: 先加總原始值，再轉千位數
            regions.forEach(region => {
                if (!processedData[region]) {
                    openpoTotals[region] = 0;
                    return;
                }
                const rawTotal = (region === 'DEJ') ? 0 : processedData[region].reduce((sum, m) => sum + (m.openpo || 0), 0);
                openpoTotals[region] = Math.round(rawTotal / 1000);
            });

            const createPieChart = (canvasId, data, type) => {
                const ctx = document.getElementById(canvasId);
                const total = Object.values(data).reduce((a, b) => a + b, 0);
                
                return new Chart(ctx, {
                    type: 'doughnut',  // 改為甜甜圈圖
                    data: {
                        labels: regions,
                        datasets: [{
                            data: regions.map(r => data[r]),
                            backgroundColor: regions.map(r => regionColors[r]),
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',  // 中間空洞大小
                        plugins: {
                            legend: { 
                                position: 'right',  // 圖例移到右側
                                labels: {
                                    padding: 12,
                                    font: { size: 11 },
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        if (data.labels.length && data.datasets.length) {
                                            return data.labels.map((label, i) => {
                                                const value = data.datasets[0].data[i];
                                                return {
                                                    text: `${label}  ${value}K`,
                                                    fillStyle: data.datasets[0].backgroundColor[i],
                                                    hidden: false,
                                                    index: i
                                                };
                                            });
                                        }
                                        return [];
                                    }
                                }
                            },
                            title: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            },
                            datalabels: {
                                display: false  // 關閉外部標籤
                            }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const region = regions[index];
                                showMonthlyBarChart(type, region);
                            }
                        }
                    },
                    plugins: [{
                        id: 'centerText',
                        afterDatasetsDraw: function(chart) {
                            const ctx = chart.ctx;
                            const chartArea = chart.chartArea;
                            
                            // 計算甜甜圈的中心點
                            const centerX = (chartArea.left + chartArea.right) / 2;
                            const centerY = (chartArea.top + chartArea.bottom) / 2;
                            
                            ctx.save();
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            
                            // 總數字
                            const fontSize = Math.min(chartArea.right - chartArea.left, chartArea.bottom - chartArea.top) / 6;
                            ctx.font = `bold ${fontSize}px Inter, sans-serif`;
                            ctx.fillStyle = '#111827';
                            ctx.fillText(total.toLocaleString(), centerX, centerY);
                            
                            ctx.restore();
                        }
                    }]
                });
            };

            pieCharts.budget = createPieChart('budgetPieChart', budgetTotals, 'budget');
            pieCharts.rolling = createPieChart('rollingPieChart', rollingTotals, 'rolling');
            pieCharts.openpo = createPieChart('openpoPieChart', openpoTotals, 'openpo');

            // Actual 圓餅圖
            const actualHWTotals = {};
            const actualLicTotals = {};
            regions.forEach(region => {
                if (!processedData[region]) {
                    actualHWTotals[region] = 0;
                    actualLicTotals[region] = 0;
                    return;
                }
                const hwSum = processedData[region].reduce((sum, m) => sum + (m.actualHW || 0), 0);
                const licSum = processedData[region].reduce((sum, m) => sum + (m.actualLicense || 0), 0);
                // 數據已經是千元
                actualHWTotals[region] = Math.round(hwSum);
                actualLicTotals[region] = Math.round(licSum);
            });

            pieCharts.actualHW = createPieChart('actualHWPieChart', actualHWTotals, 'actualHW');
            pieCharts.actualLic = createPieChart('actualLicPieChart', actualLicTotals, 'actualLic');

            // 更新總計顯示
            const budgetGrandTotal = Object.values(budgetTotals).reduce((a, b) => a + b, 0);
            const rollingGrandTotal = Object.values(rollingTotals).reduce((a, b) => a + b, 0);
            const openpoGrandTotal = Object.values(openpoTotals).reduce((a, b) => a + b, 0);
            const actualHWGrandTotal = Object.values(actualHWTotals).reduce((a, b) => a + b, 0);
            const actualLicGrandTotal = Object.values(actualLicTotals).reduce((a, b) => a + b, 0);

            document.getElementById('budgetTotal').textContent = Math.round(budgetGrandTotal).toLocaleString() + 'K';
            document.getElementById('rollingTotal').textContent = rollingGrandTotal.toLocaleString() + 'K';
            document.getElementById('openpoTotal').textContent = openpoGrandTotal.toLocaleString() + 'K';
            document.getElementById('actualHWTotal').textContent = actualHWGrandTotal.toLocaleString() + 'K';
            document.getElementById('actualLicTotal').textContent = actualLicGrandTotal.toLocaleString() + 'K';

            // 生成趨勢圖
            createStackedCharts();
            createInteractiveTrendCharts();
        }

        function createStackedCharts() {
            let regions = ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'];
            regions = constrainRegions(regions);
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            // Budget 堆疊面積圖
            const budgetDatasets = regions.map(region => ({
                label: region,
                data: processedData[region].map(m => m.budget),
                backgroundColor: regionColors[region] + 'CC',
                borderColor: regionColors[region],
                borderWidth: 1,
                fill: true
            }));

            new Chart(document.getElementById('budgetStackedChart'), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: budgetDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 15
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            callbacks: {
                                footer: function(tooltipItems) {
                                    let sum = 0;
                                    tooltipItems.forEach(item => sum += item.parsed.y);
                                    return '總計: ' + sum.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            stacked: true
                        }
                    }
                }
            });

            // Rolling 堆疊面積圖
            const rollingDatasets = regions.map(region => ({
                label: region,
                data: processedData[region].map(m => Math.round(m.rolling / 1000)),
                backgroundColor: regionColors[region] + 'CC',
                borderColor: regionColors[region],
                borderWidth: 1,
                fill: true
            }));

            new Chart(document.getElementById('rollingStackedChart'), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: rollingDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 15
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            callbacks: {
                                footer: function(tooltipItems) {
                                    let sum = 0;
                                    tooltipItems.forEach(item => sum += item.parsed.y);
                                    return '總計: ' + sum.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            stacked: true
                        }
                    }
                }
            });

            // Open PO 堆疊面積圖
            const openpoDatasets = regions.map(region => ({
                label: region,
                data: processedData[region].map(m => Math.round(m.openpo / 1000)),
                backgroundColor: regionColors[region] + 'CC',
                borderColor: regionColors[region],
                borderWidth: 1,
                fill: true
            }));

            new Chart(document.getElementById('openpoStackedChart'), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: openpoDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 15
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            callbacks: {
                                footer: function(tooltipItems) {
                                    let sum = 0;
                                    tooltipItems.forEach(item => sum += item.parsed.y);
                                    return '總計: ' + sum.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            stacked: true
                        }
                    }
                }
            });
        }

        function createInteractiveTrendCharts() {
            let regions = ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'];
            regions = constrainRegions(regions);
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            // 計算各區域總量，找出前三大
            const budgetTotals = regions.map(region => ({
                region,
                total: processedData[region].reduce((sum, m) => sum + m.budget, 0)
            })).sort((a, b) => b.total - a.total);

            const rollingTotals = regions.map(region => ({
                region,
                total: processedData[region].reduce((sum, m) => sum + m.rolling, 0)
            })).sort((a, b) => b.total - a.total);

            const openpoTotals = regions.map(region => ({
                region,
                total: processedData[region].reduce((sum, m) => sum + m.openpo, 0)
            })).sort((a, b) => b.total - a.total);

            const topBudgetRegions = budgetTotals.slice(0, 3).map(r => r.region);
            const topRollingRegions = rollingTotals.slice(0, 3).map(r => r.region);
            const topOpenpoRegions = openpoTotals.slice(0, 3).map(r => r.region);

            // Budget 互動線圖
            const budgetDatasets = regions.map(region => ({
                label: region,
                data: processedData[region].map(m => m.budget),
                borderColor: regionColors[region],
                backgroundColor: regionColors[region] + '20',
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: regionColors[region],
                pointBorderColor: regionColors[region],
                pointBorderWidth: 2,
                hidden: !topBudgetRegions.includes(region)  // 預設只顯示前三大
            }));

            new Chart(document.getElementById('budgetTrendChart'), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: budgetDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 15
                            },
                            onClick: function(e, legendItem, legend) {
                                const index = legendItem.datasetIndex;
                                const ci = legend.chart;
                                const meta = ci.getDatasetMeta(index);
                                meta.hidden = meta.hidden === null ? !ci.data.datasets[index].hidden : null;
                                ci.update();
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Rolling 互動線圖
            const rollingDatasets = regions.map(region => ({
                label: region,
                data: processedData[region].map(m => Math.round(m.rolling / 1000)),
                borderColor: regionColors[region],
                backgroundColor: regionColors[region] + '20',
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: regionColors[region],
                pointBorderColor: regionColors[region],
                pointBorderWidth: 2,
                hidden: !topRollingRegions.includes(region)
            }));

            new Chart(document.getElementById('rollingTrendChart'), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: rollingDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 15
                            },
                            onClick: function(e, legendItem, legend) {
                                const index = legendItem.datasetIndex;
                                const ci = legend.chart;
                                const meta = ci.getDatasetMeta(index);
                                meta.hidden = meta.hidden === null ? !ci.data.datasets[index].hidden : null;
                                ci.update();
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Open PO 互動線圖
            const openpoDatasets = regions.map(region => ({
                label: region,
                data: processedData[region].map(m => Math.round(m.openpo / 1000)),
                borderColor: regionColors[region],
                backgroundColor: regionColors[region] + '20',
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: regionColors[region],
                pointBorderColor: regionColors[region],
                pointBorderWidth: 2,
                hidden: !topOpenpoRegions.includes(region)
            }));

            new Chart(document.getElementById('openpoTrendChart'), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: openpoDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 15
                            },
                            onClick: function(e, legendItem, legend) {
                                const index = legendItem.datasetIndex;
                                const ci = legend.chart;
                                const meta = ci.getDatasetMeta(index);
                                meta.hidden = meta.hidden === null ? !ci.data.datasets[index].hidden : null;
                                ci.update();
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function displayResults(data) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            let regions = ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'];
            regions = constrainRegions(regions);
            
            const formatNumber = (num) => {
                if (num === 0) return '0';
                if (!num && num !== 0) return '-';
                return num.toLocaleString('en-US');
            };

            // 1. 整合報表（順序：Budget → Rolling → Actual → Open PO）
            let html = '<thead><tr><th rowspan="2">區域</th>';
            months.forEach(month => {
                html += `<th colspan="4" class="month-header">${month}</th>`;
            });
            html += '</tr><tr>';
            months.forEach(() => {
                html += '<th class="subheader">Sales Budget</th><th class="subheader">Rolling</th>';
                html += '<th class="subheader">Actual</th><th class="subheader">Open PO</th>';
            });
            html += '</tr></thead><tbody>';

            const totalsRaw = Array(12).fill(0).map(() => ({ budget: 0, rolling: 0, actual: 0, openpo: 0 }));

            regions.forEach(region => {
                // 檢查該區域是否有數據
                if (!data[region]) {
                    return; // 跳過沒有數據的區域
                }
                
                html += `<tr><td>${region}</td>`;
                for (let i = 0; i < 12; i++) {
                    const d = data[region][i];
                    const budgetValue = d.budget;
                    const rollingValue = Math.round(d.rolling / 1000);
                    const actualValue = Math.round((d.actualHW || 0) + (d.actualLicense || 0));
                    const openpoValue = (region === 'DEJ') ? 0 : Math.round((d.openpo || 0) / 1000);
                    
                    html += `<td>${formatNumber(budgetValue)}</td>`;
                    html += `<td>${formatNumber(rollingValue)}</td>`;
                    html += `<td style="background-color: #fed7aa;">${formatNumber(actualValue)}</td>`;
                    html += `<td style="background-color: #fed7aa;">${formatNumber(openpoValue)}</td>`;
                    
                    totalsRaw[i].budget += d.budget;
                    totalsRaw[i].rolling += d.rolling;
                    totalsRaw[i].actual += actualValue;
                    totalsRaw[i].openpo += (region === 'DEJ') ? 0 : (d.openpo || 0);
                }
                html += '</tr>';
            });

            html += '<tr class="total-row"><td>Total</td>';
            for (let i = 0; i < 12; i++) {
                html += `<td>${formatNumber(totalsRaw[i].budget)}</td>`;
                html += `<td>${formatNumber(Math.round(totalsRaw[i].rolling / 1000))}</td>`;
                html += `<td style="background-color: #fed7aa;">${formatNumber(totalsRaw[i].actual)}</td>`;
                html += `<td style="background-color: #fed7aa;">${formatNumber(Math.round(totalsRaw[i].openpo / 1000))}</td>`;
            }
            html += '</tr>';
            html += '</tbody>';
            document.getElementById('resultTable').innerHTML = html;

            // Helper function: 計算熱力圖等級
            function getHeatmapLevel(value, min, max) {
                if (max === min) return 0;
                const normalized = (value - min) / (max - min);
                return Math.min(5, Math.floor(normalized * 6));
            }

            // 2. Budget 單獨表格（加入熱力圖）
            let budgetValues = [];
            regions.forEach(region => {
                for (let i = 0; i < 12; i++) {
                    budgetValues.push(data[region][i].budget);
                }
            });
            const budgetMin = Math.min(...budgetValues.filter(v => v > 0));
            const budgetMax = Math.max(...budgetValues);

            let budgetHtml = '<thead><tr><th>區域</th>';
            months.forEach(month => budgetHtml += `<th>${month}</th>`);
            budgetHtml += '<th>Total</th></tr></thead><tbody>';
            
            regions.forEach(region => {
                budgetHtml += `<tr><td>${region}</td>`;
                let regionTotal = 0;
                for (let i = 0; i < 12; i++) {
                    const value = data[region][i].budget;
                    const level = value > 0 ? getHeatmapLevel(value, budgetMin, budgetMax) : 0;
                    budgetHtml += `<td class="heatmap-cell heatmap-level-${level}">${formatNumber(value)}</td>`;
                    regionTotal += value;
                }
                budgetHtml += `<td><strong>${formatNumber(regionTotal)}</strong></td></tr>`;
            });

            budgetHtml += '<tr class="single-total-row"><td>Total</td>';
            let grandTotal = 0;
            for (let i = 0; i < 12; i++) {
                const monthTotal = regions.reduce((sum, r) => {
                    if (!data[r]) return sum;
                    return sum + data[r][i].budget;
                }, 0);
                budgetHtml += `<td>${formatNumber(monthTotal)}</td>`;
                grandTotal += monthTotal;
            }
            budgetHtml += `<td><strong>${formatNumber(grandTotal)}</strong></td></tr></tbody>`;
            document.getElementById('budgetTable').innerHTML = budgetHtml;

            // 3. Rolling 單獨表格（加入熱力圖）
            let rollingValues = [];
            regions.forEach(region => {
                if (!data[region]) return;
                for (let i = 0; i < 6; i++) {
                    const value = Math.round(data[region][i].rolling / 1000);
                    if (value > 0) rollingValues.push(value);
                }
            });
            const rollingMin = Math.min(...rollingValues);
            const rollingMax = Math.max(...rollingValues);

            const formatEstAR = (rate) => {
                if (!rate || !isFinite(rate)) return '#DIV/0!';
                return Math.round(rate * 100) + '%';
            };

            let rollingHtml = '<thead><tr><th>區域</th>';
            const rollingMonths = months.slice(0, 6);
            rollingMonths.forEach(month => rollingHtml += `<th>${month}</th>`);
            rollingHtml += '<th>Total</th><th>Est. A/R（6R/Budget）</th></tr></thead><tbody>';
            
            regions.forEach(region => {
                if (!data[region]) return;
                rollingHtml += `<tr><td>${region}</td>`;
                let regionTotal = 0;
                for (let i = 0; i < 6; i++) {
                    const value = Math.round(data[region][i].rolling / 1000);
                    const level = value > 0 ? getHeatmapLevel(value, rollingMin, rollingMax) : 0;
                    const monthName = rollingMonths[i];
                    rollingHtml += `<td class="heatmap-cell heatmap-level-${level}" 
                                       onclick="showCellDetail('rolling', '${region}', '${monthName}', ${i})"
                                       style="cursor: pointer;"
                                       title="點擊查看${monthName}月明細">${formatNumber(value)}</td>`;
                    regionTotal += value;
                }
                // Est. A/R（6R/Budget） = Rolling(6R) / Budget(6R)
                let budget6R = 0;
                for (let i = 0; i < 6; i++) {
                    budget6R += (data[region] && data[region][i]) ? (data[region][i].budget || 0) : 0;
                }
                const estAR = budget6R > 0 ? (regionTotal / budget6R) : 0;

                rollingHtml += `<td><strong>${formatNumber(regionTotal)}</strong></td>`;
                rollingHtml += `<td><strong>${formatEstAR(estAR)}</strong></td></tr>`;
            });

            rollingHtml += '<tr class="single-total-row"><td>Total</td>';
            let rollingGrandTotal = 0;
            for (let i = 0; i < 6; i++) {
                const monthTotal = Math.round(regions.reduce((sum, r) => {
                    if (!data[r]) return sum;
                    return sum + data[r][i].rolling;
                }, 0) / 1000);
                rollingHtml += `<td>${formatNumber(monthTotal)}</td>`;
                rollingGrandTotal += monthTotal;
            }
            // Company Est. A/R（6R/Budget） (Total Rolling / Total Budget) for Jan-Jun
            let budgetGrandTotal = 0;
            for (let i = 0; i < 6; i++) {
                const mBudget = regions.reduce((sum, r) => {
                    if (!data[r]) return sum;
                    return sum + (data[r][i].budget || 0);
                }, 0);
                budgetGrandTotal += mBudget;
            }
            const estARCompany = budgetGrandTotal > 0 ? (rollingGrandTotal / budgetGrandTotal) : 0;

            rollingHtml += `<td><strong>${formatNumber(rollingGrandTotal)}</strong></td>`;
            rollingHtml += `<td><strong>${formatEstAR(estARCompany)}</strong></td></tr></tbody>`;
            document.getElementById('rollingTable').innerHTML = rollingHtml;

            // 4. Open PO 單獨表格（加入熱力圖）
            let openpoValues = [];
            regions.forEach(region => {
                if (!data[region]) return;
                for (let i = 0; i < 12; i++) {
                    const value = (region === 'DEJ') ? 0 : Math.round((data[region][i].openpo || 0) / 1000);
                    if (value > 0) openpoValues.push(value);
                }
            });
            const openpoMin = Math.min(...openpoValues);
            const openpoMax = Math.max(...openpoValues);

            let openpoHtml = '<thead><tr><th>區域</th>';
            months.forEach(month => openpoHtml += `<th>${month}</th>`);
            openpoHtml += '<th>Total</th></tr></thead><tbody>';
            
            regions.forEach(region => {
                if (!data[region]) return;
                openpoHtml += `<tr><td>${region}</td>`;
                let regionTotal = 0;
                for (let i = 0; i < 12; i++) {
                    const value = (region === 'DEJ') ? 0 : Math.round((data[region][i].openpo || 0) / 1000);
                    const level = value > 0 ? getHeatmapLevel(value, openpoMin, openpoMax) : 0;
                    const monthName = months[i];
                    openpoHtml += `<td class="heatmap-cell heatmap-level-${level}" 
                                      onclick="showCellDetail('openpo', '${region}', '${monthName}', ${i})"
                                      style="cursor: pointer;"
                                      title="點擊查看${monthName}月明細">${formatNumber(value)}</td>`;
                    regionTotal += value;
                }
                openpoHtml += `<td><strong>${formatNumber(regionTotal)}</strong></td></tr>`;
            });

            openpoHtml += '<tr class="single-total-row"><td>Total</td>';
            let openpoGrandTotal = 0;
            for (let i = 0; i < 12; i++) {
                const monthTotal = Math.round(regions.reduce((sum, r) => {
                    if (!data[r]) return sum;
                    return sum + ((r === 'DEJ') ? 0 : (data[r][i].openpo || 0));
                }, 0) / 1000);
                openpoHtml += `<td>${formatNumber(monthTotal)}</td>`;
                openpoGrandTotal += monthTotal;
            }
            openpoHtml += `<td><strong>${formatNumber(openpoGrandTotal)}</strong></td></tr></tbody>`;
            document.getElementById('openpoTable').innerHTML = openpoHtml;

            // 創建 Jan Sales Performance Gap 圖表
            createJanGapChart(data);

            // 顯示詳細業績表格
            displayDetailedPerformance(data, actualData);

            // 顯示 2025_0105 物料明細
            if (material2025Data) {
                displayMaterial2025(material2025Data);
            }

            // 為表格單元格添加點擊事件
            setTimeout(() => {
                addCellClickEvents();
            }, 100);
        }

        function createJanGapChart(data) {
            let regions = ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'];
            regions = constrainRegions(regions);
            
            // 提取一月份數據（索引 0）
            const janData = {
                budget: [],
                actual: [],  // 新增：分開保存actual
                openPO: [],  // 新增：分開保存openPO
                actualPlusOpenPO: [],
                gap: []
            };
            
            regions.forEach(region => {
                const d = data[region][0]; // 一月份數據
                const budget = d.budget; // 已經是千元
                const actual = Math.round((d.actualHW || 0) + (d.actualLicense || 0)); // 已經是千元
                let openpo = Math.round(d.openpo / 1000); // 轉換為千元
                // DEJ：Jan Sales Performance Gap 不計 Open PO（避免在金額面混入不適用的 Open PO）
                if (region === 'DEJ') openpo = 0;
                const actualPlusOpenPO = actual + openpo;
                const gap = budget - actualPlusOpenPO;
                
                janData.budget.push(budget);
                janData.actual.push(actual);  // 保存actual
                janData.openPO.push(openpo);  // 保存openPO
                janData.actualPlusOpenPO.push(actualPlusOpenPO);
                janData.gap.push(gap);
            });
            
            // 保存到 window 供客戶明細彈窗使用
            window.janData = janData;
            window.janRegions = regions;
            
            // 更新摘要統計數據
            const totalBudget = janData.budget.reduce((a, b) => a + b, 0);
            const totalActualPlusOpenPO = janData.actualPlusOpenPO.reduce((a, b) => a + b, 0);
            const totalGap = janData.gap.reduce((a, b) => a + b, 0);
            
            document.getElementById('janBudgetTotal').textContent = totalBudget.toLocaleString() + 'K';
            document.getElementById('janActualPlusOpenPOTotal').textContent = totalActualPlusOpenPO.toLocaleString() + 'K';
            document.getElementById('janGapTotal').textContent = totalGap.toLocaleString() + 'K';
            
            // 根據 Gap 調整顏色
            const gapElement = document.getElementById('janGapTotal');
            if (totalGap < 0) {
                gapElement.style.color = '#DC2626'; // 紅色：已超出預算
            } else if (totalGap === 0) {
                gapElement.style.color = '#10B981'; // 綠色：完全達成
            } else {
                gapElement.style.color = '#EF4444'; // 紅色：尚未達成
            }
            
            // 生成視覺化圖表
            let chartHtml = '';
            regions.forEach((region, index) => {
                const budget = janData.budget[index];
                const actual = janData.actual[index];
                const openPO = janData.openPO[index];
                const actualPlusOpenPO = janData.actualPlusOpenPO[index];
                const gap = janData.gap[index];
                const achievement = budget > 0 ? ((actualPlusOpenPO / budget) * 100).toFixed(1) : 0;
                
                // 計算百分比（用於顯示條形寬度）
                // 限制每個條形最大100%，總和不超過100%
                let actualPercent = budget > 0 ? (actual / budget) * 100 : 0;
                let openPOPercent = budget > 0 ? (openPO / budget) * 100 : 0;
                
                // 如果總和超過100%，按比例縮放
                const totalRaw = actualPercent + openPOPercent;
                if (totalRaw > 100) {
                    const scale = 100 / totalRaw;
                    actualPercent = actualPercent * scale;
                    openPOPercent = openPOPercent * scale;
                }
                
                const totalPercent = Math.min(actualPercent + openPOPercent, 100);
                
                // 決定背景顏色
                let bgColor = '#FEE2E2'; // 淺紅色：需要改進
                if (achievement >= 100) {
                    bgColor = '#FEF3C7'; // 淺黃色：完成或超額
                } else if (achievement >= 90) {
                    bgColor = '#D1FAE5'; // 淺綠色：接近達成
                }
                
                chartHtml += `
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; transition: all 0.2s ease; border-radius: 6px;" 
                         onmouseover="this.style.backgroundColor='#F3F4F6';" 
                         onmouseout="this.style.backgroundColor='transparent';">
                        <!-- 區域標籤 -->
                        <div style="min-width: 60px; text-align: right; font-weight: 700; font-size: 0.9rem; color: #000000;">
                            ${region}
                        </div>
                        
                        <!-- 條形圖包裹容器（相對定位） -->
                        <div style="flex: 1; position: relative;">
                            
                            <!-- 條形圖容器 -->
                            <div style="position: relative; height: 36px; background-color: ${bgColor}; border-radius: 6px; overflow: hidden; border: 2px solid #9CA3AF;">
                                <!-- Budget 參考線（100%位置） -->
                                <div style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; border-right: 3px dashed #EF4444; pointer-events: none; z-index: 1;"></div>
                                
                                <!-- Actual 條形（藍色） -->
                                <div onclick="showActualDetail('${region}', ${index})" 
                                     style="position: absolute; left: 0; top: 0; width: ${actualPercent}%; height: 100%; 
                                            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); 
                                            cursor: pointer; z-index: 2; 
                                            transition: opacity 0.2s;" 
                                     onmouseover="this.style.opacity='0.8';" 
                                     onmouseout="this.style.opacity='1';"
                                     title="點擊查看 ${region} Actual 客戶明細">
                                    <!-- Actual數值標籤 -->
                                    ${actual > 0 ? `<div style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 0.7rem; font-weight: 700; color: #FFFFFF; white-space: nowrap; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                                        ${actual.toLocaleString()}K
                                    </div>` : ''}
                                </div>
                                
                                <!-- Open PO 條形（綠色，緊接在Actual後） -->
                                <div onclick="showOpenPODetail('${region}', ${index})" 
                                     style="position: absolute; left: ${actualPercent}%; top: 0; width: ${openPOPercent}%; height: 100%; 
                                            background: linear-gradient(135deg, #10B981 0%, #059669 100%); 
                                            cursor: pointer; z-index: 2; 
                                            transition: opacity 0.2s;" 
                                     onmouseover="this.style.opacity='0.8';" 
                                     onmouseout="this.style.opacity='1';"
                                     title="點擊查看 ${region} Open PO 客戶明細">
                                    <!-- Open PO數值標籤 -->
                                    ${openPO > 0 ? `<div style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 0.7rem; font-weight: 700; color: #FFFFFF; white-space: nowrap; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                                        ${openPO.toLocaleString()}K
                                    </div>` : ''}
                                </div>
                                
                                <!-- Remaining Gap 區域（粉紅色背景已由容器提供） -->
                                ${gap > 0 ? `<div style="position: absolute; left: ${totalPercent}%; top: 0; width: ${100 - totalPercent}%; height: 100%; z-index: 0; display: flex; align-items: center; justify-content: center;">
                                    <!-- Gap數值標籤（顯示在Remaining Gap中間） -->
                                    <div style="font-size: 0.7rem; font-weight: 700; color: #DC2626; white-space: nowrap;">
                                        ${gap.toLocaleString()}K
                                    </div>
                                </div>` : ''}
                            </div>
                        </div>
                        
                        <!-- Budget 數值 -->
                        <div style="min-width: 90px; text-align: left; font-size: 0.875rem; color: #374151; margin-left: 0.5rem;">
                            <span style="font-weight: 600;">Budget:</span> <span style="font-weight: 700;">${budget.toLocaleString()}K</span>
                        </div>
                        
                        <!-- Gap 數值 -->
                        <div style="min-width: 95px; text-align: left; font-size: 0.875rem; font-weight: 700; color: ${gap <= 0 ? '#10B981' : '#EF4444'};">
                            <span style="font-weight: 600; color: #374151;">Gap:</span> ${gap.toLocaleString()}K
                        </div>
                        
                        <!-- Achievement % -->
                        <div style="min-width: 65px; text-align: right; font-size: 0.875rem; font-weight: 700; color: #000000;">
                            ${achievement}%
                        </div>
                    </div>
                `;
            });
            
            // 添加圖例
            chartHtml += `
                <div style="display: flex; align-items: center; justify-content: center; gap: 2rem; margin-top: 1rem; padding: 0.75rem; background: #F9FAFB; border-radius: 6px;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 24px; height: 16px; background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); border-radius: 3px;"></div>
                        <span style="font-size: 0.875rem; color: #374151; font-weight: 600;">Actual</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 24px; height: 16px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); border-radius: 3px;"></div>
                        <span style="font-size: 0.875rem; color: #374151; font-weight: 600;">Open PO</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 24px; height: 16px; background: #FCA5A5; border-radius: 3px;"></div>
                        <span style="font-size: 0.875rem; color: #374151; font-weight: 600;">Remaining Gap</span>
                    </div>
                </div>
            `;
            
            document.getElementById('janGapVisualization').innerHTML = chartHtml;
            
            // 保存數據到全局變量供點擊查看使用
            window.janGapData = {
                regions: regions,
                data: data,
                janData: janData
            };
        }

        function showGapDetail(region, index) {
            if (!window.janGapData) {
                alert('數據尚未載入');
                return;
            }
            
            const { data, janData } = window.janGapData;
            const d = data[region][0]; // 一月份數據
            
            const budget = janData.budget[index];
            const actual = Math.round((d.actualHW || 0) + (d.actualLicense || 0));
            const openpo = Math.round(d.openpo / 1000);
            const actualPlusOpenPO = janData.actualPlusOpenPO[index];
            const gap = janData.gap[index];
            const achievement = budget > 0 ? ((actualPlusOpenPO / budget) * 100).toFixed(1) : 0;
            
            // 設置標題
            document.getElementById('gapDetailTitle').textContent = `${region} 區域 - 一月份 Gap 詳細分析`;
            
            // 設置摘要數據
            document.getElementById('detailBudget').textContent = budget.toLocaleString() + 'K';
            document.getElementById('detailActual').textContent = actual.toLocaleString() + 'K';
            document.getElementById('detailOpenPO').textContent = openpo.toLocaleString() + 'K';
            document.getElementById('detailGap').textContent = gap.toLocaleString() + 'K';
            document.getElementById('detailAchievement').textContent = achievement + '%';
            
            // 設置進度條
            const progressBar = document.getElementById('detailProgressBar');
            const progressText = document.getElementById('detailProgressText');
            const progressPercent = Math.min(parseFloat(achievement), 100);
            progressBar.style.width = progressPercent + '%';
            progressText.textContent = achievement + '%';
            
            // 根據達成率調整顏色
            if (parseFloat(achievement) >= 100) {
                progressBar.style.background = 'linear-gradient(to right, #10B981, #059669)';
                document.getElementById('detailAchievement').style.color = '#10B981';
            } else if (parseFloat(achievement) >= 80) {
                progressBar.style.background = 'linear-gradient(to right, #F59E0B, #D97706)';
                document.getElementById('detailAchievement').style.color = '#F59E0B';
            } else {
                progressBar.style.background = 'linear-gradient(to right, #EF4444, #DC2626)';
                document.getElementById('detailAchievement').style.color = '#EF4444';
            }
            
            // 生成明細表格
            let detailHtml = '';
            
            // 預算行
            detailHtml += '<tr style="background-color: #EFF6FF;">';
            detailHtml += '<td style="font-weight: 700;">Sales Budget</td>';
            detailHtml += `<td style="text-align: right; font-weight: 700; color: #1E40AF;">${budget.toLocaleString()}</td>`;
            detailHtml += '<td>一月份預算目標</td>';
            detailHtml += '</tr>';
            
            // Actual + Open PO 行
            detailHtml += '<tr style="background-color: #D1FAE5;">';
            detailHtml += '<td style="font-weight: 700;">Actual + Open PO</td>';
            detailHtml += `<td style="text-align: right; font-weight: 700; color: #10B981;">${actualPlusOpenPO.toLocaleString()}</td>`;
            detailHtml += '<td>已達成 + 即將達成</td>';
            detailHtml += '</tr>';
            
            // Gap 行
            const gapColor = gap < 0 ? '#10B981' : '#EF4444';
            const gapBgColor = gap < 0 ? '#FEF3C7' : '#FEE2E2';
            detailHtml += `<tr style="background-color: ${gapBgColor};">`;
            detailHtml += '<td style="font-weight: 700;">Gap (需達成)</td>';
            detailHtml += `<td style="text-align: right; font-weight: 700; color: ${gapColor};">${gap.toLocaleString()}</td>`;
            detailHtml += `<td>${gap < 0 ? '✅ 已超額完成' : '⚠️ 尚需達成此金額'}</td>`;
            detailHtml += '</tr>';
            
            document.getElementById('gapDetailTableBody').innerHTML = detailHtml;
            
            // 顯示模態框
            document.getElementById('gapDetailModal').style.display = 'flex';
        }

        function closeGapDetailModal(event) {
            if (event && event.target !== event.currentTarget) {
                return;
            }
            document.getElementById('gapDetailModal').style.display = 'none';
        }

        // -------- Month/Region normalization helpers (for standalone report compatibility) --------
        function _normRegion(v) {
            return String(v ?? '').trim().toUpperCase();
        }
function _regionFromActualRow(item) {
            if (!item) return '';
            const rp = String(item['REGION_PF'] ?? item['REGIONPF'] ?? item['Region PF'] ?? '').trim().toUpperCase();
            if (rp.startsWith('VTW')) return 'TW';
            if (rp.startsWith('VUS')) return 'VU';
            if (rp.startsWith('VJP')) return 'VJP';
            if (rp.startsWith('ANZ') || rp.startsWith('VAU') || rp.startsWith('VANZ')) return 'ANZ';
            if (rp.startsWith('EU') || rp.startsWith('VEU')) return 'EU';
            if (rp.startsWith('DEJ')) return 'DEJ';
            return '';
        }
        function _monthIndex(v) {
            if (v === null || v === undefined) return null;
            const s = String(v).trim();
            if (!s) return null;
            const low = s.toLowerCase();
            // English month names
            const map = {jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,sept:8,oct:9,nov:10,dec:11};
            for (const k in map) {
                if (low === k || low.startsWith(k)) return map[k];
            }
            // YYYYMM (e.g., 202601)
            if (/^\d{6}$/.test(low)) {
                const n = parseInt(low.slice(4,6), 10);
                if (!isNaN(n) && n >= 1 && n <= 12) return n - 1;
            }

            // Chinese style: 1月 / 01月
            const m1 = low.match(/(\d{1,2})\s*月/);
            if (m1) {
                const n = parseInt(m1[1], 10);
                if (!isNaN(n) && n >= 1 && n <= 12) return n - 1;
            }
            // Numeric: 1 / 01
            if (/^\d{1,2}$/.test(low)) {
                const n = parseInt(low, 10);
                if (!isNaN(n) && n >= 1 && n <= 12) return n - 1;
            }
            // ISO-ish date: 2026-01-17 or 2026/01/17
            const m2 = low.match(/\b(\d{4})[-\/]?(\d{1,2})[-\/]?(\d{1,2})\b/);
            if (m2) {
                const n = parseInt(m2[2], 10);
                if (!isNaN(n) && n >= 1 && n <= 12) return n - 1;
            }
            return null;
        }
        function _isMonth(v, idx) {
            const mi = _monthIndex(v);
            return mi === idx;
        }

        // 顯示Actual客戶明細
        function showActualDetail(region, index) {
            // UI permission gate: only allow viewing detail for your own region (or ADMIN).
            if (!requireRegionAccess(region)) {
                return;
            }
            if (!window.rawData || !window.rawData.actual) {
                alert('Actual 數據尚未載入');
                return;
            }
            
            if (!window.janData) {
                alert('Jan 數據尚未處理');
                return;
            }
            
            // 使用 janData 中的處理後數值（與長條圖一致）
            const processedTotal = window.janData.actual[index];
            
            console.log('Actual 原始數據樣本:', window.rawData.actual[0]);
            console.log(`${region} Actual 處理後總額 (長條圖顯示):`, processedTotal, 'K');
            
            // 過濾該區域一月份的Actual數據
            const januaryData = window.rawData.actual.filter(item => {
                const r0 = item.Region ?? item['REGION'] ?? _regionFromActualRow(item);
                const r = _normRegion(r0);
                const target = _normRegion(region);
                const m0 = item.Month ?? item['MONTH'] ?? item['月份'] ?? item['YEAR/MONTH'] ?? item['YEAR_MONTH'] ?? item['Billing date'] ?? item['Billing date '];
                return r === target && _isMonth(m0, 0);
            });
            
            console.log(`${region} 一月份 Actual 數據:`, januaryData.length, '筆');
            
            // 按Customer Name分組並計算總額
            const customerMap = new Map();
            januaryData.forEach(item => {
                const customer = item['Customer Name'] || item['客戶名稱'] || '未知客戶';
                const value = parseFloat(item['AMOUNT_USD']) || 0;
                console.log('處理客戶:', customer, 'AMOUNT_USD:', value);
                if (customerMap.has(customer)) {
                    customerMap.set(customer, customerMap.get(customer) + value);
                } else {
                    customerMap.set(customer, value);
                }
            });
            
            console.log('客戶統計:', Array.from(customerMap.entries()));
            
            // 轉換為數組並排序（轉換為千元）
            const customers = Array.from(customerMap.entries())
                .map(([name, value]) => ({ name, value: value / 1000 }))
                .sort((a, b) => b.value - a.value);
            
            const rawTotal = customers.reduce((sum, c) => sum + c.value, 0);
            
            // 計算縮放係數，使客戶明細加總等於 processedTotal
            const scaleFactor = rawTotal > 0 ? processedTotal / rawTotal : 1;
            console.log(`縮放係數: ${scaleFactor.toFixed(3)} (${processedTotal}K / ${rawTotal.toFixed(1)}K)`);
            
            // 將每個客戶的金額按比例縮放
            const scaledCustomers = customers.map(c => ({
                name: c.name,
                originalValue: c.value,
                value: c.value * scaleFactor
            }));
            
            // 生成彈窗內容
            let html = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 800px; max-height: 80vh; overflow-y: auto; position: relative;">
                    <button onclick="closeCustomerDetailModal()" style="position: absolute; top: 1rem; right: 1rem; background: #EF4444; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.25rem; display: flex; align-items: center; justify-content: center;">×</button>
                    
                    <h3 style="margin: 0 0 0.5rem 0; color: #1E40AF; font-size: 1.5rem;">${region} 區域 - Actual 客戶明細</h3>
                    <p style="margin: 0 0 1.5rem 0; color: #6B7280;">一月份實際銷售客戶列表（MTD 計算後）</p>
                    
                    <div style="background: #EFF6FF; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #3B82F6;">
                        <div style="font-size: 0.875rem; color: #1E40AF; margin-bottom: 0.25rem;">Total Actual</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: #1E40AF;">${Math.round(processedTotal).toLocaleString()}K</div>
                        <div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.25rem;">
                            ${scaledCustomers.length > 0 
                                ? `${scaledCustomers.length} 個客戶`
                                : '無原始客戶數據明細'}
                        </div>
                    </div>
            `;
            
            if (scaledCustomers.length === 0) {
                // 沒有客戶明細時顯示說明
                html += `
                    <div style="padding: 2rem; text-align: center; color: #6B7280; background: #F9FAFB; border-radius: 8px;">
                        <svg style="width: 48px; height: 48px; margin: 0 auto 1rem; color: #9CA3AF;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #374151;">該區域無原始客戶數據明細</p>
                        <p style="margin: 0; font-size: 0.875rem;">顯示的 Total (${Math.round(processedTotal).toLocaleString()}K) 為 MTD 計算後的匯總值</p>
                    </div>
                `;
            } else {
                // 有客戶明細時顯示表格
                html += `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #F3F4F6;">
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; font-weight: 600; color: #374151; border-bottom: 2px solid #E5E7EB;">#</th>
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; font-weight: 600; color: #374151; border-bottom: 2px solid #E5E7EB;">客戶名稱</th>
                                <th style="padding: 0.75rem; text-align: right; font-size: 0.875rem; font-weight: 600; color: #374151; border-bottom: 2px solid #E5E7EB;">Actual (K)</th>
                                <th style="padding: 0.75rem; text-align: right; font-size: 0.875rem; font-weight: 600; color: #374151; border-bottom: 2px solid #E5E7EB;">佔比</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                scaledCustomers.forEach((customer, idx) => {
                    const percentage = processedTotal > 0 ? ((customer.value / processedTotal) * 100).toFixed(1) : 0;
                    html += `
                        <tr style="border-bottom: 1px solid #E5E7EB; ${idx % 2 === 0 ? 'background: #F9FAFB;' : ''}">
                            <td style="padding: 0.75rem; font-size: 0.875rem; color: #6B7280;">${idx + 1}</td>
                            <td style="padding: 0.75rem; font-size: 0.875rem; color: #111827; font-weight: 500;">${customer.name}</td>
                            <td style="padding: 0.75rem; text-align: right; font-size: 0.875rem; color: #3B82F6; font-weight: 600;">${customer.value.toFixed(1)}</td>
                            <td style="padding: 0.75rem; text-align: right; font-size: 0.875rem; color: #6B7280;">${percentage}%</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            
            html += `
                </div>
            `;
            
            // 顯示彈窗
            const modal = document.getElementById('customerDetailModal');
            if (!modal) {
                const newModal = document.createElement('div');
                newModal.id = 'customerDetailModal';
                newModal.style.cssText = 'display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;';
                newModal.onclick = function(e) { if (e.target === this) closeCustomerDetailModal(); };
                document.body.appendChild(newModal);
            }
            
            document.getElementById('customerDetailModal').innerHTML = html;
            document.getElementById('customerDetailModal').style.display = 'flex';
        }

        // 顯示Open PO客戶明細
        function showOpenPODetail(region, index) {
            // UI permission gate: only allow viewing detail for your own region (or ADMIN).
            if (!requireRegionAccess(region)) {
                return;
            }
            if (!window.rawData || !window.rawData.openpo) {
                alert('Open PO 數據尚未載入');
                return;
            }
            
            if (!window.janData) {
                alert('Jan 數據尚未處理');
                return;
            }
            
            // 使用 janData 中的處理後數值（與長條圖一致）
            const processedTotal = window.janData.openPO[index];
            
            console.log('Open PO 原始數據樣本:', window.rawData.openpo[0]);
            console.log(`${region} Open PO 處理後總額 (長條圖顯示):`, processedTotal, 'K');
            
            // 過濾該區域一月份的Open PO數據
            const januaryData = window.rawData.openpo.filter(item => {
                const r = _normRegion(item.Region || item['REGION']);
                const target = _normRegion(region);
                const m = item.Month ?? item['MONTH'] ?? item['月份'];
                return r === target && _isMonth(m, 0);
            });
            
            console.log(`${region} 一月份 Open PO 數據:`, januaryData.length, '筆');
            
            // 按客戶名稱分組並計算總額
            const customerMap = new Map();
            januaryData.forEach(item => {
                const customer = item['客戶名稱'] || item['Customer Name'] || '未知客戶';
                const value = parseFloat(item.Value) || parseFloat(item['Value']) || 0;
                console.log('處理客戶:', customer, 'Value:', value);
                if (customerMap.has(customer)) {
                    customerMap.set(customer, customerMap.get(customer) + value);
                } else {
                    customerMap.set(customer, value);
                }
            });
            
            console.log('客戶統計:', Array.from(customerMap.entries()));
            
            // 轉換為數組並排序（轉換為千元）
            const customers = Array.from(customerMap.entries())
                .map(([name, value]) => ({ name, value: value / 1000 }))
                .sort((a, b) => b.value - a.value);
            
            const rawTotal = customers.reduce((sum, c) => sum + c.value, 0);
            
            // 計算縮放係數，使客戶明細加總等於 processedTotal
            const scaleFactor = rawTotal > 0 ? processedTotal / rawTotal : 1;
            console.log(`Open PO 縮放係數: ${scaleFactor.toFixed(3)} (${processedTotal}K / ${rawTotal.toFixed(1)}K)`);
            
            // 將每個客戶的金額按比例縮放
            const scaledCustomers = customers.map(c => ({
                name: c.name,
                originalValue: c.value,
                value: c.value * scaleFactor
            }));
            
            // 生成彈窗內容
            let html = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 800px; max-height: 80vh; overflow-y: auto; position: relative;">
                    <button onclick="closeCustomerDetailModal()" style="position: absolute; top: 1rem; right: 1rem; background: #EF4444; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.25rem; display: flex; align-items: center; justify-content: center;">×</button>
                    
                    <h3 style="margin: 0 0 0.5rem 0; color: #10B981; font-size: 1.5rem;">${region} 區域 - Open PO 客戶明細</h3>
                    <p style="margin: 0 0 1.5rem 0; color: #6B7280;">一月份開放訂單客戶列表（扣除+分攤後）</p>
                    
                    <div style="background: #D1FAE5; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #10B981;">
                        <div style="font-size: 0.875rem; color: #059669; margin-bottom: 0.25rem;">Total Open PO</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: #059669;">${Math.round(processedTotal).toLocaleString()}K</div>
                        <div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.25rem;">
                            ${scaledCustomers.length > 0 
                                ? `${scaledCustomers.length} 個客戶`
                                : '無原始客戶數據明細'}
                        </div>
                    </div>
            `;
            
            if (scaledCustomers.length === 0) {
                // 沒有客戶明細時顯示說明
                html += `
                    <div style="padding: 2rem; text-align: center; color: #6B7280; background: #F9FAFB; border-radius: 8px;">
                        <svg style="width: 48px; height: 48px; margin: 0 auto 1rem; color: #9CA3AF;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #374151;">該區域無原始客戶數據明細</p>
                        <p style="margin: 0; font-size: 0.875rem;">顯示的 Total (${Math.round(processedTotal).toLocaleString()}K) 為扣除+分攤後的計算值</p>
                    </div>
                `;
            } else {
                // 有客戶明細時顯示表格
                html += `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #F3F4F6;">
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; font-weight: 600; color: #374151; border-bottom: 2px solid #E5E7EB;">#</th>
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; font-weight: 600; color: #374151; border-bottom: 2px solid #E5E7EB;">客戶名稱</th>
                                <th style="padding: 0.75rem; text-align: right; font-size: 0.875rem; font-weight: 600; color: #374151; border-bottom: 2px solid #E5E7EB;">Open PO (K)</th>
                                <th style="padding: 0.75rem; text-align: right; font-size: 0.875rem; font-weight: 600; color: #374151; border-bottom: 2px solid #E5E7EB;">佔比</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                scaledCustomers.forEach((customer, idx) => {
                    const percentage = processedTotal > 0 ? ((customer.value / processedTotal) * 100).toFixed(1) : 0;
                    html += `
                        <tr style="border-bottom: 1px solid #E5E7EB; ${idx % 2 === 0 ? 'background: #F9FAFB;' : ''}">
                            <td style="padding: 0.75rem; font-size: 0.875rem; color: #6B7280;">${idx + 1}</td>
                            <td style="padding: 0.75rem; font-size: 0.875rem; color: #111827; font-weight: 500;">${customer.name}</td>
                            <td style="padding: 0.75rem; text-align: right; font-size: 0.875rem; color: #10B981; font-weight: 600;">${customer.value >= 100 ? Math.round(customer.value).toLocaleString() : customer.value.toFixed(1)}</td>
                            <td style="padding: 0.75rem; text-align: right; font-size: 0.875rem; color: #6B7280;">${percentage}%</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            
            html += `
                </div>
            `;
            
            // 顯示彈窗
            const modal = document.getElementById('customerDetailModal');
            if (!modal) {
                const newModal = document.createElement('div');
                newModal.id = 'customerDetailModal';
                newModal.style.cssText = 'display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;';
                newModal.onclick = function(e) { if (e.target === this) closeCustomerDetailModal(); };
                document.body.appendChild(newModal);
            }
            
            document.getElementById('customerDetailModal').innerHTML = html;
            document.getElementById('customerDetailModal').style.display = 'flex';
        }

        // 關閉客戶明細彈窗
        function closeCustomerDetailModal() {
            const modal = document.getElementById('customerDetailModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function displayDetailedPerformance(data, actualData) {
            if (!data) {
                console.log('No data for detailed performance');
                return;
            }
            
            let regions = ['VU', 'DEJ', 'VJP', 'TW', 'ANZ', 'EU'];
            regions = constrainRegions(regions);
            const regionNames = { VU: 'VU', DEJ: 'DEJ', VJP: 'VJP', TW: 'TW', ANZ: 'ANZ', EU: 'EU', MN: 'CloudSight' };
            
            // 計算顏色類別
            const getAchRateClass = (rate) => {
                if (rate >= 0.9) return '';
                if (rate >= 0.8) return 'style="background-color: #fef08a;"'; // 黃色
                return 'style="background-color: #fecaca;"'; // 紅色
            };
            
            const formatRate = (rate) => {
                if (rate === 0 || !isFinite(rate)) return '#DIV/0!';
                return Math.round(rate * 100) + '%';
            };
            
            const formatNumber = (num) => {
                if (num === 0) return '0';
                if (!num && num !== 0) return '-';
                return num.toLocaleString('en-US');
            };
            
            let html = '<thead>';
            // 第一行標題
            html += '<tr style="font-weight: bold;">';
            html += '<th rowspan="2" style="vertical-align: middle; min-width: 80px; border: 2px solid #9CA3AF; text-align: center; background-color: #1E40AF; color: white;">Region</th>';
            html += '<th rowspan="2" style="vertical-align: middle; min-width: 90px; border: 2px solid #9CA3AF; text-align: center; background-color: #1E40AF; color: white;">Item</th>';
            html += '<th colspan="3" style="text-align: center; border: 2px solid #9CA3AF; background-color: #1E40AF; color: white;">January</th>';
            html += '<th colspan="6" style="text-align: center; border: 2px solid #9CA3AF; background-color: #1E40AF; color: white;">6R</th>';
            html += '<th colspan="3" style="text-align: center; border: 2px solid #9CA3AF; background-color: #1E40AF; color: white;">2026 6R Est. A/R（6R/Budget）</th>';
            html += '</tr>';
            
            // 第二行標題
            html += '<tr style="font-weight: bold;">';
            html += '<th style="border: 2px solid #9CA3AF; text-align: center; background-color: #1E40AF; color: white;">MTD</th>';
            html += '<th style="border: 2px solid #9CA3AF; text-align: center; background-color: #1E40AF; color: white;">Budget</th>';
            html += '<th style="border: 2px solid #9CA3AF; text-align: center; background-color: #1E40AF; color: white;">Ach.Rate</th>';
            html += '<th style="border: 2px solid #9CA3AF; text-align: center; background-color: #1E40AF; color: white;">Jan.</th>';
            html += '<th style="border: 2px solid #9CA3AF; text-align: center; background-color: #1E40AF; color: white;">Feb</th>';
            html += '<th style="border: 2px solid #9CA3AF; text-align: center; background-color: #1E40AF; color: white;">Mar</th>';
            html += '<th style="border: 2px solid #9CA3AF; text-align: center; background-color: #1E40AF; color: white;">Apr</th>';
            html += '<th style="border: 2px solid #9CA3AF; text-align: center; background-color: #1E40AF; color: white;">May</th>';
            html += '<th style="border: 2px solid #9CA3AF; text-align: center; background-color: #1E40AF; color: white;">Jun</th>';
            html += '<th style="border: 2px solid #9CA3AF; text-align: center; background-color: #1E40AF; color: white;">6R</th>';
            html += '<th style="border: 2px solid #9CA3AF; text-align: center; background-color: #1E40AF; color: white;">Budget</th>';
            html += '<th style="border: 2px solid #9CA3AF; text-align: center; background-color: #1E40AF; color: white;">Est. A/R（6R/Budget）</th>';
            html += '</tr>';
            html += '</thead><tbody>';
            
            let vortexData = { 
                hw: 0, sub: 0, total: 0, budget: 0, rolling6R: 0, budget6R: 0,
                rollingMonths: [0, 0, 0, 0, 0, 0]  // 追蹤 Jan-Jun 每個月的 rolling
            };
            
            regions.forEach(region => {
                // 取得 Jan Actual（數據已經是千元）
                const actualJan = actualData && actualData[region] ? {
                    hw: Math.round(actualData[region][0].hardware),
                    lic: Math.round(actualData[region][0].license)
                } : { hw: 0, lic: 0 };
                actualJan.total = actualJan.hw + actualJan.lic;
                
                // 取得 Budget
                const budgetJan = data[region][0].budget;
                const budgetHW = Math.round(budgetJan * 0.75);
                const budgetSub = Math.round(budgetJan * 0.25);
                
                // 計算達成率
                const achRateHW = budgetHW > 0 ? actualJan.hw / budgetHW : 0;
                const achRateSub = budgetSub > 0 ? actualJan.lic / budgetSub : 0;
                const achRateTotal = budgetJan > 0 ? actualJan.total / budgetJan : 0;
                
                // 計算 6R (Jan-Jun Rolling)
                let rolling6R = 0;
                for (let i = 0; i < 6; i++) {
                    rolling6R += Math.round(data[region][i].rolling / 1000);
                }
                
                // 計算 6R Budget (Jan-Jun)
                let budget6R = 0;
                for (let i = 0; i < 6; i++) {
                    budget6R += data[region][i].budget;
                }
                
                // 6R Est. A/R（6R/Budget）
                const est6R = budget6R > 0 ? rolling6R / budget6R : 0;
                
                // 1A+6R
                const total1A6R = actualJan.total + rolling6R;
                const est1A6R = budget6R > 0 ? total1A6R / budget6R : 0;
                
                // HW 行
                html += '<tr>';
                html += `<td rowspan="3" style="vertical-align: middle; border: 1px solid #d1d5db;"><strong>${regionNames[region]}</strong></td>`;
                html += '<td style="border: 1px solid #d1d5db; text-align: center !important;">HW</td>';
                // January: MTD, Budget, Ach.Rate
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(actualJan.hw)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(budgetHW)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatRate(achRateHW)}</td>`;
                
                // 6R Rolling Forecast (Jan-Jun) - HW = Total × 75%
                for (let i = 0; i < 6; i++) {
                    const rollingTotal = Math.round(data[region][i].rolling / 1000);
                    const rollingHW = Math.round(rollingTotal * 0.75);
                    html += `<td style="border: 1px solid #d1d5db;">${formatNumber(rollingHW)}</td>`;
                }
                
                // 2026 6R Est. A/R（6R/Budget）
                const rolling6R_HW = Math.round(rolling6R * 0.75);
                const budget6R_HW = Math.round(budget6R * 0.75);
                const est6R_HW = budget6R_HW > 0 ? rolling6R_HW / budget6R_HW : 0;
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(rolling6R_HW)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(budget6R_HW)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatRate(est6R_HW)}</td>`;
                html += '</tr>';
                
                // Subscription 行
                html += '<tr>';
                html += '<td style="border: 1px solid #d1d5db; text-align: center !important;">Subscription</td>';
                // January: MTD, Budget, Ach.Rate
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(actualJan.lic)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(budgetSub)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatRate(achRateSub)}</td>`;
                
                // 6R Rolling Forecast (Jan-Jun) - Subscription = Total × 25%
                for (let i = 0; i < 6; i++) {
                    const rollingTotal = Math.round(data[region][i].rolling / 1000);
                    const rollingSub = Math.round(rollingTotal * 0.25);
                    html += `<td style="border: 1px solid #d1d5db;">${formatNumber(rollingSub)}</td>`;
                }
                
                // 2026 6R Est. A/R（6R/Budget）
                const rolling6R_Sub = Math.round(rolling6R * 0.25);
                const budget6R_Sub = Math.round(budget6R * 0.25);
                const est6R_Sub = budget6R_Sub > 0 ? rolling6R_Sub / budget6R_Sub : 0;
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(rolling6R_Sub)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(budget6R_Sub)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatRate(est6R_Sub)}</td>`;
                html += '</tr>';
                
                // Total 行
                html += '<tr style="border-bottom: 2px solid #d1d5db;">';
                html += '<td style="border: 1px solid #d1d5db; text-align: center !important;"><strong>Total</strong></td>';
                // January: MTD, Budget, Ach.Rate
                html += `<td style="border: 1px solid #d1d5db;"><strong>${formatNumber(actualJan.total)}</strong></td>`;
                html += `<td style="border: 1px solid #d1d5db;"><strong>${formatNumber(budgetJan)}</strong></td>`;
                html += `<td style="border: 1px solid #d1d5db;"><strong>${formatRate(achRateTotal)}</strong></td>`;
                
                // 6R Rolling Forecast (Jan-Jun) - Total 顯示實際數字
                for (let i = 0; i < 6; i++) {
                    const rollingTotal = Math.round(data[region][i].rolling / 1000);
                    html += `<td style="border: 1px solid #d1d5db;"><strong>${formatNumber(rollingTotal)}</strong></td>`;
                }
                
                // 2026 6R Est. A/R（6R/Budget）
                html += `<td style="border: 1px solid #d1d5db;"><strong>${formatNumber(rolling6R)}</strong></td>`;
                html += `<td style="border: 1px solid #d1d5db;"><strong>${formatNumber(budget6R)}</strong></td>`;
                html += `<td style="border: 1px solid #d1d5db;"><strong>${formatRate(est6R)}</strong></td>`;
                html += '</tr>';
                
                vortexData.hw += actualJan.hw;
                vortexData.sub += actualJan.lic;
                vortexData.total += actualJan.total;
                vortexData.budget += budgetJan;
                vortexData.rolling6R += rolling6R;
                vortexData.budget6R += budget6R;
                
                // 累加每個月的 rolling
                for (let i = 0; i < 6; i++) {
                    vortexData.rollingMonths[i] += Math.round(data[region][i].rolling / 1000);
                }
            });
            
            // VORTEX TTL
            const vortexBudgetHW = Math.round(vortexData.budget * 0.75);
            const vortexBudgetSub = Math.round(vortexData.budget * 0.25);
            const vortexAchRateHW = vortexBudgetHW > 0 ? vortexData.hw / vortexBudgetHW : 0;
            const vortexAchRateSub = vortexBudgetSub > 0 ? vortexData.sub / vortexBudgetSub : 0;
            const vortexAchRateTotal = vortexData.budget > 0 ? vortexData.total / vortexData.budget : 0;
            const vortexEst6R = vortexData.budget6R > 0 ? vortexData.rolling6R / vortexData.budget6R : 0;
            const vortexRolling6R_HW = Math.round(vortexData.rolling6R * 0.75);
            const vortexBudget6R_HW = Math.round(vortexData.budget6R * 0.75);
            const vortexEst6R_HW = vortexBudget6R_HW > 0 ? vortexRolling6R_HW / vortexBudget6R_HW : 0;
            const vortexRolling6R_Sub = Math.round(vortexData.rolling6R * 0.25);
            const vortexBudget6R_Sub = Math.round(vortexData.budget6R * 0.25);
            const vortexEst6R_Sub = vortexBudget6R_Sub > 0 ? vortexRolling6R_Sub / vortexBudget6R_Sub : 0;
            
            html += '<tr style="font-weight: 600;">';
            html += '<td rowspan="3" style="vertical-align: middle; border: 1px solid #d1d5db;"><strong>VORTEX TTL</strong></td>';
            html += '<td style="border: 1px solid #d1d5db; text-align: center !important;">HW</td>';
            // January: MTD, Budget, Ach.Rate
            html += `<td style="border: 1px solid #d1d5db;">${formatNumber(vortexData.hw)}</td>`;
            html += `<td style="border: 1px solid #d1d5db;">${formatNumber(vortexBudgetHW)}</td>`;
            html += `<td style="border: 1px solid #d1d5db;">${formatRate(vortexAchRateHW)}</td>`;
            // 6R Rolling Forecast - HW = Total × 75%
            vortexData.rollingMonths.forEach(rolling => {
                const rollingHW = Math.round(rolling * 0.75);
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(rollingHW)}</td>`;
            });
            // 2026 6R Est. A/R（6R/Budget）
            html += `<td style="border: 1px solid #d1d5db;">${formatNumber(vortexRolling6R_HW)}</td>`;
            html += `<td style="border: 1px solid #d1d5db;">${formatNumber(vortexBudget6R_HW)}</td>`;
            html += `<td style="border: 1px solid #d1d5db;">${formatRate(vortexEst6R_HW)}</td>`;
            html += '</tr>';
            
            html += '<tr style="font-weight: 600;">';
            html += '<td style="border: 1px solid #d1d5db; text-align: center !important;">Subscription</td>';
            // January: MTD, Budget, Ach.Rate
            html += `<td style="border: 1px solid #d1d5db;">${formatNumber(vortexData.sub)}</td>`;
            html += `<td style="border: 1px solid #d1d5db;">${formatNumber(vortexBudgetSub)}</td>`;
            html += `<td style="border: 1px solid #d1d5db;">${formatRate(vortexAchRateSub)}</td>`;
            // 6R Rolling Forecast - Subscription = Total × 25%
            vortexData.rollingMonths.forEach(rolling => {
                const rollingSub = Math.round(rolling * 0.25);
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(rollingSub)}</td>`;
            });
            // 2026 6R Est. A/R（6R/Budget）
            html += `<td style="border: 1px solid #d1d5db;">${formatNumber(vortexRolling6R_Sub)}</td>`;
            html += `<td style="border: 1px solid #d1d5db;">${formatNumber(vortexBudget6R_Sub)}</td>`;
            html += `<td style="border: 1px solid #d1d5db;">${formatRate(vortexEst6R_Sub)}</td>`;
            html += '</tr>';
            
            html += '<tr style="font-weight: 600; border-bottom: 3px solid #9ca3af;">';
            html += '<td style="border: 1px solid #d1d5db; text-align: center !important;"><strong>Total</strong></td>';
            // January: MTD, Budget, Ach.Rate
            html += `<td style="border: 1px solid #d1d5db;"><strong>${formatNumber(vortexData.total)}</strong></td>`;
            html += `<td style="border: 1px solid #d1d5db;"><strong>${formatNumber(vortexData.budget)}</strong></td>`;
            html += `<td style="border: 1px solid #d1d5db;"><strong>${formatRate(vortexAchRateTotal)}</strong></td>`;
            // 6R Rolling Forecast - Total 顯示實際數字
            vortexData.rollingMonths.forEach(rolling => {
                html += `<td style="border: 1px solid #d1d5db;"><strong>${formatNumber(rolling)}</strong></td>`;
            });
            // 2026 6R Est. A/R（6R/Budget）
            html += `<td style="border: 1px solid #d1d5db;"><strong>${formatNumber(vortexData.rolling6R)}</strong></td>`;
            html += `<td style="border: 1px solid #d1d5db;"><strong>${formatNumber(vortexData.budget6R)}</strong></td>`;
            html += `<td style="border: 1px solid #d1d5db;"><strong>${formatRate(vortexEst6R)}</strong></td>`;
            html += '</tr>';
            
            // CloudSight (MN) - 如果有資料的話
            if (actualData && actualData['MN'] && data['MN']) {
                const mnActualJan = {
                    hw: Math.round(actualData['MN'][0].hardware),
                    lic: Math.round(actualData['MN'][0].license)
                };
                mnActualJan.total = mnActualJan.hw + mnActualJan.lic;
                
                const mnBudgetJan = data['MN'][0].budget;
                const mnBudgetHW = Math.round(mnBudgetJan * 0.75);
                const mnBudgetSub = Math.round(mnBudgetJan * 0.25);
                
                const mnAchRateHW = mnBudgetHW > 0 ? mnActualJan.hw / mnBudgetHW : 0;
                const mnAchRateSub = mnBudgetSub > 0 ? mnActualJan.lic / mnBudgetSub : 0;
                const mnAchRateTotal = mnBudgetJan > 0 ? mnActualJan.total / mnBudgetJan : 0;
                
                let mnRolling6R = 0;
                let mnBudget6R = 0;
                const mnRollingMonths = [];
                for (let i = 0; i < 6; i++) {
                    const monthlyRolling = Math.round(data['MN'][i].rolling / 1000);
                    mnRollingMonths.push(monthlyRolling);
                    mnRolling6R += monthlyRolling;
                    mnBudget6R += data['MN'][i].budget;
                }
                
                const mnEst6R = mnBudget6R > 0 ? mnRolling6R / mnBudget6R : 0;
                const mnRolling6R_HW = Math.round(mnRolling6R * 0.75);
                const mnBudget6R_HW = Math.round(mnBudget6R * 0.75);
                const mnEst6R_HW = mnBudget6R_HW > 0 ? mnRolling6R_HW / mnBudget6R_HW : 0;
                const mnRolling6R_Sub = Math.round(mnRolling6R * 0.25);
                const mnBudget6R_Sub = Math.round(mnBudget6R * 0.25);
                const mnEst6R_Sub = mnBudget6R_Sub > 0 ? mnRolling6R_Sub / mnBudget6R_Sub : 0;
                
                html += '<tr>';
                html += '<td rowspan="3" style="vertical-align: middle; border: 1px solid #d1d5db;"><strong>CloudSight</strong></td>';
                html += '<td style="border: 1px solid #d1d5db; text-align: center !important;">HW</td>';
                // January: MTD, Budget, Ach.Rate
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(mnActualJan.hw)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(mnBudgetHW)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatRate(mnAchRateHW)}</td>`;
                // 6R Rolling Forecast - HW = Total × 75%
                mnRollingMonths.forEach(rolling => {
                    const rollingHW = Math.round(rolling * 0.75);
                    html += `<td style="border: 1px solid #d1d5db;">${formatNumber(rollingHW)}</td>`;
                });
                // 2026 6R Est. A/R（6R/Budget）
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(mnRolling6R_HW)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(mnBudget6R_HW)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatRate(mnEst6R_HW)}</td>`;
                html += '</tr>';
                
                html += '<tr>';
                html += '<td style="border: 1px solid #d1d5db; text-align: center !important;">Subscription</td>';
                // January: MTD, Budget, Ach.Rate
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(mnActualJan.lic)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(mnBudgetSub)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatRate(mnAchRateSub)}</td>`;
                // 6R Rolling Forecast - Subscription = Total × 25%
                mnRollingMonths.forEach(rolling => {
                    const rollingSub = Math.round(rolling * 0.25);
                    html += `<td style="border: 1px solid #d1d5db;">${formatNumber(rollingSub)}</td>`;
                });
                // 2026 6R Est. A/R（6R/Budget）
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(mnRolling6R_Sub)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(mnBudget6R_Sub)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatRate(mnEst6R_Sub)}</td>`;
                html += '</tr>';
                
                html += '<tr style="border-bottom: 2px solid #d1d5db;">';
                html += '<td style="border: 1px solid #d1d5db; text-align: center !important;"><strong>Total</strong></td>';
                // January: MTD, Budget, Ach.Rate
                html += `<td style="border: 1px solid #d1d5db;"><strong>${formatNumber(mnActualJan.total)}</strong></td>`;
                html += `<td style="border: 1px solid #d1d5db;"><strong>${formatNumber(mnBudgetJan)}</strong></td>`;
                html += `<td style="border: 1px solid #d1d5db;"><strong>${formatRate(mnAchRateTotal)}</strong></td>`;
                // 6R Rolling Forecast - Total 顯示實際數字
                mnRollingMonths.forEach(rolling => {
                    html += `<td style="border: 1px solid #d1d5db;"><strong>${formatNumber(rolling)}</strong></td>`;
                });
                // 2026 6R Est. A/R（6R/Budget）
                html += `<td style="border: 1px solid #d1d5db;"><strong>${formatNumber(mnRolling6R)}</strong></td>`;
                html += `<td style="border: 1px solid #d1d5db;"><strong>${formatNumber(mnBudget6R)}</strong></td>`;
                html += `<td style="border: 1px solid #d1d5db;"><strong>${formatRate(mnEst6R)}</strong></td>`;
                html += '</tr>';
                
                // SSSBD TTL = VORTEX TTL + CloudSight
                const sssbdHW = vortexData.hw + mnActualJan.hw;
                const sssbdSub = vortexData.sub + mnActualJan.lic;
                const sssbdTotal = vortexData.total + mnActualJan.total;
                const sssbdBudget = vortexData.budget + mnBudgetJan;
                const sssbdBudgetHW = vortexBudgetHW + mnBudgetHW;
                const sssbdBudgetSub = vortexBudgetSub + mnBudgetSub;
                const sssbdRolling6R = vortexData.rolling6R + mnRolling6R;
                const sssbdBudget6R = vortexData.budget6R + mnBudget6R;
                
                const sssbdAchRateHW = sssbdBudgetHW > 0 ? sssbdHW / sssbdBudgetHW : 0;
                const sssbdAchRateSub = sssbdBudgetSub > 0 ? sssbdSub / sssbdBudgetSub : 0;
                const sssbdAchRateTotal = sssbdBudget > 0 ? sssbdTotal / sssbdBudget : 0;
                const sssbdEst6R = sssbdBudget6R > 0 ? sssbdRolling6R / sssbdBudget6R : 0;
                
                // 計算每個月的 rolling (VORTEX + CloudSight)
                const sssbdRollingMonths = [];
                for (let i = 0; i < 6; i++) {
                    sssbdRollingMonths.push(vortexData.rollingMonths[i] + mnRollingMonths[i]);
                }
                
                const sssbdRolling6R_HW = vortexRolling6R_HW + mnRolling6R_HW;
                const sssbdBudget6R_HW = vortexBudget6R_HW + mnBudget6R_HW;
                const sssbdEst6R_HW = sssbdBudget6R_HW > 0 ? sssbdRolling6R_HW / sssbdBudget6R_HW : 0;
                const sssbdRolling6R_Sub = vortexRolling6R_Sub + mnRolling6R_Sub;
                const sssbdBudget6R_Sub = vortexBudget6R_Sub + mnBudget6R_Sub;
                const sssbdEst6R_Sub = sssbdBudget6R_Sub > 0 ? sssbdRolling6R_Sub / sssbdBudget6R_Sub : 0;
                
                html += '<tr style="font-weight: 700;">';
                html += '<td rowspan="3" style="vertical-align: middle; border: 1px solid #d1d5db;"><strong>SSSBD TTL</strong></td>';
                html += '<td style="border: 1px solid #d1d5db; text-align: center !important;">HW</td>';
                // January: MTD, Budget, Ach.Rate
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(sssbdHW)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(sssbdBudgetHW)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatRate(sssbdAchRateHW)}</td>`;
                // 6R Rolling Forecast - HW = Total × 75%
                sssbdRollingMonths.forEach(rolling => {
                    const rollingHW = Math.round(rolling * 0.75);
                    html += `<td style="border: 1px solid #d1d5db;">${formatNumber(rollingHW)}</td>`;
                });
                // 2026 6R Est. A/R（6R/Budget）
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(sssbdRolling6R_HW)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(sssbdBudget6R_HW)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatRate(sssbdEst6R_HW)}</td>`;
                html += '</tr>';
                
                html += '<tr style="font-weight: 700;">';
                html += '<td style="border: 1px solid #d1d5db; text-align: center !important;">Subscription</td>';
                // January: MTD, Budget, Ach.Rate
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(sssbdSub)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(sssbdBudgetSub)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatRate(sssbdAchRateSub)}</td>`;
                // 6R Rolling Forecast - Subscription = Total × 25%
                sssbdRollingMonths.forEach(rolling => {
                    const rollingSub = Math.round(rolling * 0.25);
                    html += `<td style="border: 1px solid #d1d5db;">${formatNumber(rollingSub)}</td>`;
                });
                // 2026 6R Est. A/R（6R/Budget）
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(sssbdRolling6R_Sub)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatNumber(sssbdBudget6R_Sub)}</td>`;
                html += `<td style="border: 1px solid #d1d5db;">${formatRate(sssbdEst6R_Sub)}</td>`;
                html += '</tr>';
                
                html += '<tr style="font-weight: 700;">';
                html += '<td style="border: 1px solid #d1d5db; text-align: center !important;"><strong>Total</strong></td>';
                // January: MTD, Budget, Ach.Rate
                html += `<td style="border: 1px solid #d1d5db;"><strong>${formatNumber(sssbdTotal)}</strong></td>`;
                html += `<td style="border: 1px solid #d1d5db;"><strong>${formatNumber(sssbdBudget)}</strong></td>`;
                html += `<td style="border: 1px solid #d1d5db;"><strong>${formatRate(sssbdAchRateTotal)}</strong></td>`;
                // 6R Rolling Forecast - Total 顯示實際數字
                sssbdRollingMonths.forEach(rolling => {
                    html += `<td style="border: 1px solid #d1d5db;"><strong>${formatNumber(rolling)}</strong></td>`;
                });
                // 2026 6R Est. A/R（6R/Budget）
                html += `<td style="border: 1px solid #d1d5db;"><strong>${formatNumber(sssbdRolling6R)}</strong></td>`;
                html += `<td style="border: 1px solid #d1d5db;"><strong>${formatNumber(sssbdBudget6R)}</strong></td>`;
                html += `<td style="border: 1px solid #d1d5db;"><strong>${formatRate(sssbdEst6R)}</strong></td>`;
                html += '</tr>';
            }
            
            html += '</tbody>';
            document.getElementById('detailedPerformanceTable').innerHTML = html;
        }

        function displayMaterial2025(data) {
            if (!data) {
                console.log('No Material 2025 data to display');
                return;
            }
            
            console.log('Displaying Material 2025 data:', data);
            
            const regionOrder = ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'];
            
            // 合併 material2025 和 rollingDemand 的區域
            const allRegions = new Set();
            regionOrder.forEach(r => {
                if (data[r] || (rollingDemandData && rollingDemandData[r])) {
                    allRegions.add(r);
                }
            });
            let regions = regionOrder.filter(r => allRegions.has(r));
            regions = constrainRegions(regions);
            
            // 添加下載按鈕（只在非物料報告模式下顯示）
            let html = '';
            if (!window.IS_MATERIAL_REPORT) {
                html += `
                <div style="margin-bottom: 1rem; text-align: right;">
                    <button onclick="downloadMaterial2025()" class="btn-apply" style="background: #1E40AF;">
                        📥 下載物料明細 Excel
                    </button>
                </div>
                `;
            }
            
            html += `
                <div class="table-wrapper">
                    <table class="single-table material-summary-table">
                        <thead>
                            <tr>
                                <th style="width: 12%; background-color: #1E40AF; color: white;">區域</th>
                                <th style="width: 15%; background-color: #1E40AF; color: white;">物料數量</th>
                                <th style="width: 15%; background-color: #1E40AF; color: white;">總出貨量</th>
                                <th style="width: 58%; background-color: #1E40AF; color: white;">熱門物料 TOP 3</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            regions.forEach(region => {
                // 合併 material2025 和 rollingDemand 的物料
                const materials = data[region] || [];
                const allMaterialsMap = new Map();
                
                // 先添加 material2025 的物料
                materials.forEach(item => {
                    allMaterialsMap.set(item.material, {
                        material: item.material,
                        model: item.model,
                        billingQty: item.billingQty,
                        eol: item.eol,
                        slowMoving: item.slowMoving,
                        sales2025: item.sales2025,
                        openPO: item.openPO,
                        openPO2026: item.openPO2026,
                        eolPlan: item.eolPlan
                    });
                });
                
                // 再添加 rollingDemand 中有但 material2025 沒有的物料
                if (rollingDemandData && rollingDemandData[region]) {
                    Object.keys(rollingDemandData[region]).forEach(material => {
                        if (!allMaterialsMap.has(material)) {
                            // 從 materialReferenceData 獲取 model 和其他資訊
                            let model = '-';
                            let eol = null;
                            let eolPlan = '-';
                            
                            if (materialReferenceData && materialReferenceData[material]) {
                                const ref = materialReferenceData[material];
                                model = ref.model || '-';
                                eol = ref.eol;
                                eolPlan = ref.eolPlan || '-';
                            }
                            
                            allMaterialsMap.set(material, {
                                material: material,
                                model: model,
                                billingQty: 0,
                                eol: eol,
                                slowMoving: null,
                                sales2025: 0,
                                openPO: 0,
                                openPO2026: 0,
                                eolPlan: eolPlan
                            });
                        }
                    });
                }
                
                // 轉回陣列
                const allMaterials = Array.from(allMaterialsMap.values());
                const totalQty = allMaterials.reduce((sum, item) => sum + item.billingQty, 0);
                
                // 排序並取前3
                const topMaterials = [...allMaterials]
                    .filter(m => m.billingQty > 0) // 只統計有出貨量的
                    .sort((a, b) => b.billingQty - a.billingQty)
                    .slice(0, 3);
                
                const topMaterialsText = topMaterials.length > 0
                    ? topMaterials.map(m => `${m.material} (${m.billingQty.toLocaleString()})`).join(', ')
                    : '-';
                
                html += `
                    <tr class="material-region-row" onclick="toggleMaterialDetail('${region}')" style="cursor: pointer;">
                        <td><strong style="color: #1E40AF;">▶ ${region}</strong></td>
                        <td>${allMaterials.length} 個</td>
                        <td><strong>${totalQty.toLocaleString()}</strong></td>
                        <td style="text-align: left; font-size: 0.9em;">${topMaterialsText}</td>
                    </tr>
                    <tr id="material-detail-${region}" class="material-detail-row" style="display: none;">
                        <td colspan="4" style="padding: 0;">
                            <div class="material-detail-content" style="padding: 1rem; background: #f9fafb;">
                                <table class="single-table" style="margin: 0; font-size: 0.9em;">
                                    <thead>
                                        <tr>
                                            <th style="width: 10%; background-color: #1E40AF; color: white;">P/N</th>
                                            <th style="width: 15%; background-color: #1E40AF; color: white;">Model Name</th>
                                            <th style="width: 10%; background-color: #1E40AF; color: white;">Product Status</th>
                                            <th style="width: 12%; background-color: #1E40AF; color: white;">EOL Plan (Yes/No)</th>
                                            <th style="width: 10%; background-color: #1E40AF; color: white;">Material Status</th>
                                            <th colspan="4" style="width: 20%; background-color: #1E40AF; color: white;">Rolling Demand History</th>
                                            <th style="width: 8%; background-color: #1E40AF; color: white;">Total Q'ty (Last 12 Months)</th>
                                            <th style="width: 8%; background-color: #1E40AF; color: white;">Open PO</th>
                                            <th style="width: 7%; background-color: #1E40AF; color: white;">Profit Center</th>
                                        </tr>
                                        <tr>
                                            <th colspan="5" style="background-color: #1E40AF;"></th>
                                            <th style="width: 5%; background-color: #1E40AF; color: white;">Sep.</th>
                                            <th style="width: 5%; background-color: #1E40AF; color: white;">Oct.</th>
                                            <th style="width: 5%; background-color: #1E40AF; color: white;">Nov.</th>
                                            <th style="width: 5%; background-color: #1E40AF; color: white;">Dec.</th>
                                            <th style="background-color: #1E40AF;"></th>
                                            <th style="background-color: #1E40AF;"></th>
                                            <th style="background-color: #1E40AF;"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                // 按物料編號排序（使用合併後的所有物料）
                const sortedMaterials = [...allMaterials].sort((a, b) => a.material.localeCompare(b.material));
                
                sortedMaterials.forEach(item => {
                    // 檢查是否為 Slow moving 系列
                    const slowMovingSeries = ['FD639', 'IB639', 'CC830', 'CC831', 'FE912'];
                    const modelName = item.model || '';
                    const isSlowMoving = slowMovingSeries.some(series => modelName.includes(series));
                    
                    // 合併 Status 顯示
                    let statusClass, statusText;
                    if (item.eol === 'V') {
                        // EOL 狀態 - 只有字體顏色
                        statusClass = 'style="color: #dc2626; font-weight: 600;"';
                        statusText = 'EOL';
                    } else if (isSlowMoving) {
                        // Slow moving 狀態 - 只有字體顏色
                        statusClass = 'style="color: #d97706; font-weight: 600;"';
                        statusText = 'Slow moving';
                    } else {
                        // Active 狀態 - 只有字體顏色
                        statusClass = 'style="color: #059669; font-weight: 600;"';
                        statusText = 'Active';
                    }
                    
                    // 獲取 Rolling Demand 數據
                    let sep = '-', oct = '-', nov = '-', dec = '-';
                    if (rollingDemandData && rollingDemandData[region] && rollingDemandData[region][item.material]) {
                        const demand = rollingDemandData[region][item.material];
                        sep = demand.sep > 0 ? Math.round(demand.sep).toLocaleString() : '-';
                        oct = demand.oct > 0 ? Math.round(demand.oct).toLocaleString() : '-';
                        nov = demand.nov > 0 ? Math.round(demand.nov).toLocaleString() : '-';
                        dec = demand.dec > 0 ? Math.round(demand.dec).toLocaleString() : '-';
                    }
                    // DEJ: Rolling Demand History Sep/Oct/Nov/Dec 強制清空顯示 '-'
                    if (region === 'DEJ') {
                        sep = '-'; oct = '-'; nov = '-'; dec = '-';
                    }

                    
                    html += `
                        <tr>
                            <td><code>${item.material}</code></td>
                            <td style="text-align: left; font-size: 0.85em;">${item.model || '-'}</td>
                            <td ${statusClass}>${statusText}</td>
                            <td style="text-align: left; font-size: 0.8em;">${item.eolPlan || '-'}</td>
                            <td style="color: #6b7280; font-size: 0.85em;">SD Card LT 26 weeks</td>
                            <td style="text-align: center;">${sep}</td>
                            <td style="text-align: center;">${oct}</td>
                            <td style="text-align: center;">${nov}</td>
                            <td style="text-align: center;">${dec}</td>
                            <td><strong>${item.billingQty.toLocaleString()}</strong></td>
                            <td style="font-weight: 500;">${item.openPO2026 || 0}</td>
                            <td style="color: #4f46e5; font-weight: 500;">VORTEX</td>
                        </tr>
                    `;
                });
                
                html += `
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <style>
                .material-region-row:hover {
                    background-color: #f0fdf4 !important;
                }
                .material-region-row td:first-child strong {
                    transition: all 0.3s;
                }
                .material-region-row:hover td:first-child strong {
                    color: #047857 !important;
                }
                .material-detail-row td {
                    border-top: none !important;
                }
                .material-detail-content table {
                    box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
                }
                code {
                    background: #e5e7eb;
                    padding: 2px 6px;
                    border-radius: 3px;
                    font-family: 'Courier New', monospace;
                    font-size: 0.9em;
                }
                </style>
            `;
            
            const targetElement = document.getElementById('material2025Content');
            if (targetElement) {
                targetElement.innerHTML = html;
                console.log('✓ 物料表格已渲染到 material2025Content');
            } else {
                console.error('❌ 找不到 material2025Content 元素');
                // 嘗試創建容器元素
                const material2025Section = document.getElementById('material2025');
                if (material2025Section) {
                    const contentDiv = document.createElement('div');
                    contentDiv.id = 'material2025Content';
                    contentDiv.className = 'table-section';
                    contentDiv.innerHTML = html;
                    material2025Section.appendChild(contentDiv);
                    console.log('✓ 已創建並渲染 material2025Content');
                } else {
                    console.error('❌ 連 material2025 區域都找不到');
                }
            }
        }
        
        function downloadMaterial2025() {
            if (!material2025Data) {
                alert('沒有物料明細資料可以下載');
                return;
            }
            
            // 準備 Excel 資料
            const exportData = [];
            const regionOrder = ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'];
            
            regionOrder.forEach(region => {
                if (material2025Data[region]) {
                    const materials = [...material2025Data[region]].sort((a, b) => a.material.localeCompare(b.material));
                    materials.forEach(item => {
                        exportData.push({
                            '區域': region,
                            '物料編號': item.material,
                            '型號': item.model || '',
                            '物料說明': item.materialDesc || '',
                            '出貨數量': item.billingQty,
                            '2025銷售量': item.sales2025 || 0,
                            'Open PO': item.openPO || 0,
                            'EOL': item.eol || '',
                            'Slow Moving': item.slowMoving || '',
                            'EOL計劃': item.eolPlan || ''
                        });
                    });
                }
            });
            
            // 使用 SheetJS 生成 Excel
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '物料明細');
            
            // 下載檔案
            const fileName = `物料明細_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            console.log('物料明細已下載:', fileName);
        }
        
        function toggleMaterialDetail(region) {
            // UI permission gate: only allow expanding SKU details for your own region (or ADMIN).
            if (!requireRegionAccess(region)) {
                return;
            }
            const detailRow = document.getElementById(`material-detail-${region}`);
            const isVisible = detailRow.style.display !== 'none';
            
            // 取得該區域行的箭頭元素
            const regionRow = detailRow.previousElementSibling;
            const arrow = regionRow.querySelector('strong');
            
            if (isVisible) {
                // 摺疊
                detailRow.style.display = 'none';
                arrow.textContent = arrow.textContent.replace('▼', '▶');
            } else {
                // 展開
                detailRow.style.display = 'table-row';
                arrow.textContent = arrow.textContent.replace('▶', '▼');
            }
        }

        function addCellClickEvents() {
            console.log('addCellClickEvents called');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Budget 表格 - 不添加點擊事件（沒有明細）
            console.log('Budget table: no click events (no details available)');

            // Rolling 表格
            const rollingTable = document.getElementById('rollingTable');
            if (rollingTable) {
                console.log('Found rollingTable');
                const rows = rollingTable.querySelectorAll('tbody tr:not(.single-total-row)');
                console.log('Rolling rows:', rows.length);
                rows.forEach((row, rowIndex) => {
                    const cells = row.querySelectorAll('td.heatmap-cell');
                    const region = row.querySelector('td:first-child').textContent.trim();
                    console.log(`Rolling row ${rowIndex}, region: ${region}, cells: ${cells.length}`);
                    cells.forEach((cell, cellIndex) => {
                        if (cellIndex < 12) {
                            cell.style.cursor = 'pointer';
                            cell.title = `點擊查看${months[cellIndex]}月明細`;
                            cell.onclick = () => {
                                console.log('Rolling cell clicked:', region, months[cellIndex]);
                                showCellDetail('rolling', region, months[cellIndex], cellIndex);
                            };
                        }
                    });
                });
            } else {
                console.log('rollingTable not found');
            }

            // Open PO 表格
            const openpoTable = document.getElementById('openpoTable');
            if (openpoTable) {
                console.log('Found openpoTable');
                const rows = openpoTable.querySelectorAll('tbody tr:not(.single-total-row)');
                console.log('OpenPO rows:', rows.length);
                rows.forEach((row, rowIndex) => {
                    const cells = row.querySelectorAll('td.heatmap-cell');
                    const region = row.querySelector('td:first-child').textContent.trim();
                    console.log(`OpenPO row ${rowIndex}, region: ${region}, cells: ${cells.length}`);
                    cells.forEach((cell, cellIndex) => {
                        if (cellIndex < 12) {
                            cell.style.cursor = 'pointer';
                            cell.title = `點擊查看${months[cellIndex]}月明細`;
                            cell.onclick = () => {
                                console.log('OpenPO cell clicked:', region, months[cellIndex]);
                                showCellDetail('openpo', region, months[cellIndex], cellIndex);
                            };
                        }
                    });
                });
            } else {
                console.log('openpoTable not found');
            }
        }

        function updateKPICards() {
            let regions = ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'];
            regions = constrainRegions(regions);
            
            // 計算總計
            let budgetTotal = 0, rollingTotal = 0, openpoTotal = 0, actualHWTotal = 0, actualLicTotal = 0;
            const regionTotals = {};
            
            regions.forEach(region => {
                // 檢查該區域是否有數據
                if (!processedData[region]) {
                    return; // 跳過沒有數據的區域
                }
                
                const budgetSum = processedData[region].reduce((sum, m) => sum + m.budget, 0);
                const rollingSum = processedData[region].reduce((sum, m) => sum + m.rolling, 0);
                const openpoSum = (region === 'DEJ') ? 0 : processedData[region].reduce((sum, m) => sum + (m.openpo || 0), 0);
                const actualHWSum = processedData[region].reduce((sum, m) => sum + (m.actualHW || 0), 0);
                const actualLicSum = processedData[region].reduce((sum, m) => sum + (m.actualLicense || 0), 0);
                
                budgetTotal += budgetSum;
                rollingTotal += rollingSum;
                openpoTotal += openpoSum;
                actualHWTotal += actualHWSum;
                actualLicTotal += actualLicSum;
                
                regionTotals[region] = budgetSum;
            });

            // 轉換千位數
            rollingTotal = Math.round(rollingTotal / 1000);
            openpoTotal = Math.round(openpoTotal / 1000);
            actualHWTotal = Math.round(actualHWTotal);
            actualLicTotal = Math.round(actualLicTotal);
            // 6R Est. A/R（6R/Budget） (Jan-Jun) = Rolling(USD,K) / Budget(USD,K)
            let rolling6RCompany = 0;
            let budget6RCompany = 0;
            regions.forEach(region => {
                if (!processedData[region]) return;
                for (let i = 0; i < 6; i++) {
                    const m = processedData[region][i];
                    budget6RCompany += (m.budget || 0);
                    rolling6RCompany += (m.rolling || 0);
                }
            });
            const rolling6RCompanyK = Math.round(rolling6RCompany / 1000);
            const estARCompany = budget6RCompany > 0 ? (rolling6RCompanyK / budget6RCompany) : 0;
            const estARText = (!estARCompany || !isFinite(estARCompany)) ? '#DIV/0!' : (Math.round(estARCompany * 100) + '%');


            // 更新KPI卡片
            document.getElementById('kpiBudget').textContent = budgetTotal.toLocaleString() + 'K';
            document.getElementById('kpiRolling').textContent = rollingTotal.toLocaleString() + 'K';
            const rollingTrendEl = document.getElementById('kpiRollingTrend');
            if (rollingTrendEl) {
                rollingTrendEl.textContent = `Forecast Total (點擊查看表格) | 6R Est. A/R（6R/Budget）: ${estARText}`;
            }
            document.getElementById('kpiOpenPO').textContent = openpoTotal.toLocaleString() + 'K';
            document.getElementById('kpiActualHW').textContent = actualHWTotal.toLocaleString() + 'K';
            document.getElementById('kpiActualLic').textContent = actualLicTotal.toLocaleString() + 'K';
        }

        function switchDashboardTab(tab) {
            const overviewBtn = document.getElementById('tabBtnOverview');
            const kpiBtn = document.getElementById('tabBtnKpiTarget');
            const overviewPane = document.getElementById('dashboardOverview');
            const kpiPane = document.getElementById('dashboardKpiTarget');

            if (!overviewBtn || !kpiBtn || !overviewPane || !kpiPane) return;

            const isKpi = tab === 'kpiTarget';

            overviewBtn.classList.toggle('active', !isKpi);
            kpiBtn.classList.toggle('active', isKpi);
            overviewBtn.setAttribute('aria-selected', String(!isKpi));
            kpiBtn.setAttribute('aria-selected', String(isKpi));

            overviewPane.classList.toggle('active', !isKpi);
            kpiPane.classList.toggle('active', isKpi);

            if (isKpi) {
                renderKpiTargetTabMulti();
            }
        }

        
        // Render KPI Target for multiple regions inside the KPI Target tab
        function renderKpiTargetTabMulti() {
            let regions = ['VU','ANZ','DEJ','TW','EU','VJP'];
            regions = constrainRegions(regions);
            const container = document.getElementById('kpiTargetContainer');
            if (!container) return;

            // Build the region sections first (cards + empty tables), then populate values.
            let html = '';
            regions.forEach((r) => {
                if (!processedData || !processedData[r]) return;
                const key = String(r).toLowerCase();
                html += `
                  <section class="kpi-target-region" style="margin-top: 1.5rem;">
                    <div class="dashboard-header" style="margin-top: 0; padding: 0;">
                      <h2 style="margin: 0; font-size: 1.15rem;">${r} KPI Target</h2>
                    </div>
                    <div class=\"kpi-target-top\">
                      <div class=\"bullet-wrap\">
                        <div class=\"bullet-title\">
                          <h3>Budget Achievement (Jan–Jun)</h3>
                          <div class=\"meta\">Click a bar for details</div>
                        </div>
                        <div class=\"kpi-bullets\" id=\"${key}Bullets\"></div>
                      </div>
                      <div>
                        <div class=\"kpi-target-grid\">
                      <div class="kpi-target-card">
                        <div style="font-size: 0.85rem; color: #6B7280; font-weight: 700;">${r} Annual Budget</div>
                        <div id="${key}BudgetTotal" style="font-size: 1.75rem; font-weight: 800; margin-top: 0.35rem;">-</div>
                      </div>
                      <div class="kpi-target-card">
                        <div style="font-size: 0.85rem; color: #6B7280; font-weight: 700;">${r} Actual (HW+License)</div>
                        <div id="${key}ActualTotal" style="font-size: 1.75rem; font-weight: 800; margin-top: 0.35rem;">-</div>
                      </div>
                      <div class="kpi-target-card">
                        <div style="font-size: 0.85rem; color: #6B7280; font-weight: 700;">${r} Rolling Forecast (Jan-Jun)</div>
                        <div id="${key}Rolling6RTotal" style="font-size: 1.75rem; font-weight: 800; margin-top: 0.35rem;">-</div>
                        <div id="${key}EstAR6R" style="margin-top: 0.35rem; color: #6B7280; font-weight: 700; font-size: 0.9rem;">Est. A/R（6R/Budget）: -</div>
                      </div>
                      <div class="kpi-target-card">
                        <div style="font-size: 0.85rem; color: #6B7280; font-weight: 700;">${r} Open PO (Annual)</div>
                        <div id="${key}OpenPOTotal" style="font-size: 1.75rem; font-weight: 800; margin-top: 0.35rem;">-</div>
                      </div>
                      </div>
                    </div>
                    <div class=\"table-section\" style="margin-top: 1.0rem;">
                      <div class="table-wrapper" style="overflow-x: auto;">
                        <table class="single-table" id="${key}KpiTargetTable"></table>
                      </div>
                    </div>
                  </section>
                `;
            });

            container.innerHTML = html || '<div style="color:#6B7280; font-size:0.9rem;">目前沒有可顯示的區域資料。</div>';

            // Populate values per region
            regions.forEach((r) => {
                if (!processedData || !processedData[r]) return;
                renderRegionKpiTargetTab(r);
            });
        }


        
        
        /* ==================== KPI Target - Multi-Region Visual KPI Board (2026) ==================== */
        // Leadership-friendly KPI boards per region, switched via sub-tabs inside KPI Target.
        // No vertical page scroll requirement: content is compact + two-column layout.
        //
        // Optional actual overlay (per region):
        // window.rawData.kpiTargetActual = {
        //   VU: { revenue_usd_k:{Q1:0,Q2:0,Q3:0,Q4:0}, recruit_new_si:{Jan:0,...}, inactive_top_si:{Q1:0,...}, active_si:{Jan:0,...}, avg_rev_per_si_k:{Jan:0,...}, pos_data_collection:{Jan:true,...} },
        //   ANZ: { ... }
        // };

        function _normRegion(x){ return String(x||'').trim().toUpperCase(); }
        const _KPI_REGIONS = ['VU','ANZ','DEJ','TW','EU','VJP'];
        const _MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

        function _kpiActual(region, key){
            const a = (window.rawData && window.rawData.kpiTargetActual) ? window.rawData.kpiTargetActual : null;
            if(!a) return null;
            const r = a[_normRegion(region)] || a[region] || null;
            if(!r) return null;
            return r[key] || null;
        }
        function _scorePill(pct){
            const cls = pct>=100 ? 'good' : (pct>=70 ? 'warn' : 'bad');
            return `<span class="score-pill ${cls}">${Math.max(0, Math.min(999, Math.round(pct)))}%</span>`;
        }
        function _miniBarsOverlay(targetVals, actualVals, opts){
            const tMax = Math.max(...targetVals.map(v=>Number(v)||0), 1);
            const aMax = actualVals ? Math.max(...actualVals.map(v=>Number(v)||0), 1) : 1;
            const maxV = Math.max(tMax, aMax, 1);

            const showLabelEvery = (opts && opts.showLabelEvery) ? opts.showLabelEvery : 3;
            const unitSuffix = (opts && opts.unitSuffix) ? opts.unitSuffix : '';
            const tLabel = (opts && opts.targetLabel) ? opts.targetLabel : 'Target';
            const aLabel = (opts && opts.actualLabel) ? opts.actualLabel : 'Actual';

            return `
              <div class="mini-legend">
                <span class="dot target"></span>${tLabel}
                ${actualVals ? `<span class="dot actual"></span>${aLabel}` : ''}
              </div>
              <div class="mini-bars overlay">
                ${targetVals.map((t,i)=>{
                    const tt = Number(t)||0;
                    const aa = actualVals ? (Number(actualVals[i])||0) : null;
                    const th = Math.max(6, Math.round((tt/maxV)*100));
                    const ah = (aa===null) ? 0 : Math.max(6, Math.round((aa/maxV)*100));
                    const label = ((i % showLabelEvery)===0 || i===targetVals.length-1) ? (tt + unitSuffix) : '';
                    return `
                      <div class="mini-bar-wrap">
                        <div class="mini-bar target" style="height:${th}%;"></div>
                        ${aa===null ? '' : `<div class="mini-bar actual" style="height:${ah}%;"></div>`}
                        <div class="mini-label">${label}</div>
                      </div>
                    `;
                }).join('')}
              </div>
            `;
        }
        function _ensureKpiMiniStyles(){
            if(document.getElementById('kpi-mini-style')) return;
            const s = document.createElement('style');
            s.id = 'kpi-mini-style';
            s.textContent = `
              .kpi-subtabs{ display:flex; gap:8px; flex-wrap:wrap; margin:.75rem 0 .5rem; }
              .kpi-subtab{ padding:8px 12px; border-radius:12px; background: rgba(15,23,42,.04); border:1px solid rgba(15,23,42,.08); cursor:pointer; font-weight:600; font-size:.85rem; color:#111827; }
              .kpi-subtab.active{ background: rgba(59,130,246,.10); border-color: rgba(59,130,246,.25); }
              .mini-bars{ display:grid; grid-template-columns: repeat(12, 1fr); gap:6px; height: 84px; align-items:end; margin-top:.45rem;}
              .mini-bars.overlay .mini-bar-wrap{ position:relative; }
              .mini-bar-wrap{ display:flex; flex-direction:column; align-items:center; justify-content:flex-end; gap:6px; height:100%; }
              .mini-bar{ width: 100%; border-radius: 8px; background: rgba(99,102,241,.25); }
              .mini-bars.overlay .mini-bar.target{ background: rgba(99,102,241,.18); }
              .mini-bars.overlay .mini-bar.actual{ background: rgba(16,185,129,.35); position:absolute; bottom: 16px; left: 15%; width: 70%; border-radius: 8px; }
              .mini-label{ font-size: .70rem; color:#6B7280; line-height:1; height: 14px; }
              .mini-legend{ display:flex; align-items:center; gap:10px; font-size:.76rem; color:#6B7280; margin-top:.35rem;}
              .mini-legend .dot{ width:8px; height:8px; border-radius: 999px; display:inline-block; }
              .mini-legend .dot.target{ background: rgba(99,102,241,.45); }
              .mini-legend .dot.actual{ background: rgba(16,185,129,.55); }

              /* Compact the KPI target page to avoid "must scroll" feeling */
              #kpiTargetContainer .kpi-target-top{ margin-top:.75rem; gap:12px; }
              #kpiTargetContainer .kpi-scorecard{ padding: 14px; }
              #kpiTargetContainer .detail-table th, #kpiTargetContainer .detail-table td{ padding: 8px 10px; }
            `;
            document.head.appendChild(s);
        }

        // Targets extracted from the region KPI sheets (Action row intentionally ignored)
        function _kpiTargets(region){
            const R = _normRegion(region);

            if(R==='VU'){
                return {
                    title: '2026 VU KPI Target',
                    revenue: {Q1:346, Q2:457, Q3:558, Q4:639, goal:2000},
                    recruitNewSiMonthly: [10,10,10,10,10,10,15,15,15,15,15,15], // total 150
                    inactiveTopSi: {Q1:3,Q2:3,Q3:3,Q4:3, thresholdText:'<3', posText:'POS > 10K'},
                    activeSiMonthly: [3,3,3,5,5,5,8,8,8,12,12,12], // >20K
                    activeSiDefinition: '> $20K revenue',
                    avgRevPerSiMonthlyK: [7,7,7,8,8,9,9,10,10,11,11,12],
                    avgRevNote: 'Average Revenue per SI (USD K)'
                };
            }

            if(R==='ANZ'){
                return {
                    title: '2026 ANZ KPI Target',
                    revenue: {Q1:120, Q2:170, Q3:180, Q4:130, goal:600},
                    recruitNewSiMonthly: [2,2,2,2,2,2,3,3,3,3,3,3], // total 30
                    inactiveTopSi: {Q1:2,Q2:2,Q3:2,Q4:2, thresholdText:'<2', posText:'POS > 5K', // threshold
                                    // target appears in Jul and Oct; we display as quarterly KPI with <2 across the year.
                                   },
                    // 20 active SI (>5K revenue) ramp
                    activeSiMonthly: [3,3,5,8,8,10,13,13,15,18,18,20],
                    activeSiDefinition: '> $5K revenue',
                    // POS data collection: "V" indicated at Jan; we show as milestone card
                    posDataCollection: {Jan:true},
                    avgRevPerSiMonthlyK: null,
                    avgRevNote: null
                };
            }

            

            if(R==='DEJ'){
                return {
                    title: '2026 DEJ KPI Target',
                    revenue: {Q1:120, Q2:200, Q3:320, Q4:370, goal:1000},

                    // Market expansion – New disty recruitment *1 (target occurs in Jul)
                    activeSiMonthly: [0,0,0,0,0,0,1,0,0,0,0,0],
                    activeSiDefinition: 'New disty recruitment (Count)',
                    activeLabel: 'New disty recruitment',

                    // Market expansion – New SI Recruitment *2 (targets in Jun and Dec)
                    recruitNewSiMonthly: [0,0,0,0,0,1,0,0,0,0,0,1],
                    recruitLabel: 'New SI Recruitment',

                    // Additional objectives (milestones / initiatives)
                    objectives: [
                        { type:'initiative', title:'Large Project (大型專案)', targetText:'2026 目標 100K', months:{Mar:'RFQ×1', May:'RFQ×1', Jul:'RFQ×1', Sep:'RFQ×1', Oct:'100K'} },
                        { type:'milestone', title:'Ricoh enable', targetText:'月機制 (Monthly mechanism)', months:{Mar:'月機制', Apr:'V'} }
                    ],

                    // Inactive KPI not specified in the DEJ sheet image; keep hidden by setting null.
                    inactiveTopSi: null,

                    avgRevPerSiMonthlyK: null,
                    avgRevNote: null
                };
            }



            if(R==='VJP'){
                return {
                    title: '2026 VJP KPI Target',
                    revenue: {Q1:168, Q2:215, Q3:204, Q4:212, goal:800},

                    // Initiative / milestone style targets (V marks)
                    recruitNewSiMonthly: [0,0,0,0,0,0,0,0,0,0,0,0],
                    recruitLabel: 'Key Initiatives',

                    activeSiMonthly: [0,0,0,0,0,0,0,0,0,0,0,0],
                    activeSiDefinition: '',
                    activeLabel: 'Milestone Calendar',

                    objectives: [
                        { type:'milestone', title:'Create TA list & complete proposal (DX-A/IBS-J/System K)', targetText:'Complete in Jan', months:{Jan:'V'} },
                        { type:'milestone', title:'Sales Training (every Q)', targetText:'Quarterly cadence', months:{Jan:'V', Apr:'V', Jul:'V', Oct:'V'} },
                        { type:'milestone', title:'Campaign for VORTEX (TKB) / Partner tool (VJP)', targetText:'Create tool for partner to present to targeted customer', months:{Feb:'V'} }
                    ],

                    inactiveTopSi: null,
                    avgRevPerSiMonthlyK: null,
                    avgRevNote: null
                };
            }



            if(R==='EU'){
                return {
                    title: '2026 EU KPI Target',
                    revenue: {Q1:85, Q2:115, Q3:215, Q4:385, goal:800},

                    // Market expansion – New SI Recruitment *10
                    recruitNewSiMonthly: [0,0,2,0,0,3,0,0,2,0,0,3],
                    recruitLabel: 'New SI Recruitment',

                    // Market expansion – New acquired customers *4
                    activeSiMonthly: [0,0,0,0,0,2,0,0,1,0,0,1],
                    activeSiDefinition: 'New acquired customers (Count)',
                    activeLabel: 'New acquired customers',

                    // Inactive KPI not specified in EU sheet
                    inactiveTopSi: null,

                    avgRevPerSiMonthlyK: null,
                    avgRevNote: null
                };
            }



            if(R==='TW'){
                return {
                    title: '2026 TW KPI Target',
                    revenue: {Q1:80, Q2:95, Q3:135, Q4:140, goal:450},

                    // Market expansion – New SI recruitment *4 (1 each quarter)
                    recruitNewSiMonthly: [1,0,0,1,0,0,1,0,0,1,0,0],
                    recruitLabel: 'New SI recruitment',

                    // Market expansion – New acquired customers *5 (Q4=2)
                    activeSiMonthly: [1,0,0,1,0,0,1,0,0,2,0,0],
                    activeSiDefinition: 'New acquired customers (Count)',
                    activeLabel: 'New acquired customers',

                    inactiveTopSi: null,
                    avgRevPerSiMonthlyK: null,
                    avgRevNote: null
                };
            }

// Defaults for other regions (placeholders until you provide their sheets)
            return {
                title: `2026 ${R} KPI Target`,
                revenue: {Q1:0,Q2:0,Q3:0,Q4:0, goal:0},
                recruitNewSiMonthly: [0,0,0,0,0,0,0,0,0,0,0,0],
                inactiveTopSi: {Q1:0,Q2:0,Q3:0,Q4:0, thresholdText:'-', posText:'-'},
                activeSiMonthly: [0,0,0,0,0,0,0,0,0,0,0,0],
                activeSiDefinition: '',
                avgRevPerSiMonthlyK: null,
                avgRevNote: null
            };
        }

        function _renderRegionKpiBoard(region){
            _ensureKpiMiniStyles();
            const t = _kpiTargets(region);

            const revTargetTotal = (t.revenue.Q1||0)+(t.revenue.Q2||0)+(t.revenue.Q3||0)+(t.revenue.Q4||0);
            const revActual = _kpiActual(region,'revenue_usd_k');
            const revAchievedTotal = revActual ? (Number(revActual.Q1||0)+Number(revActual.Q2||0)+Number(revActual.Q3||0)+Number(revActual.Q4||0)) : 0;
            const revPct = revTargetTotal>0 ? (revAchievedTotal/revTargetTotal*100) : 0;

            const recruitTargetTotal = (t.recruitNewSiMonthly||[]).reduce((a,b)=>a+(Number(b)||0),0);
            const recruitActual = _kpiActual(region,'recruit_new_si');
            const recruitAchievedTotal = recruitActual ? _MONTHS.reduce((s,m)=>s+(Number(recruitActual[m])||0),0) : 0;
            const recruitPct = recruitTargetTotal>0 ? (recruitAchievedTotal/recruitTargetTotal*100) : 0;

            const inactiveActual = _kpiActual(region,'inactive_top_si');
            const inactiveOK = (inactiveActual && (
                (Number(inactiveActual.Q1||0) < (t.inactiveTopSi.Q1||0)) &&
                (Number(inactiveActual.Q2||0) < (t.inactiveTopSi.Q2||0)) &&
                (Number(inactiveActual.Q3||0) < (t.inactiveTopSi.Q3||0)) &&
                (Number(inactiveActual.Q4||0) < (t.inactiveTopSi.Q4||0))
            ));

            const activeActual = _kpiActual(region,'active_si');
            const avgActual = _kpiActual(region,'avg_rev_per_si_k');

            // region-specific compact layout
            const avgBlock = t.avgRevPerSiMonthlyK ? `
                <div class="kpi-scorecard">
                  <h3 style="display:flex; align-items:center; justify-content:space-between; gap:.75rem;">
                    <span>${t.avgRevNote || 'Average Revenue per SI'}</span>
                    <span class="score-pill warn">Target Ramp</span>
                  </h3>
                  <div style="color:#6B7280; font-size:.85rem; margin-top:-.15rem;">月度目標（USD K）</div>
                  <div class="kpi-chip" style="margin-top:.65rem;">
                    <div class="label">Monthly Target (USD K)</div>
                    ${_miniBarsOverlay(
                      t.avgRevPerSiMonthlyK,
                      avgActual ? _MONTHS.map(m=>Number(avgActual[m])||0) : null,
                      {showLabelEvery: 3, unitSuffix:'K', targetLabel:'Target', actualLabel:'Actual'}
                    )}
                  </div>
                </div>
            ` : '';

            const posCollectionBlock = (t.posDataCollection && t.posDataCollection.Jan) ? `
                <div class="kpi-scorecard">
                  <h3 style="display:flex; align-items:center; justify-content:space-between; gap:.75rem;">
                    <span>POS Data Collection</span>
                    <span class="score-pill good">Milestone</span>
                  </h3>
                  <div style="color:#6B7280; font-size:.85rem; margin-top:-.15rem;">2026 目標：完成 POS data collection（表上標記 V）</div>
                  <div class="kpi-chip" style="margin-top:.65rem;">
                    <div class="label">Status</div>
                    <div class="value">V</div>
                    <div class="sub">Target marked in Jan</div>
                  </div>
                </div>
            ` : '';

            return `
              <section class="kpi-target-region" style="margin-top:.85rem;">
                <div class="dashboard-header" style="margin-top: 0; padding: 0;">
                  <h2 style="margin: 0; font-size: 1.18rem;">${t.title}</h2>
                  <p style="margin-top: .3rem; color:#6B7280; font-size:.82rem;">
                    KPI Target 已改為「主管版」視覺化：只看目標與進度（Action 不顯示）；月度趨勢以迷你圖呈現。
                  </p>
                </div>

                <div class=\"kpi-metric-groups\">
                  <div class=\"kpi-metric-group revenue\">
                    <div class=\"group-header\">
                      <div>
                        <div class=\"group-title\">Revenue</div>
                        <div class=\"group-sub\">USD K · Target vs Progress</div>
                      </div>
                      ${_scorePill(revPct)}
                    </div>
                    <div class=\"group-grid\">
                      <div class=\"kpi-chip\">
                        <div class=\"label\">Revenue Target</div>
                        <div class=\"value\">${revTargetTotal || '-'}</div>
                        <div class=\"sub\">Goal: ${t.revenue.goal || '-'}K</div>
                      </div>
                      <div class=\"kpi-chip\">
                        <div class=\"label\">Revenue Progress</div>
                        <div class=\"value\">${revActual ? revAchievedTotal : '-'}</div>
                        <div class=\"sub\">${revActual ? 'Actual' : '等待 Actual 匯入'} · ${_scorePill(revPct)}</div>
                      </div>
                    </div>
                  </div>

                  <div class=\"kpi-metric-group newsi\">
                    <div class=\"group-header\">
                      <div>
                        <div class=\"group-title\">New SI</div>
                        <div class=\"group-sub\">Count · Recruit vs Progress</div>
                      </div>
                      ${_scorePill(recruitPct)}
                    </div>
                    <div class=\"group-grid\">
                      <div class=\"kpi-chip\">
                        <div class=\"label\">Recruit Target</div>
                        <div class=\"value\">${recruitTargetTotal || '-'}</div>
                        <div class=\"sub\">全年目標（Count）</div>
                      </div>
                      <div class=\"kpi-chip\">
                        <div class=\"label\">Progress</div>
                        <div class=\"value\">${recruitActual ? recruitAchievedTotal : '-'}</div>
                        <div class=\"sub\">${recruitActual ? 'Achieved' : '等待 Actual 匯入'} · ${_scorePill(recruitPct)}</div>
                      </div>
                    </div>
                  </div>
                </div>


                <div class="kpi-target-top" style="grid-template-columns: 1fr 1fr;">
                  <div class="kpi-scorecard">
                    <h3 style="display:flex; align-items:center; justify-content:space-between; gap:.75rem;">
                      <span>Revenue Generation</span>
                      ${_scorePill(revPct)}
                    </h3>
                    <div style="color:#6B7280; font-size:.85rem; margin-top:-.15rem;">
                      Budget by quarter (USD K)
                    </div>
                    <div class="detail-table-wrap" style="margin-top:.6rem;">
                      <table class="detail-table">
                        <thead><tr><th>Q</th><th>Target</th><th>Actual</th><th>Gap</th></tr></thead>
                        <tbody>
                          ${['Q1','Q2','Q3','Q4'].map(q=>{
                              const tt = Number(t.revenue[q]||0);
                              const aa = revActual ? Number(revActual[q]||0) : null;
                              const gg = (aa===null) ? null : Math.max(0, tt-aa);
                              return `<tr><td><b>${q}</b></td><td>${tt||'-'}</td><td>${aa===null?'-':aa}</td><td>${gg===null?'-':gg}</td></tr>`;
                          }).join('')}
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div class="kpi-scorecard">
                    <h3 style="display:flex; align-items:center; justify-content:space-between; gap:.75rem;">
                      <span>${t.recruitLabel || 'Recruit New SI'}</span>
                      ${_scorePill(recruitPct)}
                    </h3>
                    <div style="color:#6B7280; font-size:.85rem; margin-top:-.15rem;">
                      Monthly targets (Count) · 不拆季顯示
                    </div>
                    <div class="kpi-chip" style="margin-top:.65rem;">
                      <div class="label">Monthly Target (Count)</div>
                      ${_miniBarsOverlay(
                        t.recruitNewSiMonthly,
                        recruitActual ? _MONTHS.map(m=>Number(recruitActual[m])||0) : null,
                        {showLabelEvery: 2, unitSuffix:'', targetLabel:'Target', actualLabel:'Actual'}
                      )}
                    </div>
                  </div>

                  <div class="kpi-scorecard">
                    <h3 style="display:flex; align-items:center; justify-content:space-between; gap:.75rem;">
                      <span>${t.activeLabel || (t.activeSiDefinition ? `Active SI (${t.activeSiDefinition})` : 'Active SI')}</span>
                      <span class="score-pill warn">Target Ramp</span>
                    </h3>
                    <div style="color:#6B7280; font-size:.85rem; margin-top:-.15rem;">月末應達成 active SI 數（Count）</div>
                    <div class="kpi-chip" style="margin-top:.65rem;">
                      <div class="label">Monthly Target (Count)</div>
                      ${_miniBarsOverlay(
                        t.activeSiMonthly,
                        activeActual ? _MONTHS.map(m=>Number(activeActual[m])||0) : null,
                        {showLabelEvery: 3, unitSuffix:'', targetLabel:'Target', actualLabel:'Actual'}
                      )}
                    </div>
                  </div>

                  
                  ${avgBlock || posCollectionBlock || (t.objectives ? `
                    ${t.objectives.map(obj=>{
                        if(obj.type==='milestone'){
                            const entries = Object.entries(obj.months||{});
                            const timeline = entries.map(([k,v])=>`${k}: <b>${v}</b>`).join(' · ');
                            return `
                              <div class="kpi-scorecard">
                                <h3 style="display:flex; align-items:center; justify-content:space-between; gap:.75rem;">
                                  <span>${obj.title}</span>
                                  <span class="score-pill good">Milestone</span>
                                </h3>
                                <div style="color:#6B7280; font-size:.85rem; margin-top:-.15rem;">${obj.targetText || ''}</div>
                                <div class="kpi-chip" style="margin-top:.65rem;">
                                  <div class="label">Timeline</div>
                                  <div class="sub" style="margin-top:.35rem;">${timeline}</div>
                                </div>
                              </div>
                            `;
                        }
                        // initiative / events
                        const labels = _MONTHS.map(m=>obj.months && obj.months[m] ? obj.months[m] : '');
                        // For initiatives we show as step-style bars using a simple encoding: non-empty => 1, empty => 0
                        const tvals = labels.map(x=>x?1:0);
                        return `
                          <div class="kpi-scorecard">
                            <h3 style="display:flex; align-items:center; justify-content:space-between; gap:.75rem;">
                              <span>${obj.title}</span>
                              <span class="score-pill warn">Initiative</span>
                            </h3>
                            <div style="color:#6B7280; font-size:.85rem; margin-top:-.15rem;">${obj.targetText || ''}</div>
                            <div class="kpi-chip" style="margin-top:.65rem;">
                              <div class="label">Milestones by Month</div>
                              <div class="mini-bars overlay">
                                ${tvals.map((t,i)=>{
                                    const th = t ? 85 : 12;
                                    const lab = labels[i] ? labels[i] : '';
                                    const show = lab ? `<div class="mini-label">${lab}</div>` : `<div class="mini-label"></div>`;
                                    return `
                                      <div class="mini-bar-wrap">
                                        <div class="mini-bar target" style="height:${th}%;"></div>
                                        ${show}
                                      </div>
                                    `;
                                }).join('')}
                              </div>
                              <div class="sub" style="margin-top:.35rem; color:#6B7280; font-size:.78rem;">
                                ${_MONTHS.map((m,i)=>labels[i] ? `${m}：${labels[i]}` : '').filter(Boolean).join(' · ')}
                              </div>
                            </div>
                          </div>
                        `;
                    }).join('')}
                  ` : `
                  <div class="kpi-scorecard">
                    <h3 style="display:flex; align-items:center; justify-content:space-between; gap:.75rem;">
                      <span>Additional Objective</span>
                      <span class="score-pill warn">Pending</span>
                    </h3>
                    <div style="color:#6B7280; font-size:.85rem; margin-top:-.15rem;">
                      (此區會依各區 KPI 表內容補齊)
                    </div>
                    <div class="kpi-chip" style="margin-top:.65rem;">
                      <div class="label">Note</div>
                      <div class="sub">請提供 ${_normRegion(region)} KPI 表，或我可依你貼圖逐一填入。</div>
                    </div>
                  </div>
                  `)}


                  
                  ${t.inactiveTopSi ? `
                  <div class="kpi-scorecard" style="grid-column: 1 / -1;">
                    <h3 style="display:flex; align-items:center; justify-content:space-between; gap:.75rem;">
                      <span>Top SI Inactive Rate (${t.inactiveTopSi.posText})</span>
                      <span class="score-pill ${inactiveOK ? 'good' : 'warn'}">${inactiveActual ? (inactiveOK ? 'OK' : 'At Risk') : 'Target'}</span>
                    </h3>
                    <div style="color:#6B7280; font-size:.85rem; margin-top:-.15rem;">
                      Definition：連續 3 個月無採購活動視為 Inactive。目標：各季 Inactive SI 數量 ${t.inactiveTopSi.thresholdText || '-'}。
                    </div>
                    <div class="detail-table-wrap" style="margin-top:.6rem;">
                      <table class="detail-table">
                        <thead><tr><th>Q</th><th>Target</th><th>Actual</th><th>Status</th></tr></thead>
                        <tbody>
                          ${['Q1','Q2','Q3','Q4'].map(q=>{
                              const targetTxt = t.inactiveTopSi.thresholdText || '-';
                              const aa = inactiveActual ? Number(inactiveActual[q]||0) : null;
                              const ok = (aa===null) ? null : (aa < Number(t.inactiveTopSi[q]||0));
                              const status = ok===null ? '-' : (ok ? 'OK' : 'At Risk');
                              return `<tr><td><b>${q}</b></td><td>${targetTxt}</td><td>${aa===null?'-':aa}</td><td>${status}</td></tr>`;
                          }).join('')}
                        </tbody>
                      </table>
                    </div>
                  </div>
                  ` : ''}

                </div>
              </section>

            `;
        }

        function _renderKpiTargetMultiRegion(){
            _ensureKpiMiniStyles();
            const container = document.getElementById('kpiTargetContainer');
            if(!container) return;

            // 根據區域限制過濾可見的 KPI Regions
            let visibleRegions = _KPI_REGIONS;
            const auth = getAuth();
            if (auth && auth.region && auth.region !== 'ADMIN' && window.REGION_ONLY_MODE) {
                // 只顯示登入區域的 KPI
                visibleRegions = _KPI_REGIONS.filter(r => r === auth.region);
            }

            // Build fixed sub-tabs + content area (no "scroll down to see another region")
            const stateKey = 'kpi_target_region';
            const saved = localStorage.getItem(stateKey);
            const defaultRegion = visibleRegions.includes(saved) ? saved : (visibleRegions[0] || 'VU');

            container.innerHTML = `
              <div class="kpi-subtabs" role="tablist" aria-label="KPI Target Regions">
                ${visibleRegions.map(r=>`<button class="kpi-subtab ${r===defaultRegion?'active':''}" data-region="${r}">${r}</button>`).join('')}
              </div>
              <div id="kpiTargetRegionContent"></div>
            `;

            const content = container.querySelector('#kpiTargetRegionContent');
            const tabs = Array.from(container.querySelectorAll('.kpi-subtab'));

            function setRegion(r){
                tabs.forEach(b=>b.classList.toggle('active', b.dataset.region===r));
                localStorage.setItem(stateKey, r);
                content.innerHTML = _renderRegionKpiBoard(r);
                // keep at top without scroll
                content.scrollIntoView({behavior:'instant', block:'start'});
            }

            tabs.forEach(btn=>{
                btn.addEventListener('click', ()=> setRegion(btn.dataset.region));
            });

            setRegion(defaultRegion);
        }

        // Override KPI Target render entry for this dashboard
        const _orig_renderKpiTargetTabMulti = renderKpiTargetTabMulti;
        renderKpiTargetTabMulti = function() {
            _renderKpiTargetMultiRegion();
        };
        /* ==================== /KPI Target - Multi-Region Visual KPI Board (2026) ==================== */


        function renderRegionKpiTargetTab(region) {
            if (!processedData || !processedData[region]) return;

            const data = processedData[region];
            const key = String(region).toLowerCase();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            // Annual totals
            const budgetAnnual = data.reduce((sum, m) => sum + (m.budget || 0), 0);
            const actualAnnual = data.reduce((sum, m) => sum + ((m.actualHW || 0) + (m.actualLicense || 0)), 0);
            const openpoAnnualK = Math.round(data.reduce((sum, m) => sum + (m.openpo || 0), 0) / 1000);

            // 6R totals (Jan-Jun)
            let budget6R = 0;
            let rolling6RRaw = 0;
            for (let i = 0; i < 6; i++) {
                budget6R += (data[i] && data[i].budget) ? data[i].budget : 0;
                rolling6RRaw += (data[i] && data[i].rolling) ? data[i].rolling : 0;
            }
            const rolling6RK = Math.round(rolling6RRaw / 1000);
            const estAR = budget6R > 0 ? (rolling6RK / budget6R) : 0;
            const estARText = (!estAR || !isFinite(estAR)) ? '#DIV/0!' : (Math.round(estAR * 100) + '%');


            // Pro KPI metrics
            const gap6R = rolling6RK - budget6R; // K
            const ach6R = budget6R > 0 ? (rolling6RK / budget6R) : 0;

            const pillClass = (v) => {
                if (!isFinite(v) || v <= 0) return 'bad';
                if (v >= 1) return 'good';
                if (v >= 0.9) return 'warn';
                return 'bad';
            };

            // Render Bullet rows (Rolling vs Budget, Actual, Open PO) using a consistent scale (max of key metrics)
            const scaleMax = Math.max(1, budget6R, rolling6RK, Math.round(actualAnnual), openpoAnnualK);
            const pct = (val) => Math.max(0, Math.min(100, (val / scaleMax) * 100));

            const bulletsEl = document.getElementById(`${key}Bullets`);
            if (bulletsEl) {
                const row = (name, valK, markerK, extraK, clickType) => {
                    const v = (valK || 0);
                    const m = (markerK || 0);
                    const e = (extraK || 0);
                    const right = (clickType === 'rolling') ? `${v.toLocaleString()}K` : `${v.toLocaleString()}K`;
                    return `
                      <div class="bullet-row bullet-hover" data-click="${clickType}" data-region="${region}">
                        <div class="name">${name}</div>
                        <div class="bullet-track">
                          <div class="bullet-budget" style="width:${pct(markerK)}%"></div>
                          <div class="bullet-actual" style="width:${pct(v)}%"></div>
                          ${clickType === 'openpo' ? `<div class="bullet-openpo" style="width:${pct(v)}%"></div>` : ''}
                          <div class="bullet-marker" style="left:${pct(markerK)}%"></div>
                        </div>
                        <div class="right">${right}</div>
                      </div>
                    `;
                };

                bulletsEl.innerHTML = [
                    row('Rolling 6R', rolling6RK, budget6R, 0, 'rolling'),
                    row('Actual (Annual)', Math.round(actualAnnual), budgetAnnual, 0, 'actual'),
                    row('Open PO (Annual)', openpoAnnualK, budgetAnnual, 0, 'openpo')
                ].join('');

                // Bind click -> reuse existing detail modals if available
                bulletsEl.querySelectorAll('.bullet-row').forEach((el) => {
                    el.addEventListener('click', () => {
                        const type = el.getAttribute('data-click');
                        // Prefer existing detail functions if present
                        if (type === 'actual' && typeof openActualDetailModal === 'function') {
                            openActualDetailModal(region);
                        } else if (type === 'openpo' && typeof openOpenPODetailModal === 'function') {
                            openOpenPODetailModal(region);
                        } else if (type === 'rolling' && typeof openRollingForecastDetailModal === 'function') {
                            openRollingForecastDetailModal(region);
                        }
                    });
                });
            }

            // Add professional pills on cards
            if (rollingEl) {
                const pill = `<span class="score-pill ${pillClass(ach6R)}" style="margin-left:.5rem;">Ach: ${Math.round(ach6R*100)}%</span>`;
                rollingEl.innerHTML = rolling6RK.toLocaleString() + 'K' + pill + `<div style="margin-top:.35rem; font-size:.85rem; color:#6B7280; font-weight:800;">Gap (6R): ${gap6R>=0?'+':''}${gap6R.toLocaleString()}K</div>`;
            }

            // Update cards
            const budgetEl = document.getElementById(`${key}BudgetTotal`);
            const actualEl = document.getElementById(`${key}ActualTotal`);
            const rollingEl = document.getElementById(`${key}Rolling6RTotal`);
            const estAREl = document.getElementById(`${key}EstAR6R`);
            const openPOEl = document.getElementById(`${key}OpenPOTotal`);
            if (budgetEl) budgetEl.textContent = budgetAnnual.toLocaleString() + 'K';
            if (actualEl) actualEl.textContent = Math.round(actualAnnual).toLocaleString() + 'K';
            // rollingEl filled with pill and gap above
            if (estAREl) estAREl.textContent = 'Est. A/R（6R/Budget）: ' + estARText;
            if (openPOEl) openPOEl.textContent = openpoAnnualK.toLocaleString() + 'K';
            // Build bullets + scorecard
            try {
                buildKpiTargetBullets(region, data);
                updateKpiTargetScorecard(region, budgetAnnual, actualAnnual, openpoAnnualK, budget6R, rolling6RK);
            } catch (e) { /* ignore */ }


            // Detail table
            const formatK = (v) => (v || v === 0) ? Math.round(v).toLocaleString() : '-';
            const budgetRow = data.map(m => m.budget || 0);
            const actualRow = data.map(m => Math.round((m.actualHW || 0) + (m.actualLicense || 0)));
            const openpoRow = data.map(m => Math.round((m.openpo || 0) / 1000));
            const rollingRow = data.map((m, idx) => idx < 6 ? Math.round((m.rolling || 0) / 1000) : 0);

            const sum = (arr) => arr.reduce((a, b) => a + (b || 0), 0);

            let html = '<thead><tr><th>Item</th>';
            months.forEach(m => html += `<th>${m}</th>`);
            html += '<th>Total</th></tr></thead><tbody>';

            html += '<tr><td><strong>Budget (K)</strong></td>';
            budgetRow.forEach(v => html += `<td>${formatK(v)}</td>`);
            html += `<td><strong>${formatK(sum(budgetRow))}</strong></td></tr>`;

            html += '<tr><td><strong>Actual (K)</strong></td>';
            actualRow.forEach(v => html += `<td>${formatK(v)}</td>`);
            html += `<td><strong>${formatK(sum(actualRow))}</strong></td></tr>`;

            html += '<tr><td><strong>Rolling (K)</strong><div style="font-size:0.75rem; color:#6B7280; font-weight:600; margin-top:0.15rem;">Jan-Jun only</div></td>';
            rollingRow.forEach((v, idx) => html += `<td>${idx < 6 ? formatK(v) : '-'}</td>`);
            html += `<td><strong>${formatK(sum(rollingRow.slice(0,6)))}</strong></td></tr>`;

            html += '<tr><td><strong>Open PO (K)</strong></td>';
            openpoRow.forEach(v => html += `<td>${formatK(v)}</td>`);
            html += `<td><strong>${formatK(sum(openpoRow))}</strong></td></tr>`;

            html += '</tbody>';
            const table = document.getElementById(`${key}KpiTargetTable`);
            if (table) table.innerHTML = html;
        }

        /* Final Pro KPI Target helpers */
        function _fmtK(v){
            if (v === null || v === undefined || !isFinite(v)) return '-';
            return Math.round(v).toLocaleString() + 'K';
        }
        function _pct(v){
            if (!isFinite(v) || v === null || v === undefined) return '-';
            return Math.round(v * 100) + '%';
        }
        function updateKpiTargetScorecard(region, budgetAnnual, actualAnnual, openpoAnnualK, budget6R, rolling6RK){
            const key = String(region).toLowerCase();
            const ach6R = budget6R > 0 ? (rolling6RK / budget6R) : 0;
            const gap6R = rolling6RK - budget6R;
            const gapAnnualProxy = (Math.round(actualAnnual) + openpoAnnualK) - budgetAnnual; // proxy

            const setText = (id, val) => { const el=document.getElementById(id); if(el) el.textContent = val; };
            setText(`${key}ScoreBudgetAnnual`, _fmtK(budgetAnnual));
            setText(`${key}ScoreActualAnnual`, _fmtK(Math.round(actualAnnual))); 
            setText(`${key}ScoreOpenpoAnnual`, _fmtK(openpoAnnualK));
            setText(`${key}ScoreBudget6R`, _fmtK(budget6R));
            setText(`${key}ScoreRolling6R`, _fmtK(rolling6RK));
            setText(`${key}ScoreAch6R`, _pct(ach6R));
            setText(`${key}ScoreGap6R`, (gap6R>=0?'+':'') + _fmtK(gap6R).replace('K','K'));

            const pill = document.getElementById(`${key}ScorePill`);
            if (pill){
                pill.classList.remove('good','warn','bad');
                let cls='bad';
                if (ach6R >= 1) cls='good';
                else if (ach6R >= 0.9) cls='warn';
                pill.classList.add(cls);
            }
            const pillGap = document.getElementById(`${key}ScorePillGap`);
            if (pillGap){
                pillGap.classList.remove('good','warn','bad');
                let cls2='warn';
                if (gapAnnualProxy >= 0) cls2='good';
                else if (gapAnnualProxy < 0) cls2='bad';
                pillGap.classList.add(cls2);
                pillGap.textContent = (gapAnnualProxy>=0?'+':'') + _fmtK(gapAnnualProxy);
            }
        }

        function buildKpiTargetBullets(region, data){
            const key = String(region).toLowerCase();
            const host = document.getElementById(`${key}Bullets`);
            if (!host) return;
            const months6 = ['Jan','Feb','Mar','Apr','May','Jun'];
            let budget6R = 0;
            let rolling6RRaw = 0;
            for (let i=0;i<6;i++){
                budget6R += (data[i] && data[i].budget) ? data[i].budget : 0;
                rolling6RRaw += (data[i] && data[i].rolling) ? data[i].rolling : 0;
            }
            const rolling6RK = Math.round(rolling6RRaw/1000);
            const max = Math.max(budget6R, rolling6RK, 1);
            const rows = months6.map((m,i)=>{
                const b = (data[i] && data[i].budget) ? data[i].budget : 0;
                const r = Math.round(((data[i] && data[i].rolling) ? data[i].rolling : 0)/1000);
                const a = Math.round(((data[i] && data[i].actualHW) ? data[i].actualHW : 0) + ((data[i] && data[i].actualLicense) ? data[i].actualLicense : 0));
                const ach = b>0 ? r/b : 0;
                const bw = (b/max)*100;
                const rw = (r/max)*100;
                return {m,b,r,a,ach,bw,rw};
            });
            host.innerHTML = rows.map(row=>`
                <div class="bullet-row" data-region="${region}" data-month="${row.m}">
                  <div class="m">${row.m}</div>
                  <div class="track" title="Budget ${_fmtK(row.b)} | Rolling ${_fmtK(row.r)}">
                    <div class="bar-budget" style="width:${row.bw}%;"></div>
                    <div class="bar-rolling" style="width:${row.rw}%;"></div>
                    <div class="marker" style="left:${row.bw}%;"></div>
                  </div>
                  <div class="val">${_pct(row.ach)}</div>
                </div>
            `).join('');

            // click behavior: open existing modal with a best-effort detail (falls back to a summary)
            host.querySelectorAll('.bullet-row').forEach(el=>{
                el.addEventListener('click', ()=>{
                    const r = el.getAttribute('data-region');
                    const m = el.getAttribute('data-month');
                    // Prefer using existing cell-detail modal if available
                    if (typeof openCellDetail === 'function'){
                        const monthIndex = {'Jan':0,'Feb':1,'Mar':2,'Apr':3,'May':4,'Jun':5}[m] ?? 0;
                        const d = processedData && processedData[r] ? processedData[r][monthIndex] : null;
                        const content = d ? (
                            `Region: ${r}<br/>Month: ${m}<br/><br/>` +
                            `Budget: ${_fmtK(d.budget||0)}<br/>Rolling: ${_fmtK(Math.round((d.rolling||0)/1000))}<br/>Actual(HW+Lic): ${_fmtK(Math.round((d.actualHW||0)+(d.actualLicense||0)))}<br/>Open PO: ${_fmtK(Math.round((d.openpo||0)/1000))}`
                        ) : `Region: ${r}<br/>Month: ${m}`;
                        openCellDetail(`${r} • ${m} KPI Target`, content);
                    }
                });
            });
        }


function renderEUKpiTargetTab() {
            if (!processedData || !processedData['EU']) {
                // 沒資料就先不渲染
                return;
            }

            const eu = processedData['EU'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            // Annual totals
            const budgetAnnual = eu.reduce((sum, m) => sum + (m.budget || 0), 0);
            const actualAnnual = eu.reduce((sum, m) => sum + ((m.actualHW || 0) + (m.actualLicense || 0)), 0);
            const openpoAnnualK = Math.round(eu.reduce((sum, m) => sum + (m.openpo || 0), 0) / 1000);

            // 6R totals (Jan-Jun)
            let budget6R = 0;
            let rolling6RRaw = 0;
            for (let i = 0; i < 6; i++) {
                budget6R += (eu[i] && eu[i].budget) ? eu[i].budget : 0;
                rolling6RRaw += (eu[i] && eu[i].rolling) ? eu[i].rolling : 0;
            }
            const rolling6RK = Math.round(rolling6RRaw / 1000);
            const estAR = budget6R > 0 ? (rolling6RK / budget6R) : 0;
            const estARText = (!estAR || !isFinite(estAR)) ? '#DIV/0!' : (Math.round(estAR * 100) + '%');

            // Update top cards
            const euBudgetEl = document.getElementById('euBudgetTotal');
            const euActualEl = document.getElementById('euActualTotal');
            const euRollingEl = document.getElementById('euRolling6RTotal');
            const euEstAREl = document.getElementById('euEstAR6R');
            const euOpenPOEl = document.getElementById('euOpenPOTotal');
            if (euBudgetEl) euBudgetEl.textContent = budgetAnnual.toLocaleString() + 'K';
            if (euActualEl) euActualEl.textContent = Math.round(actualAnnual).toLocaleString() + 'K';
            if (euRollingEl) euRollingEl.textContent = rolling6RK.toLocaleString() + 'K';
            if (euEstAREl) euEstAREl.textContent = 'Est. A/R（6R/Budget）: ' + estARText;
            if (euOpenPOEl) euOpenPOEl.textContent = openpoAnnualK.toLocaleString() + 'K';

            // Build detail table
            const formatK = (v) => (v || v === 0) ? Math.round(v).toLocaleString() : '-';
            const budgetRow = eu.map(m => m.budget || 0);
            const actualRow = eu.map(m => Math.round((m.actualHW || 0) + (m.actualLicense || 0)));
            const openpoRow = eu.map(m => Math.round((m.openpo || 0) / 1000));
            const rollingRow = eu.map((m, idx) => idx < 6 ? Math.round((m.rolling || 0) / 1000) : 0);

            const sum = (arr) => arr.reduce((a, b) => a + (b || 0), 0);

            let html = '<thead><tr><th>Item</th>';
            months.forEach(m => html += `<th>${m}</th>`);
            html += '<th>Total</th></tr></thead><tbody>';

            html += '<tr><td><strong>Budget (K)</strong></td>';
            budgetRow.forEach(v => html += `<td>${formatK(v)}</td>`);
            html += `<td><strong>${formatK(sum(budgetRow))}</strong></td></tr>`;

            html += '<tr><td><strong>Actual (K)</strong></td>';
            actualRow.forEach(v => html += `<td>${formatK(v)}</td>`);
            html += `<td><strong>${formatK(sum(actualRow))}</strong></td></tr>`;

            html += '<tr><td><strong>Rolling (K)</strong><div style="font-size:0.75rem; color:#6B7280; font-weight:600; margin-top:0.15rem;">Jan-Jun only</div></td>';
            rollingRow.forEach((v, idx) => html += `<td>${idx < 6 ? formatK(v) : '-'}</td>`);
            html += `<td><strong>${formatK(sum(rollingRow.slice(0,6)))}</strong></td></tr>`;

            html += '<tr><td><strong>Open PO (K)</strong></td>';
            openpoRow.forEach(v => html += `<td>${formatK(v)}</td>`);
            html += `<td><strong>${formatK(sum(openpoRow))}</strong></td></tr>`;

            html += '</tbody>';
            const table = document.getElementById('euKpiTargetTable');
            if (table) table.innerHTML = html;
        }

        function updateTrendBadge(elementId, percentage, isUp) {
            // 移除此函數，不再需要
        }

        function downloadResults() {
            const data = processedData;
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            let regions = ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'];
            regions = constrainRegions(regions);

            const exportData = [];
            
            regions.forEach(region => {
                const row = { '區域': region };
                months.forEach((month, i) => {
                    const d = data[region][i];
                    row[`${month}_Budget`] = d.budget;
                    row[`${month}_Rolling`] = Math.round(d.rolling / 1000);
                    row[`${month}_OpenPO`] = Math.round(d.openpo / 1000);
                });
                exportData.push(row);
            });

            const totalRow = { '區域': 'Total' };
            months.forEach((month, i) => {
                let budgetTotal = 0, rollingTotalRaw = 0, openpoTotalRaw = 0;
                regions.forEach(region => {
                    budgetTotal += data[region][i].budget;
                    rollingTotalRaw += data[region][i].rolling;
                    openpoTotalRaw += data[region][i].openpo;
                });
                totalRow[`${month}_Budget`] = budgetTotal;
                totalRow[`${month}_Rolling`] = Math.round(rollingTotalRaw / 1000);
                totalRow[`${month}_OpenPO`] = Math.round(openpoTotalRaw / 1000);
            });
            exportData.push(totalRow);

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '整合報表');
            XLSX.writeFile(wb, '整合報表_OPEN_PO.xlsx');
        }

        function generateStandaloneReport() {
            // 檢查是否有數據
            if (!processedData) {
                alert('請先上傳並處理所有必要的資料檔案');
                return;
            }
            
            // 驗證數據完整性
            console.log('準備生成獨立報告...');
            console.log('ProcessedData:', processedData ? '✓' : '✗');
            console.log('ActualData:', actualData ? '✓' : '✗');
            console.log('Material2025Data:', material2025Data ? '✓' : '✗');
            
            showToast('正在生成獨立報告，請稍候...');
            
            // 收集所有數據
            const reportData = {
                processedData: processedData,
                actualData: actualData,
                material2025Data: material2025Data,
                materialReferenceData: materialReferenceData,
                rollingDemandData: rollingDemandData,
                rawData: rawData,
                authState: (typeof getAuth === 'function' ? getAuth() : null),
                generatedDate: new Date().toISOString(),
                version: 'v2.0.0'
            };
            
            console.log('數據收集完成，開始序列化...');
            
            // 序列化數據
            const dataScript = `
                <script>
                // 嵌入的報告數據
                window.EMBEDDED_REPORT_DATA = ${JSON.stringify(reportData)};
                window.IS_STANDALONE_REPORT = true;
                window.STANDALONE_BYPASS_AUTH = false;
                
                // 當文檔載入完成後，自動載入數據
                document.addEventListener('DOMContentLoaded', function() {
                    if (window.EMBEDDED_REPORT_DATA) {
                        console.log('載入嵌入的報告數據...');
                        
                        // 恢復全局變量
                        processedData = window.EMBEDDED_REPORT_DATA.processedData;
                        actualData = window.EMBEDDED_REPORT_DATA.actualData;
                        material2025Data = window.EMBEDDED_REPORT_DATA.material2025Data;
                        materialReferenceData = window.EMBEDDED_REPORT_DATA.materialReferenceData;
                        rollingDemandData = window.EMBEDDED_REPORT_DATA.rollingDemandData;
                        rawData = window.EMBEDDED_REPORT_DATA.rawData;

                        // 恢復權限狀態（保持原本各區限制）
                        if (window.EMBEDDED_REPORT_DATA.authState && typeof setAuth === 'function') {
                            try {
                                setAuth(window.EMBEDDED_REPORT_DATA.authState);
                            } catch (e) {
                                console.warn('restore authState failed', e);
                            }
                        }
                        
                        // 隱藏上傳區域
                        const uploadSection = document.getElementById('upload');
                        if (uploadSection) {
                            uploadSection.style.display = 'none';
                        }
                        
                        // 隱藏處理中提示
                        const processingSection = document.getElementById('processing');
                        if (processingSection) {
                            processingSection.classList.remove('show');
                        }
                        
                        // 顯示儀表板
                        const dashboardSection = document.getElementById('dashboard');
                        if (dashboardSection) {
                            dashboardSection.style.display = 'block';
                            dashboardSection.classList.add('show');
                        }
                        
                        const loadingSection = document.getElementById('loading');
                        if (loadingSection) {
                            loadingSection.style.display = 'none';
                        }
                        
                        // 延遲渲染以確保 DOM 準備完成
                        setTimeout(function() {
                            try {
                                console.log('開始渲染數據...');
                                console.log('ProcessedData:', processedData ? 'OK' : 'Missing');
                                console.log('ActualData:', actualData ? 'OK' : 'Missing');
                                
                                // 統一使用過濾版本，確保一致性
                                // 檢查是否有區域限制，並設置初始過濾器
                                const auth = getAuth();
                                if (auth && auth.region && auth.region !== 'ADMIN' && window.REGION_ONLY_MODE) {
                                    // 有區域限制，設置為該區域
                                    currentFilters.regions = [auth.region];
                                } else {
                                    // 無限制，設置為所有區域
                                    currentFilters.regions = ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'];
                                }
                                
                                // 使用統一的過濾版本函數
                                refreshDashboardWithFilters();
                                
                                console.log('✅ 報告數據載入完成');
                                
                                // 在標題處添加提示
                                const header = document.querySelector('h1');
                                if (header && !document.getElementById('report-badge')) {
                                    const badge = document.createElement('span');
                                    badge.id = 'report-badge';
                                    badge.style.cssText = 'background: #10B981; color: white; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.75rem; margin-left: 1rem; font-weight: 600;';
                                    badge.textContent = '獨立報告 - 生成於 ' + new Date(window.EMBEDDED_REPORT_DATA.generatedDate).toLocaleString('zh-TW');
                                    header.appendChild(badge);
                                }
                            } catch (error) {
                                console.error('❌ 渲染錯誤:', error);
                                console.error('錯誤堆疊:', error.stack);
                                alert('報告渲染時發生錯誤: ' + error.message + '\\n請檢查瀏覽器控制台以獲取更多信息');
                            }
                        }, 1000);
                    }
                });
                <\/script>
            `;
            
            // 獲取當前 HTML
            const currentHTML = document.documentElement.outerHTML;
            
            // 在 </head> 前插入數據腳本
            const modifiedHTML = currentHTML.replace('</head>', dataScript + '</head>');
            
            // 創建 Blob 並下載
            const blob = new Blob([modifiedHTML], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            
            // 生成文件名（包含日期）
            const dateStr = new Date().toISOString().slice(0, 10);
            link.download = `Sales_Dashboard_Report_${dateStr}.html`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('✅ 獨立報告已生成！請將 HTML 文件發送給主管');
        }

        
        // 生成只包含 VORTEX SKU Overview 的簡化區域報告

        function generateRegionReport(region) {
            try {
                // 檢查是否有數據
                if (!processedData) {
                    alert('錯誤：沒有 processedData，請先上傳並處理 Open PO、Budget、Rolling 文件');
                    return;
                }
                
                if (!material2025Data) {
                    alert('錯誤：沒有 material2025Data，請先上傳 VORTEX SKU Overview 文件');
                    return;
                }
                
                console.log(`========== 開始生成 ${region} 區域報告 ==========`);
                showToast(`正在生成 ${region} 區域報告，請稍候...`);
                
                // 過濾該區域的數據
                console.log('步驟 1: 過濾 processedData...');
                const regionProcessedData = {};
                if (processedData[region]) {
                    regionProcessedData[region] = processedData[region];
                    console.log(`✓ ProcessedData: ${region} 有 12 個月數據`);
                } else {
                    console.warn(`⚠️ ProcessedData: ${region} 沒有數據`);
                }
                
                // 過濾該區域的 Actual 數據
                console.log('步驟 2: 過濾 actualData...');
                const regionActualData = {};
                if (actualData) {
                    // actualData 是對象格式 {TW: [...], ANZ: [...], ...}
                    if (typeof actualData === 'object' && !Array.isArray(actualData)) {
                        // 保持對象格式，但只包含該區域
                        if (actualData[region]) {
                            regionActualData[region] = actualData[region];
                            console.log(`✓ ActualData: ${region} 有 12 個月數據`);
                        } else {
                            console.warn(`⚠️ ActualData: ${region} 沒有數據`);
                        }
                    } else if (Array.isArray(actualData)) {
                        // 如果是數組格式，則過濾並轉換為對象
                        const filtered = actualData.filter(item => item.Region === region);
                        if (filtered.length > 0) {
                            regionActualData[region] = filtered;
                            console.log(`✓ ActualData: ${filtered.length} 筆`);
                        }
                    } else {
                        console.warn(`⚠️ ActualData 格式不正確:`, typeof actualData);
                    }
                } else {
                    console.log(`ℹ️ ActualData: 無數據`);
                }
                
                // 過濾該區域的 Material 數據
                console.log('步驟 3: 過濾 material2025Data...');
                const regionMaterial2025Data = {};
                if (material2025Data && material2025Data[region]) {
                    regionMaterial2025Data[region] = material2025Data[region];
                    console.log(`✓ Material2025Data: ${material2025Data[region].length} 筆`);
                } else {
                    console.warn(`⚠️ Material2025Data: ${region} 沒有數據`);
                }
                
                // 過濾該區域的 Rolling Demand 數據
                console.log('步驟 4: 過濾 rollingDemandData...');
                const regionRollingDemandData = {};
                if (rollingDemandData && rollingDemandData[region]) {
                    regionRollingDemandData[region] = rollingDemandData[region];
                    console.log(`✓ RollingDemandData: 有數據`);
                } else {
                    console.log(`ℹ️ RollingDemandData: ${region} 沒有數據（可選）`);
                }
                
                // 過濾該區域的 Material Reference 數據
                console.log('步驟 5: 過濾 materialReferenceData...');
                const regionMaterialReferenceData = {};
                if (materialReferenceData && materialReferenceData[region]) {
                    regionMaterialReferenceData[region] = materialReferenceData[region];
                    console.log(`✓ MaterialReferenceData: 有數據`);
                } else {
                    console.log(`ℹ️ MaterialReferenceData: ${region} 沒有數據（可選）`);
                }
                
                // 過濾該區域的原始數據
                console.log('步驟 6: 過濾 rawData...');
                const regionRawData = {
                    openpo: rawData.openpo ? rawData.openpo.filter(item => item.Region === region) : [],
                    budget: rawData.budget ? rawData.budget.filter(item => item.Region === region) : [],
                    rolling: rawData.rolling ? rawData.rolling.filter(item => item.Region === region) : [],
                    actual: rawData.actual ? rawData.actual.filter(item => item.Region === region) : [],
                    material2025: rawData.material2025 ? rawData.material2025.filter(item => {
                        const itemRegion = item.Region || item['區域'] || item.region || '';
                        return itemRegion === region;
                    }) : []
                };
                console.log(`✓ RawData 過濾完成`);
                
                // 收集區域數據
                console.log('步驟 7: 組裝報告數據...');
                const regionReportData = {
                    region: region,
                    processedData: regionProcessedData,
                    actualData: regionActualData,
                    material2025Data: regionMaterial2025Data,
                    materialReferenceData: regionMaterialReferenceData,
                    rollingDemandData: regionRollingDemandData,
                    rawData: regionRawData,
                    generatedDate: new Date().toISOString(),
                    version: 'v2.0.0 - Region Specific'
                };
                console.log(`✓ 報告數據組裝完成`);
                
                // 序列化數據
                console.log('步驟 8: 序列化數據為 JSON...');
                let jsonString;
                try {
                    jsonString = JSON.stringify(regionReportData);
                    console.log(`✓ JSON 序列化成功，大小: ${(jsonString.length / 1024).toFixed(2)} KB`);
                } catch (jsonError) {
                    console.error('❌ JSON 序列化失敗:', jsonError);
                    alert(`數據序列化失敗：${jsonError.message}\n請檢查瀏覽器控制台以獲取更多信息`);
                    return;
                }
                
                console.log('步驟 9: 生成嵌入腳本...');
                const dataScript = `
                <script>
                // 嵌入的區域報告數據
                window.EMBEDDED_REGION_REPORT_DATA = ${jsonString};
                window.IS_REGION_REPORT = true;
                
                // 當文檔載入完成後，自動載入數據
                document.addEventListener('DOMContentLoaded', function() {
                    if (window.EMBEDDED_REGION_REPORT_DATA) {
                        console.log('載入 ${region} 區域報告數據...');
                        
                        const regionData = window.EMBEDDED_REGION_REPORT_DATA;
                        
                        // 恢復全局變量
                        processedData = regionData.processedData;
                        actualData = regionData.actualData;
                        material2025Data = regionData.material2025Data;
                        materialReferenceData = regionData.materialReferenceData;
                        rollingDemandData = regionData.rollingDemandData;
                        rawData = regionData.rawData;
                        
                        // 驗證數據格式
                        console.log('驗證數據格式...');
                        console.log('- processedData type:', typeof processedData, 'keys:', Object.keys(processedData || {}));
                        console.log('- actualData type:', typeof actualData, 'keys:', Object.keys(actualData || {}));
                        console.log('- material2025Data type:', typeof material2025Data, 'keys:', Object.keys(material2025Data || {}));
                        
                        // 隱藏上傳區域
                        const uploadSection = document.getElementById('upload');
                        if (uploadSection) {
                            uploadSection.style.display = 'none';
                        }
                        
                        // 隱藏處理中提示
                        const processingSection = document.getElementById('processing');
                        if (processingSection) {
                            processingSection.classList.remove('show');
                        }
                        
                        // 顯示儀表板
                        const dashboardSection = document.getElementById('dashboard');
                        if (dashboardSection) {
                            dashboardSection.style.display = 'block';
                            dashboardSection.classList.add('show');
                        }
                        
                        const loadingSection = document.getElementById('loading');
                        if (loadingSection) {
                            loadingSection.style.display = 'none';
                        }
                        
                        // 延遲渲染以確保 DOM 準備完成
                        setTimeout(function() {
                            try {
                                console.log('開始渲染 ${region} 區域數據...');
                                
                                // 統一使用過濾版本，確保一致性
                                // 檢查是否有區域限制，並設置初始過濾器
                                const auth = getAuth();
                                if (auth && auth.region && auth.region !== 'ADMIN' && window.REGION_ONLY_MODE) {
                                    // 有區域限制，設置為該區域
                                    currentFilters.regions = [auth.region];
                                } else {
                                    // 無限制，設置為所有區域
                                    currentFilters.regions = ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'];
                                }
                                
                                // 使用統一的過濾版本函數
                                refreshDashboardWithFilters();
                                
                                console.log('✅ ${region} 區域報告載入完成');
                                
                                // 在標題處添加區域標識
                                const header = document.querySelector('h1');
                                if (header && !document.getElementById('region-badge')) {
                                    const badge = document.createElement('span');
                                    badge.id = 'region-badge';
                                    badge.style.cssText = 'background: #3B82F6; color: white; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.75rem; margin-left: 1rem; font-weight: 600;';
                                    badge.textContent = '${region} 區域報告 - ' + new Date(regionData.generatedDate).toLocaleString('zh-TW');
                                    header.appendChild(badge);
                                }
                                
                                // 添加區域專屬樣式提示
                                const material2025Section = document.getElementById('material2025');
                                if (material2025Section && !document.getElementById('region-notice')) {
                                    const notice = document.createElement('div');
                                    notice.id = 'region-notice';
                                    notice.style.cssText = 'margin-top: 1rem; padding: 1rem; background: #EFF6FF; border-left: 4px solid #3B82F6; border-radius: 6px;';
                                    notice.innerHTML = '<strong style="color: #1E40AF;">📊 ${region} 區域專屬報告</strong><br><span style="color: #1E3A8A; font-size: 0.875rem;">此報告僅包含 ${region} 區域的數據</span>';
                                    material2025Section.appendChild(notice);
                                }
                                
                            } catch (error) {
                                console.error('❌ 渲染錯誤:', error);
                                console.error('錯誤堆疊:', error.stack);
                                alert('報告渲染時發生錯誤: ' + error.message);
                            }
                        }, 1000);
                    }
                });
                <\/script>
            `;
            console.log('✓ 嵌入腳本生成完成');
            
            // 獲取當前 HTML
            console.log('步驟 10: 獲取當前 HTML...');
            const currentHTML = document.documentElement.outerHTML;
            console.log(`✓ 當前 HTML 大小: ${(currentHTML.length / 1024).toFixed(2)} KB`);
            
            // 在 </head> 前插入數據腳本
            console.log('步驟 11: 插入數據腳本...');
            const modifiedHTML = currentHTML.replace('</head>', dataScript + '</head>');
            console.log(`✓ 修改後 HTML 大小: ${(modifiedHTML.length / 1024).toFixed(2)} KB`);
            
            // 創建 Blob 並下載
            console.log('步驟 12: 創建 Blob 並下載...');
            const blob = new Blob([modifiedHTML], { type: 'text/html;charset=utf-8' });
            console.log(`✓ Blob 創建成功，大小: ${(blob.size / 1024).toFixed(2)} KB`);
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            
            // 生成文件名
            const dateStr = new Date().toISOString().slice(0, 10);
            link.download = `VORTEX_SKU_Overview_${region}_${dateStr}.html`;
            console.log(`✓ 文件名: ${link.download}`);
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            console.log(`========== ${region} 區域報告生成完成 ==========`);
            showToast(`✅ ${region} 區域報告已生成！文件名：VORTEX_SKU_Overview_${region}_${dateStr}.html`);
            
        } catch (error) {
            console.error(`========== ${region} 區域報告生成失敗 ==========`);
            console.error('錯誤類型:', error.name);
            console.error('錯誤信息:', error.message);
            console.error('錯誤堆疊:', error.stack);
            alert(`生成 ${region} 區域報告時發生錯誤：\n\n${error.message}\n\n請按 F12 打開開發者工具查看詳細錯誤信息`);
            showToast(`❌ ${region} 區域報告生成失敗`);
        }
    }

        function downloadDetailedReport() {
            if (!processedData || !actualData) {
                alert('請先上傳並處理所有必要的資料檔案');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const ws_data = [];
            
            // 標題行
            ws_data.push(['', '', '', '1A', '', 'YTM', '', '', 'January', '', '', '6R', '', '', '', '', '', '2026 6R Est. A/R（6R/Budget）', '', '2026 (1A+6R) Est. A/R（6R/Budget）', '', '']);
            ws_data.push(['(US$, K)', '', '', 'Jan.', '', '(Jan.-Dec.)', '', '', '', '', '', 'Jan.', 'Feb', 'Mar', 'Apr', 'May', 'Jun', '', '6R', '', '1A+6R', '', '']);
            ws_data.push(['Region', 'Item', '', 'Actual', 'Actual', 'Budget', 'Ach.Rate', 'MTD', 'Budget', 'Ach.Rate', '', '', '', 'Rolling Forecast', '', '', '', '', 'Budget', 'Est. A/R（6R/Budget）', 'Budget', 'Est. A/R（6R/Budget）']);
            
            let regions = ['VU', 'DEJ', 'VJP', 'TW', 'ANZ', 'EU'];
            regions = constrainRegions(regions);
            const regionNames = { VU: 'VU', DEJ: 'DEJ', VJP: 'VJP', TW: 'TW', ANZ: 'ANZ', EU: 'EU', MN: 'CloudSight' };
            
            let vortexHW = 0, vortexSub = 0, vortexTotal = 0;
            
            regions.forEach(region => {
                // 取得 Actual 數據（Jan）
                const actualHW = Math.round((actualData[region][0].hardware) / 1000);
                const actualLic = Math.round((actualData[region][0].license) / 1000);
                const actualTotal = actualHW + actualLic;
                
                // 取得 Budget 數據（Jan）
                const budgetTotal = processedData[region][0].budget;
                const budgetHW = Math.round(budgetTotal * 0.75);
                const budgetSub = Math.round(budgetTotal * 0.25);
                
                // 計算達成率
                const achRateHW = budgetHW > 0 ? actualHW / budgetHW : 0;
                const achRateSub = budgetSub > 0 ? actualLic / budgetSub : 0;
                const achRateTotal = budgetTotal > 0 ? actualTotal / budgetTotal : 0;
                
                // HW 行
                ws_data.push([
                    regionNames[region], 'HW', '', 
                    actualHW, actualTotal, budgetTotal, achRateTotal,
                    actualHW, budgetHW, achRateHW,
                    '', '', '', '', '', '', '', '', budgetHW, '', budgetHW, ''
                ]);
                
                // Subscription 行
                ws_data.push([
                    '', 'Subscription', '',
                    actualLic, '', '', '',
                    actualLic, budgetSub, achRateSub,
                    '', '', '', '', '', '', '', '', budgetSub, '', budgetSub, ''
                ]);
                
                // Total 行
                ws_data.push([
                    '', 'Total', '',
                    actualTotal, '', '', '',
                    actualTotal, budgetTotal, achRateTotal,
                    '', '', '', '', '', '', '', '', budgetTotal, '', budgetTotal, ''
                ]);
                
                vortexHW += actualHW;
                vortexSub += actualLic;
                vortexTotal += actualTotal;
            });
            
            // VORTEX TTL
            const vortexBudgetTotal = regions.reduce((sum, r) => sum + processedData[r][0].budget, 0);
            const vortexBudgetHW = Math.round(vortexBudgetTotal * 0.75);
            const vortexBudgetSub = Math.round(vortexBudgetTotal * 0.25);
            
            ws_data.push(['VORTEX TTL', 'HW', '', vortexHW, vortexTotal, vortexBudgetTotal, vortexTotal/vortexBudgetTotal, vortexHW, vortexBudgetHW, vortexHW/vortexBudgetHW, '', '', '', '', '', '', '', '', vortexBudgetHW, '', vortexBudgetHW, '']);
            ws_data.push(['', 'Subscription', '', vortexSub, '', '', '', vortexSub, vortexBudgetSub, vortexSub/vortexBudgetSub, '', '', '', '', '', '', '', '', vortexBudgetSub, '', vortexBudgetSub, '']);
            ws_data.push(['', 'Total', '', vortexTotal, '', '', '', vortexTotal, vortexBudgetTotal, vortexTotal/vortexBudgetTotal, '', '', '', '', '', '', '', '', vortexBudgetTotal, '', vortexBudgetTotal, '']);
            
            // CloudSight (MN)
            if (actualData['MN']) {
                const mnHW = Math.round(actualData['MN'][0].hardware / 1000);
                const mnLic = Math.round(actualData['MN'][0].license / 1000);
                const mnTotal = mnHW + mnLic;
                const mnBudget = processedData['MN'][0].budget;
                const mnBudgetHW = Math.round(mnBudget * 0.75);
                const mnBudgetSub = Math.round(mnBudget * 0.25);
                
                ws_data.push(['CloudSight', 'HW', '', mnHW, mnTotal, mnBudget, mnTotal/mnBudget, mnHW, mnBudgetHW, mnHW/mnBudgetHW, '', '', '', '', '', '', '', '', mnBudgetHW, '', mnBudgetHW, '']);
                ws_data.push(['', 'Subscription', '', mnLic, '', '', '', mnLic, mnBudgetSub, mnLic/mnBudgetSub, '', '', '', '', '', '', '', '', mnBudgetSub, '', mnBudgetSub, '']);
                ws_data.push(['', 'Total', '', mnTotal, '', '', '', mnTotal, mnBudget, mnTotal/mnBudget, '', '', '', '', '', '', '', '', mnBudget, '', mnBudget, '']);
                
                // SSSBD TTL
                const sssbdHW = vortexHW + mnHW;
                const sssbdSub = vortexSub + mnLic;
                const sssbdTotal = vortexTotal + mnTotal;
                const sssbdBudgetTotal = vortexBudgetTotal + mnBudget;
                const sssbdBudgetHW = vortexBudgetHW + mnBudgetHW;
                const sssbdBudgetSub = vortexBudgetSub + mnBudgetSub;
                
                ws_data.push(['SSSBD TTL', 'HW', '', sssbdHW, sssbdTotal, sssbdBudgetTotal, sssbdTotal/sssbdBudgetTotal, sssbdHW, sssbdBudgetHW, sssbdHW/sssbdBudgetHW, '', '', '', '', '', '', '', '', sssbdBudgetHW, '', sssbdBudgetHW, '']);
                ws_data.push(['', 'Subscription', '', sssbdSub, '', '', '', sssbdSub, sssbdBudgetSub, sssbdSub/sssbdBudgetSub, '', '', '', '', '', '', '', '', sssbdBudgetSub, '', sssbdBudgetSub, '']);
                ws_data.push(['', 'Total', '', sssbdTotal, '', '', '', sssbdTotal, sssbdBudgetTotal, sssbdTotal/sssbdBudgetTotal, '', '', '', '', '', '', '', '', sssbdBudgetTotal, '', sssbdBudgetTotal, '']);
            }
            
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // 設定欄寬
            ws['!cols'] = [
                {wch: 12}, {wch: 12}, {wch: 5}, {wch: 8}, {wch: 8}, {wch: 8}, {wch: 10},
                {wch: 8}, {wch: 8}, {wch: 10}, {wch: 5},
                {wch: 8}, {wch: 8}, {wch: 8}, {wch: 8}, {wch: 8}, {wch: 8},
                {wch: 5}, {wch: 8}, {wch: 10}, {wch: 8}, {wch: 10}
            ];
            
            // 添加顏色格式（達成率）
            // 注意：SheetJS 需要特殊處理才能添加顏色，這裡先生成基本版本
            
            XLSX.utils.book_append_sheet(wb, ws, '詳細業績報表');
            XLSX.writeFile(wb, '詳細業績報表_' + new Date().toISOString().slice(0, 10) + '.xlsx');
            
            console.log('詳細業績報表已下載');
        }

        function showMonthlyBarChart(type, region) {
            // ==================== UI Access Control ====================
            // Pie chart / KPI 的 drill-down 視為「明細」：
            // 未登入或無權限時，不允許打開月份分析（避免繞過登入直接看細項）。
            if (typeof requireRegionAccess === 'function') {
                if (!requireRegionAccess(region)) return;
            }
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthlyData = processedData[region].map(m => {
                if (type === 'budget') return m.budget;
                if (type === 'rolling') return Math.round(m.rolling / 1000);
                if (type === 'openpo') return Math.round(m.openpo / 1000);
                if (type === 'actualHW') return Math.round(m.actualHW || 0);
                if (type === 'actualLic') return Math.round(m.actualLicense || 0);
                return 0;
            });

            const typeNames = {
                budget: 'Budget',
                rolling: 'Rolling',
                openpo: 'Open PO',
                actualHW: 'Actual Hardware',
                actualLic: 'Actual License'
            };

            document.getElementById('barChartTitle').textContent = `${typeNames[type]} - ${region} (月份分析)`;
            document.getElementById('barChartModal').classList.add('show');

            if (currentBarChart) {
                currentBarChart.destroy();
            }

            const ctx = document.getElementById('barChart');
            currentBarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: typeNames[type],
                        data: monthlyData,
                        backgroundColor: regionColors[region],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value;
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0 && type !== 'budget') {
                            const monthIndex = elements[0].index;
                            const monthName = months[monthIndex];
                            showDetailTable(type, region, monthIndex, monthName);
                        }
                    }
                }
            });
        }

        function showDetailTable(type, region, monthIndex, monthName) {
            const typeNames = {
                rolling: 'Rolling',
                openpo: 'Open PO',
                actualHW: 'Actual Hardware',
                actualLic: 'Actual License'
            };

            document.getElementById('detailTitle').textContent = 
                `${typeNames[type]} - ${region} - ${monthName} 明細`;

            let tableHTML = '';

            if (type === 'rolling') {
                // Filter rolling data for this region and month
                const yearMonth = `2026${String(monthIndex + 1).padStart(2, '0')}`;
                const filteredData = rawData.rolling.filter(row => {
                    const regionPF = (row['REGION_PF'] || '').trim();
                    const customerName = (row['Customer Name'] || '').trim();
                    const rowYearMonth = (row['YEAR/MONTH'] || '').toString().trim();
                    
                    if (rowYearMonth !== yearMonth) return false;

                    // Apply region filters
                    if (region === 'MN' && regionPF === 'MCAN-CASC') return true;
                    if (region === 'DEJ' && regionPF === 'DEJ-SSS') return true;
                    if (region === 'VU' && regionPF === 'VUS-VIP') return true;
                    if (region === 'VJP' && (regionPF === 'VTW-VIP' || regionPF === 'VTW-VSWSO') && 
                        customerName.includes('TAKEBISHI')) return true;
                    if (region === 'TW' && (regionPF === 'VTW-VIP' || regionPF === 'VTW-VSWSO') && 
                        ['TW-BAS', 'SEEDTEK', 'TOTAL TECHNOLOGY', 'ZERO ONE', 'GOOD WILL', 'RAH INFOTECH']
                        .some(c => customerName.toUpperCase().includes(c.toUpperCase()))) return true;
                    if (region === 'ANZ' && (regionPF === 'VTW-VIP' || regionPF === 'VTW-VSWSO') && 
                        ['VSP', 'SECUSAFE', 'CLEAR DIGITAL']
                        .some(c => customerName.toUpperCase().includes(c.toUpperCase()))) return true;
                    if (region === 'EU' && (regionPF === 'VTW-VIP' || regionPF === 'VTW-VSWSO') && 
                        ['ATKM', 'TEB', 'KAMTEK']
                        .some(c => customerName.toUpperCase().includes(c.toUpperCase()))) return true;
                    
                    return false;
                });

                tableHTML = '<table class="detail-table"><thead><tr>';
                tableHTML += '<th>MATERIAL</th><th>Model</th><th>BILLING QTY</th><th>Customer Name</th><th>AMOUNT (USD)</th>';
                tableHTML += '</tr></thead><tbody>';

                filteredData.forEach(row => {
                    const material = row['MATERIAL'] || '';
                    const model = (materialReferenceData && materialReferenceData[material] && materialReferenceData[material].model)
                        ? materialReferenceData[material].model
                        : '-';
                    const billingQty = row['BILLING QTY'] || '';
                    const customerName = row['Customer Name'] || '';
                    const amount = Math.round(parseFloat(row['AMOUNT_USD'] || 0) / 1000);

                    tableHTML += '<tr>';
                    tableHTML += `<td>${material}</td>`;
                    tableHTML += `<td>${model}</td>`;
                    tableHTML += `<td>${billingQty}</td>`;
                    tableHTML += `<td>${customerName}</td>`;
                    tableHTML += `<td>${amount.toLocaleString()}</td>`;
                    tableHTML += '</tr>';
                });

                tableHTML += '</tbody></table>';

            } else if (type === 'openpo') {
                // Filter OPEN PO data for this region and month
                const filteredData = rawData.openpo.filter(row => {
                    const description = row['Description'] || row['Sales Organization'] || '';
                    const customerName = row['客戶名稱'] || row['Customer'] || '';
                    const deliveryDate = row['請求交貨日期'] || '';

                    // Check region
                    let matchRegion = false;
                    if (region === 'EU' && description.includes('歐非')) matchRegion = true;
                    else if (region === 'TW' && (
                        (description.includes('亞太') && customerName.includes('DELTA')) ||
                        description.includes('拉美')
                    )) matchRegion = true;
                    else if (region === 'ANZ' && description.includes('亞太') && 
                        (customerName.includes('SECUSAFE') || customerName.includes('VIDEO SECURITY') || 
                         customerName.includes('SENSATEK'))) matchRegion = true;
                    else if (region === 'VJP' && description.includes('日本') && 
                        customerName.includes('DX ANTENNA')) matchRegion = true;
                    else if (region === 'DEJ' && description.includes('日本業務部') &&
                        customerName.includes('DELTA ELECTRONICS (J')) matchRegion = true;

                    if (!matchRegion) return false;

                    // Check month
                    const dateStr = deliveryDate.toString();
                    let deliveryMonth = -1;

                    if (/^\d+$/.test(dateStr) && parseInt(dateStr) > 1000) {
                        const excelDate = parseInt(dateStr);
                        const excelEpoch = new Date(1899, 11, 30);
                        const jsDate = new Date(excelEpoch.getTime() + excelDate * 86400000);
                        deliveryMonth = jsDate.getMonth();
                    } else {
                        let dateMatch = dateStr.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
                        if (dateMatch) {
                            const first = parseInt(dateMatch[1]);
                            const third = parseInt(dateMatch[3]);
                            if (third <= 99) {
                                deliveryMonth = first - 1;
                            } else if (third >= 2000) {
                                deliveryMonth = first > 12 ? parseInt(dateMatch[2]) - 1 : first - 1;
                            }
                        }
                    }

                    return deliveryMonth === monthIndex;
                });

                tableHTML = '<table class="detail-table"><thead><tr>';
                tableHTML += '<th>物料號碼</th><th>物料說明</th><th>訂購數量</th><th>本國未交金額</th><th>扣除</th><th>逐月</th>';
                tableHTML += '</tr></thead><tbody>';

                let totalUndelivered = 0;
                let totalDeduction = 0;
                let totalMonthly = 0;

                filteredData.forEach((row, index) => {
                    const materialNo = row['物料號碼'] || row['APR Material'] || '';
                    const materialDesc = row['物料說明'] || row['Master Data'] || '';
                    const orderQty = row['訂購數量'] || row['確認數量'] || '';
                    const undeliveredAmount = Math.round(parseFloat(row['本國未交金額'] || 0) / 1000);
                    
                    // 使用 processOpenPORow 來計算扣除和逐月
                    const processed = processOpenPORow(row, index);
                    const deduction = Math.round(processed.扣除 / 1000);
                    const monthly = Math.round(processed.逐月 / 1000);

                    totalUndelivered += undeliveredAmount;
                    totalDeduction += deduction;
                    totalMonthly += monthly;

                    tableHTML += '<tr>';
                    tableHTML += `<td>${materialNo}</td>`;
                    tableHTML += `<td>${materialDesc}</td>`;
                    tableHTML += `<td>${orderQty}</td>`;
                    tableHTML += `<td>${undeliveredAmount.toLocaleString()}</td>`;
                    tableHTML += `<td>${deduction.toLocaleString()}</td>`;
                    tableHTML += `<td>${monthly.toLocaleString()}</td>`;
                    tableHTML += '</tr>';
                });

                const calculatedAmount = Math.round((totalUndelivered - totalDeduction + totalMonthly) / 30);

                tableHTML += '<tr style="background-color: #f3f4f6; font-weight: bold;">';
                tableHTML += '<td colspan="3" style="text-align: right;">總計：</td>';
                tableHTML += `<td><strong>${totalUndelivered.toLocaleString()}</strong></td>`;
                tableHTML += `<td>${totalDeduction.toLocaleString()}</td>`;
                tableHTML += `<td>${totalMonthly.toLocaleString()}</td>`;
                tableHTML += '</tr>';
                tableHTML += '<tr style="background-color: #fef3c7;">';
                tableHTML += '<td colspan="3" style="text-align: right;"><strong>Open PO 計算：</strong></td>';
                tableHTML += `<td colspan="3" style="text-align: left;"><strong>(${totalUndelivered.toLocaleString()} - ${totalDeduction.toLocaleString()} + ${totalMonthly.toLocaleString()}) ÷ 30 = ${calculatedAmount.toLocaleString()}</strong></td>`;
                tableHTML += '</tr>';

                tableHTML += '</tbody></table>';
            } else if (type === 'actualHW' || type === 'actualLic') {
                // Actual HW / License 明細（依 Region + Month，並用與 processActual 相同邏輯分類與拆分）
                const yearMonth = `2026${String(monthIndex + 1).padStart(2, '0')}`;

                // 優先使用 processActual 已寫回的拆分金額（避免明細重算與長條圖不一致）
                const getActualAmountUSD = (row) => {
                    if (typeof row['_actual_license_usd'] === 'number' && typeof row['_actual_hw_usd'] === 'number') {
                        return (type === 'actualHW') ? row['_actual_hw_usd'] : row['_actual_license_usd'];
                    }
                    // Fallback：若使用者只上傳 Actual 檔但尚未跑過 processActual，才用 AMOUNT_USD 當作保底
                    return parseFloat(row['AMOUNT_USD'] || row['AMOUNT (USD)'] || 0);
                };

                const filteredData = (rawData.actual || []).filter(row => {
                    const rowRegion = (row['Region'] || row['REGION'] || '').toString().trim();
                    if (rowRegion !== region) return false;
                    const rowYearMonth = (row['YEAR/MONTH'] || '').toString().trim();
                    return rowYearMonth === yearMonth;
                });

                const rows = [];
                filteredData.forEach(row => {
                    const amtUSD = getActualAmountUSD(row);
                    if (!amtUSD || Math.abs(amtUSD) < 1e-9) return;
                    rows.push({ row, amtUSD });
                });

                // 依金額排序
                rows.sort((a, b) => (b.amtUSD - a.amtUSD));

                tableHTML = '<table class="detail-table"><thead><tr>';
                tableHTML += '<th>MATERIAL</th><th>Model</th><th>BILLING QTY</th><th>Customer Name</th><th>AMOUNT (USD, K)</th>';
                tableHTML += '</tr></thead><tbody>';

                let totalUSD = 0;
                rows.forEach(({ row, amtUSD }) => {
                    const material = row['MATERIAL'] || '';
                    const model = (materialReferenceData && materialReferenceData[material] && materialReferenceData[material].model)
                        ? materialReferenceData[material].model
                        : '-';
                    const billingQty = row['BILLING QTY'] || '';
                    const customerName = row['Customer Name'] || row['CUSTOMER NAME'] || '';
                    const kExact = (amtUSD / 1000);
                    const kRounded = Math.round(kExact);
                    const kDisplay = kExact.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    totalUSD += amtUSD;

                    tableHTML += '<tr>';
                    tableHTML += `<td>${material}</td>`;
                    tableHTML += `<td>${model}</td>`;
                    tableHTML += `<td>${billingQty}</td>`;
                    tableHTML += `<td>${customerName}</td>`;
                    tableHTML += `<td>${kDisplay}</td>`;
                    tableHTML += '</tr>';
                });

                const totalKExact = (totalUSD / 1000);
                const totalK = Math.round(totalKExact);

                // 顯示總計（用處理後 processedData 讓使用者對得上長條圖）
                const processedTotal = Math.round((processedData[region][monthIndex] && (type === 'actualHW'
                    ? (processedData[region][monthIndex].actualHW || 0)
                    : (processedData[region][monthIndex].actualLicense || 0))) || 0);

                tableHTML += '<tr style="background-color: #f3f4f6; font-weight: bold;">';
                tableHTML += '<td colspan="4" style="text-align: right;">Total（明細加總 / 長條圖）：</td>';
                tableHTML += `<td><strong>${totalK.toLocaleString()} / ${processedTotal.toLocaleString()}</strong><br><span style="font-weight: normal; color: #6b7280;">(明細精確加總: ${totalKExact.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })})</span></td>`;
                tableHTML += '</tr>';

                tableHTML += '</tbody></table>';
            }

            document.getElementById('detailContent').innerHTML = tableHTML;
            document.getElementById('detailModal').classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Process functions
        async function processOpenPO(file) {
            const data = await readExcelFile(file);
            
            const monthlyData = {
                TW: Array(12).fill(0).map(() => ({ undelivered: 0, deduction: 0, monthly: 0 })),
                ANZ: Array(12).fill(0).map(() => ({ undelivered: 0, deduction: 0, monthly: 0 })),
                EU: Array(12).fill(0).map(() => ({ undelivered: 0, deduction: 0, monthly: 0 })),
                VJP: Array(12).fill(0).map(() => ({ undelivered: 0, deduction: 0, monthly: 0 })),
                DEJ: Array(12).fill(0).map(() => ({ undelivered: 0, deduction: 0, monthly: 0 }))
            };

            // 第一步：為每行數據添加 Region 和 Month 欄位
            data.forEach((row, index) => {
                const processed = processOpenPORow(row, index);
                
                // 添加 Region 欄位
                if (processed.region) {
                    row['Region'] = processed.region;
                }
                
                // 添加 Month 欄位（從交貨日期提取）
                if (processed.deliveryMonth !== null) {
                    row['Month'] = (processed.deliveryMonth + 1) + '月';
                }
                
                // 添加 Value 欄位（本國未交金額）
                if (!row['Value']) {
                    row['Value'] = parseFloat(row['本國未交金額'] || row['本国未交金额'] || 0);
                }
                
                // 計算月度數據
                if (processed.region && processed.deliveryMonth !== null) {
                    const monthIndex = processed.deliveryMonth;
                    const originalUndelivered = parseFloat(row['本國未交金額'] || row['本国未交金额'] || 0);
                    
                    monthlyData[processed.region][monthIndex].undelivered += originalUndelivered;
                    monthlyData[processed.region][monthIndex].deduction += processed.扣除 || 0;
                    monthlyData[processed.region][monthIndex].monthly += processed.逐月 || 0;
                }
            });
            
            // 設置全局 rawData
            rawData.openpo = data;
            console.log('✓ Open PO 原始數據已設置，包含 Region 和 Month 欄位');

            const result = { TW: [], ANZ: [], EU: [], VJP: [], DEJ: [] };
            ['TW', 'ANZ', 'EU', 'VJP', 'DEJ'].forEach(region => {
                monthlyData[region].forEach(data => {
                    const amount = (data.undelivered - data.deduction + data.monthly) / 30;
                    result[region].push(Math.round(amount));
                });
            });

            return result;
        }

        function processOpenPORow(row, index) {
            let region = null;
            const description = row['Description'] || row['Sales Organization'] || '';
            const customerName = row['客戶名稱'] || row['Customer'] || '';
            const materialNo = row['物料號碼'] || row['APR Material'] || '';
            const materialDesc = row['物料說明'] || row['Master Data'] || '';
            const undeliveredAmount = parseFloat(row['本國未交金額'] || 0);
            const orderQty = parseFloat(row['訂購數量'] || row['確認數量'] || 0);
            const deliveryDate = row['請求交貨日期'] || '';

            if (description.includes('歐非')) region = 'EU';
            else if (description.includes('亞太') && customerName.includes('DELTA')) region = 'TW';
            else if (description.includes('拉美')) region = 'TW';
            else if (description.includes('亞太') && 
                     (customerName.includes('SECUSAFE') || customerName.includes('VIDEO SECURITY') || 
                      customerName.includes('SENSATEK'))) region = 'ANZ';
            // 新增：DEJ（日本業務部，且客戶為 DELTA ELECTRONICS (J...）
            else if (description.includes('日本業務部') && customerName.includes('DELTA ELECTRONICS (J')) region = 'DEJ';
            else if (description.includes('日本') && customerName.includes('DX ANTENNA')) region = 'VJP';

            if (!region) return { region: null, 扣除: 0, 逐月: 0, deliveryMonth: null };

            let deduction = 0, monthly = 0, years = 1;
            const yearMatch = materialDesc.match(/(\d+)[-\s]?Y(?:EAR|R|L)?/i);
            if (yearMatch) years = parseInt(yearMatch[1]);

            if (materialNo.startsWith('VIO718')) {
                deduction = undeliveredAmount;
                if (yearMatch) monthly = deduction / (years * 12);
            } else if (materialNo.startsWith('VIO100')) {
                if (yearMatch) {
                    deduction = orderQty * 1200;
                    monthly = deduction / (years * 12);
                }
            }

            let deliveryMonth = null;
            const dateStr = deliveryDate.toString();
            
            if (/^\d+$/.test(dateStr) && parseInt(dateStr) > 1000) {
                const excelDate = parseInt(dateStr);
                const excelEpoch = new Date(1899, 11, 30);
                const jsDate = new Date(excelEpoch.getTime() + excelDate * 86400000);
                deliveryMonth = jsDate.getMonth();
            } else {
                let dateMatch = dateStr.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
                if (dateMatch) {
                    const first = parseInt(dateMatch[1]);
                    const third = parseInt(dateMatch[3]);
                    if (third <= 99) deliveryMonth = first - 1;
                    else if (third >= 2000) deliveryMonth = first > 12 ? parseInt(dateMatch[2]) - 1 : first - 1;
                }
            }

            if (deliveryMonth < 0 || deliveryMonth >= 12) deliveryMonth = null;

            return { region, 扣除: deduction, 逐月: monthly, deliveryMonth };
        }

        async function processBudget(file) {
            const data = await readExcelFile(file);
            rawData.budget = data;
            
            console.log('\n=== Budget 處理開始 ===');
            console.log('總行數:', data.length);
            
            const result = { TW: Array(12).fill(0), VU: Array(12).fill(0), DEJ: Array(12).fill(0), 
                           VJP: Array(12).fill(0), MN: Array(12).fill(0), ANZ: Array(12).fill(0), EU: Array(12).fill(0) };
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            data.forEach((row, index) => {
                const region = row['USD$K'] || row['Region'] || row['区域'] || '';
                
                if (index < 10) {
                    console.log(`第 ${index + 1} 行:`, {
                        'USD$K': row['USD$K'],
                        'Region': row['Region'],
                        'Jan': row['Jan'],
                        'Feb': row['Feb']
                    });
                }
                
                if (['TW', 'VU', 'DEJ', 'VJP', 'MN', 'ANZ', 'EU'].includes(region)) {
                    months.forEach((month, i) => {
                        const value = parseFloat(row[month]) || 0;
                        result[region][i] = (value === null || value === undefined || value === '' || isNaN(value)) ? 0 : Number(value);
                    });
                    
                    console.log(`${region} 數據:`, result[region]);
                }
            });
            
            console.log('\n=== Budget 處理結果 ===');
            Object.keys(result).forEach(region => {
                const total = result[region].reduce((a, b) => a + b, 0);
                console.log(`${region} 總計: ${total}`);
            });
            
            return result;
        }

        async function processRolling(file) {
            const data = await readExcelFile(file);
            rawData.rolling = data;
            const result = { MN: Array(12).fill(0), DEJ: Array(12).fill(0), VU: Array(12).fill(0), 
                           VJP: Array(12).fill(0), TW: Array(12).fill(0), ANZ: Array(12).fill(0), EU: Array(12).fill(0) };

            data.forEach(row => {
                const regionPF = (row['REGION_PF'] || '').trim();
                const customerName = (row['Customer Name'] || '').trim();
                const yearMonth = (row['YEAR/MONTH'] || '').toString().trim();
                
                let amount = 0;
                const amountRaw = row['AMOUNT_USD'];
                if (typeof amountRaw === 'number') amount = amountRaw;
                else if (typeof amountRaw === 'string') {
                    amount = parseFloat(amountRaw.replace(/[^\d.-]/g, '')) || 0;
                }

                const monthIndex = getMonthIndexFromYearMonth(yearMonth);
                if (monthIndex === -1) return;

                if (regionPF === 'MCAN-CASC') result.MN[monthIndex] += amount;
                else if (regionPF === 'DEJ-SSS') result.DEJ[monthIndex] += amount;
                else if (regionPF === 'VUS-VIP') result.VU[monthIndex] += amount;
                else if ((regionPF === 'VTW-VIP' || regionPF === 'VTW-VSWSO') && 
                         customerName.includes('TAKEBISHI')) result.VJP[monthIndex] += amount;
                else if ((regionPF === 'VTW-VIP' || regionPF === 'VTW-VSWSO') && 
                         ['TW-BAS', 'SEEDTEK', 'TOTAL TECHNOLOGY', 'ZERO ONE', 'GOOD WILL', 'RAH INFOTECH']
                         .some(c => customerName.toUpperCase().includes(c.toUpperCase()))) result.TW[monthIndex] += amount;
                else if ((regionPF === 'VTW-VIP' || regionPF === 'VTW-VSWSO') && 
                         ['VSP', 'SECUSAFE', 'CLEAR DIGITAL']
                         .some(c => customerName.toUpperCase().includes(c.toUpperCase()))) result.ANZ[monthIndex] += amount;
                else if ((regionPF === 'VTW-VIP' || regionPF === 'VTW-VSWSO') && 
                         ['ATKM', 'TEB', 'KAMTEK']
                         .some(c => customerName.toUpperCase().includes(c.toUpperCase()))) result.EU[monthIndex] += amount;
            });

            Object.keys(result).forEach(region => {
                result[region] = result[region].map(v => Math.round(v));
            });

            return result;
        }

        async function processActual(file) {
            try {
                const data = await readExcelFile(file);
                
                console.log('=== Actual 處理開始 ===');
                console.log('總行數:', data.length);
                if (data.length > 0) console.log('Sample row:', data[0]);
                
                // EU 國家清單
                const EU_List = ['AT','BE','BG','HR','CY','CZ','DK','EE','FI','FR','DE','GR','HU','IE',
                               'IT','LV','LT','LU','MT','NL','PL','PT','RO','SK','SI','ES','SE','GB','UK'];
                
            // 第一步：為每行數據添加 Region 和 Month 欄位
            console.log('步驟 1: 設置 Region 和 Month 欄位...');
            data.forEach(row => {
                const regionPF = (row['REGION_PF'] || '').toString().trim();
                const coun = (row['COUN'] || row['COUNTRY'] || row['Country'] || '').toString().trim().toUpperCase();
                const customerName = (row['Customer Name'] || row['CUSTOMER NAME'] || '').toString().trim().toLowerCase();
                
                // 優先從 YEAR/MONTH 提取月份（與 MTD 計算邏輯一致）
                const yearMonth = (row['YEAR/MONTH'] || '').toString().trim();
                if (yearMonth.length === 6) {
                    const month = parseInt(yearMonth.substring(4, 6));
                    row['Month'] = month + '月';
                } else if (row['Posting Period']) {
                    // 如果沒有 YEAR/MONTH，嘗試從 Posting Period 獲取
                    try {
                        const postingDate = new Date(row['Posting Period']);
                        if (!isNaN(postingDate.getTime())) {
                            row['Month'] = (postingDate.getMonth() + 1) + '月';
                        }
                    } catch (e) {
                        // 解析失敗，跳過
                    }
                }
                
                // 使用與 MTD 計算相同的 GeoGroup 邏輯判斷 Region
                let geoGroup = 'OTHER';
                if (regionPF.startsWith('DEJ')) {
                    geoGroup = 'JP';
                } else if (regionPF.startsWith('VUS')) {
                    geoGroup = 'US';
                } else if (regionPF.startsWith('VTW')) {
                    // VTW-VIP / VTW-VSWSS + JP => VTW-VJP
                    if (['VTW-VIP', 'VTW-VSWSS'].includes(regionPF) && coun === 'JP') {
                        geoGroup = 'VTW-VJP';
                    }
                    // 特定客戶名稱 => VTW-VJP
                    else if (customerName.includes('ibis') || customerName.includes('dx antenna') || customerName.includes('takebishi')) {
                        geoGroup = 'VTW-VJP';
                    }
                    // AU/NZ => VTW-AU
                    else if (['AU', 'NZ'].includes(coun)) {
                        geoGroup = 'VTW-AU';
                    }
                    // EU 國家 => VTW-EU
                    else if (EU_List.includes(coun)) {
                        geoGroup = 'VTW-EU';
                    }
                    // 其他 VTW => VTW-MEA+TW
                    else {
                        geoGroup = 'VTW-MEA+TW';
                    }
                } else {
                    geoGroup = 'OTHER';
                }
                
                // GeoGroup 到 Region 的映射
                const geoGroupToRegion = {
                    'JP': 'DEJ',
                    'US': 'VU',
                    'VTW-AU': 'ANZ',
                    'VTW-EU': 'EU',
                    'VTW-MEA+TW': 'TW',
                    'VTW-VJP': 'VJP',
                    'OTHER': 'MN'
                };
                
                row['Region'] = geoGroupToRegion[geoGroup] || 'MN';
            });
            console.log('✓ 步驟 1 完成: Region 和 Month 欄位已設置');
            
            // 黑名單過濾（在設置 rawData 之前）
            console.log('步驟 2: 應用黑名單過濾...');
            const rpfBlacklist = ['DEJ-SSS','TW-SSS','VTW-VACC','VTW-VIPSYN','VTW-VOC','VTW-VSWSO',
                                'VTW-VSWSS','VTW-VIP','VUS-VACC','VUS-VIP','VUS-VIPSYN','VUS-VOC',
                                'VUS-VSWSO','VUS-VSWSS','MCAN-CASC','MUS-CASC','MPL-CASC'];
            const removeAccounts = ['0042521000', '0042521001'];
            
            const filteredData = data.filter(row => {
                const rpfBuy = (row['RPF Buy'] || row['RPF_BUY'] || '').toString().trim();
                const account = (row['ACCOUNT'] || row['Account'] || '').toString().trim().padStart(10, '0');
                return !rpfBlacklist.includes(rpfBuy) && !removeAccounts.includes(account);
            });
            console.log(`✓ 步驟 2 完成: 過濾前 ${data.length} 筆 → 過濾後 ${filteredData.length} 筆`);
            
            // 設置全局 rawData（使用過濾後的數據）
            rawData.actual = filteredData;
            console.log('✓ Actual 原始數據已設置（過濾後），包含 Region 和 Month 欄位');
            console.log(`   原始數據: ${data.length} 筆 → 過濾後: ${filteredData.length} 筆`);
            
            // 結果按區域和月份組織
            const result = {
                TW: Array(12).fill(0).map(() => ({ hardware: 0, license: 0 })),
                ANZ: Array(12).fill(0).map(() => ({ hardware: 0, license: 0 })),
                EU: Array(12).fill(0).map(() => ({ hardware: 0, license: 0 })),
                VJP: Array(12).fill(0).map(() => ({ hardware: 0, license: 0 })),
                MN: Array(12).fill(0).map(() => ({ hardware: 0, license: 0 })),
                DEJ: Array(12).fill(0).map(() => ({ hardware: 0, license: 0 })),
                VU: Array(12).fill(0).map(() => ({ hardware: 0, license: 0 }))
            };
            
            // GeoGroup 到 Region 的映射
            const geoGroupToRegion = {
                'JP': 'DEJ',
                'US': 'VU',
                'VTW-AU': 'ANZ',
                'VTW-EU': 'EU',
                'VTW-MEA+TW': 'TW',
                'VTW-VJP': 'VJP',
                'OTHER': 'MN'
            };
            
            // 處理每一行數據（使用過濾後的數據）
            console.log('步驟 3: 開始 MTD 計算...');
            filteredData.forEach(row => {
                // 欄位標準化和清理
                const regionPF = (row['REGION_PF'] || row['REGION'] || row['Region'] || '').toString().trim();
                const coun = (row['COUN'] || row['COUNTRY'] || row['Country'] || '').toString().trim().toUpperCase();
                const customerName = (row['Customer Name'] || row['CUSTOMER NAME'] || '').toString().trim().toLowerCase();
                const account = (row['ACCOUNT'] || row['Account'] || '').toString().trim().padStart(10, '0');
                const material = (row['MATERIAL'] || row['Material'] || '').toString().trim();
                const materialDesc = (row['MATERIAL DESCRIPTION'] || row['Material Description'] || '').toString().trim();
                const billingQty = parseFloat(row['BILLING QTY'] || row['Billing Qty'] || 0);
                const amountUSD = parseFloat(row['AMOUNT_USD'] || row['AMOUNT (USD)'] || 0);
                
                // 獲取月份 (假設有 YEAR/MONTH 欄位，格式為 YYYYMM)
                const yearMonth = (row['YEAR/MONTH'] || '').toString().trim();
                let monthIndex = -1;
                if (yearMonth.length === 6) {
                    monthIndex = parseInt(yearMonth.substring(4, 6)) - 1; // 202601 -> 0 (Jan)
                }
                if (monthIndex < 0 || monthIndex > 11) return; // 跳過無效月份
                
                
                // ========== GeoGroup 判斷（完全按照 Power Query 邏輯）==========
                let geoGroup = 'OTHER';
                if (regionPF.startsWith('DEJ')) {
                    geoGroup = 'JP';
                } else if (regionPF.startsWith('VUS')) {
                    geoGroup = 'US';
                } else if (regionPF.startsWith('VTW')) {
                    // VTW-VIP / VTW-VSWSS + JP => VTW-VJP
                    if (['VTW-VIP', 'VTW-VSWSS'].includes(regionPF) && coun === 'JP') {
                        geoGroup = 'VTW-VJP';
                    }
                    // 特定客戶名稱 => VTW-VJP
                    else if (customerName.includes('ibis') || customerName.includes('dx antenna') || customerName.includes('takebishi')) {
                        geoGroup = 'VTW-VJP';
                    }
                    // AU/NZ => VTW-AU
                    else if (['AU', 'NZ'].includes(coun)) {
                        geoGroup = 'VTW-AU';
                    }
                    // EU 國家 => VTW-EU
                    else if (EU_List.includes(coun)) {
                        geoGroup = 'VTW-EU';
                    }
                    // 其他 VTW => VTW-MEA+TW
                    else {
                        geoGroup = 'VTW-MEA+TW';
                    }
                } else {
                    geoGroup = 'OTHER';
                }
                
                // 映射到區域
                const region = geoGroupToRegion[geoGroup] || 'MN';
                
                // ========== Type 判斷（完全按照 Power Query）==========
                let type = 'Other';
                const hwList = ['0041110000','0041115000','0041110080','0041180000','0041190000','0041170000'];
                
                // License 判斷
                if (['0042341000', '0042320000'].includes(account)) {
                    type = 'License';
                } 
                // VUS-VIP/VSWSS + VIO715 開頭
                else if ((regionPF === 'VUS-VIP' || regionPF === 'VUS-VSWSS') && material && material.startsWith('VIO715')) {
                    type = 'License';
                } 
                // DEJ-SSS + VIO718 開頭（檢查 null）
                else if (regionPF === 'DEJ-SSS' && materialDesc && materialDesc.startsWith('VIO718')) {
                    type = 'License';
                }
                // Hardware 判斷
                else if (hwList.includes(account)) {
                    type = 'Hardware';
                }
                // 其他保持 'Other'
                
                // ========== DEJ 特殊拆分（完全按照 Power Query）==========
                const specialMats = ['VIO100000457','VIO100000464','VIO100000465','VIO100000320','VIO100000323',
                                   'VIO100000456','VIO100000463','VIO100000481','VIO100000479','VIO100000364',
                                   'VIO100000365','VIO100000480','VIO100000483','VIO100000484','VIO100000487',
                                   'VIO100000488','VIO100000485','VIO100000492','VIO100000486','VIO100000490',
                                   'VIO100000491','VIO100000450'];
                
                const isDEJSpecial = regionPF === 'DEJ-SSS' && (
                    specialMats.includes(material) ||
                    (['0041110080','0041190000','0041180000','0041110000'].includes(account) && materialDesc.includes('1Y'))
                );
                
                // 計算拆分金額
                const licenseSplit = isDEJSpecial ? (billingQty * 40) : 0;
                const hardwareSplit = isDEJSpecial ? (amountUSD - licenseSplit) : 0;
                
                // ========== 最終金額計算（完全按照 Power Query）==========
                let licenseAmount = 0;
                let hardwareAmount = 0;
                
                if (isDEJSpecial) {
                    licenseAmount = licenseSplit;
                    hardwareAmount = hardwareSplit;
                } else if (type === 'License') {
                    licenseAmount = amountUSD;
                    hardwareAmount = 0;
                } else if (type === 'Hardware') {
                    licenseAmount = 0;
                    hardwareAmount = amountUSD;
                } else {
                    // type === 'Other'
                    licenseAmount = 0;
                    hardwareAmount = 0;
                }

                // 將拆分後金額寫回 row，供明細視窗使用（避免重算導致與長條圖不一致）
                // 單位：USD
                row['_actual_license_usd'] = licenseAmount;
                row['_actual_hw_usd'] = hardwareAmount;
                row['_actual_type'] = type;
                row['_actual_isDEJ_special'] = isDEJSpecial;
                
                // 累加到對應的區域和月份
                result[region][monthIndex].hardware += hardwareAmount;
                result[region][monthIndex].license += licenseAmount;
            });
            console.log('✓ 步驟 3 完成: MTD 計算完成');
            
            // 四捨五入並轉換為千元
            console.log('步驟 4: 四捨五入並轉換為千元...');
            Object.keys(result).forEach(region => {
                result[region] = result[region].map(m => ({
                    hardware: Math.round(m.hardware / 1000),
                    license: Math.round(m.license / 1000)
                }));
            });
            console.log('✓ 步驟 4 完成: 數據格式化完成');
            
            console.log('=== Actual 處理結果 ===');
            console.log(result);
            console.log('=== Actual 處理成功完成 ===');
            
            return result;
            
            } catch (error) {
                console.error('Actual 處理過程中發生錯誤:', error);
                console.error('錯誤堆疊:', error.stack);
                throw error; // 重新拋出錯誤以便上層處理
            }
        }

        async function processMaterialReference(file) {
            console.log('=== 物料參考資料處理開始 ===');
            
            try {
                const data = await readExcelFile(file);
                
                // 將資料轉換為以 P/N 為 key 的 Map
                const refMap = {};
                data.forEach(row => {
                    const pn = (row['P/N'] || '').toString().trim();
                    if (pn) {
                        refMap[pn] = {
                            model: row['Model'] || '',
                            eol: row['EOL'] || '',
                            slowMoving: row['Slow moving'] || '',
                            sales2025: row['2025 銷售量'] || 0,
                            openPO: row['Open PO'] || 0,
                            eolPlan: row['EOL計劃'] || ''
                        };
                    }
                });
                
                console.log('物料參考資料讀取完成，共', Object.keys(refMap).length, '筆');
                return refMap;
            } catch (error) {
                console.error('處理物料參考資料時發生錯誤:', error);
                throw error;
            }
        }

        async function processMaterial2025(file) {
            console.log('=== 2025_0105 處理開始 ===');
            console.log('檔案大小:', (file.size / 1024 / 1024).toFixed(2), 'MB');
            
            // 允許的物料清單（白名單）
            const allowedMaterials = new Set([
                'VIO100000021','VIO100000159','VIO100000160','VIO100000161','VIO100000162','VIO100000163',
                'VIO100000164','VIO100000165','VIO100000166','VIO100000167','VIO100000168','VIO100000169',
                'VIO100000170','VIO100000171','VIO100000172','VIO100000308','VIO100000310','VIO100000320',
                'VIO100000323','VIO100000362','VIO100000363','VIO100000364','VIO100000365','VIO100000448',
                'VIO100000450','VIO100000451','VIO100000452','VIO100000453','VIO100000454','VIO100000455',
                'VIO100000456','VIO100000457','VIO100000461','VIO100000462','VIO100000463','VIO100000464',
                'VIO100000465','VIO100000466','VIO100000467','VIO100000470','VIO100000471','VIO100000479',
                'VIO100000480','VIO100000481','VIO100000482','VIO100000483','VIO100000484','VIO100000485',
                'VIO100000486','VIO100000487','VIO100000488','VIO100000489','VIO100000490','VIO100000491',
                'VIO100000492','VIO100B05800','VIO100B06000','VIO100B06100','VIO100B06200','VIO100B06300',
                'VIO100B06400','VIO100B06500','VIO100B06600','VIO100B06700','VIO100B07600','VIO100B07700',
                'VIO100B07800'
            ]);
            
            // EU 國家清單（29個國家）
            const EU_List = ['AT','BE','BG','CY','CZ','DE','DK','EE','ES','FI','FR','GB','GR','HR',
                           'HU','IE','IT','LT','LU','LV','MT','NL','NO','PL','PT','RO','SE','SI','SK'];
            
            // MEA+TW 國家清單（26個國家）
            const MEA_TW_List = ['AE','AR','CO','GH','MN','MX','PY','SA','QA','KW','BH','IS','ZA',
                               'NG','KE','MA','DZ','TN','IL','JO','LB','PK','BD','IR','TW','US'];
            
            // GeoGroup 到 Region 的映射
            const geoGroupToRegion = {
                'JP': 'DEJ',
                'US': 'VU',
                'VTW-AU': 'ANZ',
                'VTW-EU': 'EU',
                'VTW-MEA+TW': 'TW',
                'VTW-VJP': 'VJP',
                'OTHER': 'MN'
            };
            
            try {
                const data = await readExcelFile(file);
                rawData.material2025 = data;
                
                console.log('Excel 讀取完成，總行數:', data.length);
                console.log('物料白名單數量:', allowedMaterials.size);
                if (data.length > 0) console.log('Sample row:', data[0]);
                
                // 按 Region (TW/ANZ/EU...) 分組
                const groupedByRegion = {};
                let processedCount = 0;
                let skippedCount = 0;
                let filteredByWhitelist = 0;
                
                data.forEach((row, index) => {
                    const regionPF = (row['REGION_PF'] || '').toString().trim();
                    const coun = (row['COUN'] || row['COUNTRY'] || row['Country'] || '').toString().trim().toUpperCase();
                    const customerName = (row['Customer Name'] || row['CUSTOMER NAME'] || '').toString().trim().toLowerCase();
                    const material = (row['MATERIAL'] || '').toString().trim();
                    const materialDesc = (row['MATERIAL DESCRIPTION'] || '').toString().trim();
                    const billingQty = parseFloat(row['BILLING QTY'] || 0);
                    
                    if (!regionPF || !material) {
                        skippedCount++;
                        return; // 跳過空行
                    }
                    
                    // 檢查是否在白名單中
                    if (!allowedMaterials.has(material)) {
                        filteredByWhitelist++;
                        return; // 不在白名單中，跳過
                    }
                    
                    // 判斷 GeoGroup
                    let geoGroup = 'OTHER';
                    if (regionPF.startsWith('DEJ')) {
                        geoGroup = 'JP';
                    } else if (regionPF.startsWith('VUS')) {
                        geoGroup = 'US';
                    } else if (regionPF.startsWith('VTW')) {
                        if (['VTW-VIP', 'VTW-VSWSS'].includes(regionPF) && coun === 'JP') {
                            geoGroup = 'VTW-VJP';
                        } else if (customerName.includes('ibis') || customerName.includes('dx antenna') || customerName.includes('takebishi')) {
                            geoGroup = 'VTW-VJP';
                        } else if (['AU', 'NZ'].includes(coun)) {
                            geoGroup = 'VTW-AU';
                        } else if (EU_List.includes(coun)) {
                            geoGroup = 'VTW-EU';
                        } else {
                            geoGroup = 'VTW-MEA+TW';
                        }
                    }
                    
                    // 映射到區域 (TW, ANZ, EU, VJP, MN, DEJ, VU)
                    const region = geoGroupToRegion[geoGroup] || 'MN';
                    
                    if (!groupedByRegion[region]) {
                        groupedByRegion[region] = [];
                    }
                    
                    // 檢查是否已存在相同的 MATERIAL
                    const existing = groupedByRegion[region].find(item => item.material === material);
                    if (existing) {
                        // 累加數量
                        existing.billingQty += billingQty;
                    } else {
                        // 新增
                        groupedByRegion[region].push({
                            material,
                            materialDesc,
                            billingQty
                        });
                    }
                    processedCount++;
                    
                    // 每處理1000行顯示進度
                    if (processedCount % 1000 === 0) {
                        console.log(`已處理 ${processedCount} 行...`);
                    }
                });
                
                console.log('=== 2025_0105 處理結果 ===');
                console.log('已處理行數:', processedCount);
                console.log('跳過空行數:', skippedCount);
                console.log('白名單過濾數:', filteredByWhitelist);
                console.log('區域數量:', Object.keys(groupedByRegion).length);
                Object.keys(groupedByRegion).forEach(region => {
                    const totalQty = groupedByRegion[region].reduce((sum, item) => sum + item.billingQty, 0);
                    console.log(`  ${region}: ${groupedByRegion[region].length} 個物料，總數量 ${totalQty.toFixed(0)}`);
                });
                
                // 如果有參考資料，合併進去
                if (materialReferenceData) {
                    console.log('正在合併物料參考資料...');
                    Object.keys(groupedByRegion).forEach(region => {
                        groupedByRegion[region].forEach(item => {
                            const ref = materialReferenceData[item.material];
                            if (ref) {
                                item.model = ref.model;
                                item.eol = ref.eol;
                                item.slowMoving = ref.slowMoving;
                                item.sales2025 = ref.sales2025;
                                item.openPO = ref.openPO;
                                item.eolPlan = ref.eolPlan;
                            }
                        });
                    });
                    console.log('物料參考資料合併完成');
                }
                
                // 合併 Open PO 訂購數量
                if (rawData.openpo && rawData.openpo.length > 0) {
                    console.log('正在計算 Open PO 訂購數量...');
                    
                    // 為每個區域的每個物料計算訂購數量
                    Object.keys(groupedByRegion).forEach(region => {
                        groupedByRegion[region].forEach(item => {
                            // 在 Open PO 數據中找到該物料在該區域的所有訂購
                            let totalOrderQty = 0;
                            
                            rawData.openpo.forEach(row => {
                                const material = (row['物料號碼'] || row['APR Material'] || '').toString().trim();
                                if (material !== item.material) return;
                                
                                const description = row['Description'] || row['Sales Organization'] || '';
                                const customerName = row['客戶名稱'] || row['Customer'] || '';
                                
                                // 判斷該 Open PO 項目屬於哪個區域
                                let itemRegion = null;
                                if (description.includes('歐非')) itemRegion = 'EU';
                                else if (description.includes('亞太') && customerName.includes('DELTA')) itemRegion = 'TW';
                                else if (description.includes('拉美')) itemRegion = 'TW';
                                else if (description.includes('亞太') && 
                                         (customerName.includes('SECUSAFE') || customerName.includes('VIDEO SECURITY') || 
                                          customerName.includes('SENSATEK'))) itemRegion = 'ANZ';
                                else if (description.includes('日本業務部') && customerName.includes('DELTA ELECTRONICS (J')) itemRegion = 'DEJ';
                                else if (description.includes('日本') && customerName.includes('DX ANTENNA')) itemRegion = 'VJP';
                                
                                // 如果區域匹配，累加訂購數量
                                if (itemRegion === region) {
                                    const orderQty = parseFloat(row['訂購數量'] || row['確認數量'] || 0);
                                    totalOrderQty += orderQty;
                                }
                            });
                            
                            // 將訂購數量添加到物料項目
                            item.openPO2026 = Math.round(totalOrderQty);
                        });
                    });
                    
                    console.log('Open PO 訂購數量計算完成');
                }
                
                return groupedByRegion;
            } catch (error) {
                console.error('處理 2025_0105 時發生錯誤:', error);
                throw error;
            }
        }

        async function processRollingDemand(file) {
            console.log('=== Rolling Demand History 處理開始 ===');
            
            try {
                const workbook = XLSX.read(await file.arrayBuffer(), { type: 'array' });
                const rollingData = {};
                
                // 處理每個工作表 (VU, ANZ, VJP_DEJ, EU, TW)
                const sheetNames = ['VU', 'ANZ', 'VJP_DEJ', 'EU', 'TW'];
                
                sheetNames.forEach(sheetName => {
                    if (!workbook.SheetNames.includes(sheetName)) {
                        console.warn(`工作表 ${sheetName} 不存在`);
                        return;
                    }
                    
                    const worksheet = workbook.Sheets[sheetName];
                    const data = XLSX.utils.sheet_to_json(worksheet);
                    
                    console.log(`${sheetName}: ${data.length} 筆資料`);
                    
                    // 將數據存入對應的區域
                    // VJP_DEJ 需要存到 VJP 和 DEJ 兩個區域
                    if (sheetName === 'VJP_DEJ') {
                        rollingData['VJP'] = {};
                        rollingData['DEJ'] = {};
                        data.forEach(row => {
                            const material = (row['material'] || '').toString().trim();
                            if (material) {
                                const demandData = {
                                    sep: parseFloat(row['Sep,2025'] || 0),
                                    oct: parseFloat(row['Oct,2025'] || 0),
                                    nov: parseFloat(row['Nov,2025'] || 0),
                                    dec: parseFloat(row['Dec,2025'] || 0)
                                };
                                rollingData['VJP'][material] = demandData;
                                rollingData['DEJ'][material] = demandData;
                            }
                        });
                    } else {
                        rollingData[sheetName] = {};
                        data.forEach(row => {
                            const material = (row['material'] || '').toString().trim();
                            if (material) {
                                rollingData[sheetName][material] = {
                                    sep: parseFloat(row['Sep,2025'] || 0),
                                    oct: parseFloat(row['Oct,2025'] || 0),
                                    nov: parseFloat(row['Nov,2025'] || 0),
                                    dec: parseFloat(row['Dec,2025'] || 0)
                                };
                            }
                        });
                    }
                });
                
                console.log('Rolling Demand History 處理完成');
                console.log('區域:', Object.keys(rollingData));
                Object.keys(rollingData).forEach(region => {
                    console.log(`  ${region}: ${Object.keys(rollingData[region]).length} 個物料`);
                });
                
                return rollingData;
            } catch (error) {
                console.error('處理 Rolling Demand History 時發生錯誤:', error);
                throw error;
            }
        }

        function integrateData(openpo, budget, rolling, actual) {
            let regions = ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'];
            regions = constrainRegions(regions);
            const integrated = {};
            regions.forEach(region => {
                integrated[region] = [];
                for (let i = 0; i < 12; i++) {
                    integrated[region].push({
                        budget: (budget[region] && budget[region][i]) || 0,
                        rolling: (rolling[region] && rolling[region][i]) || 0,
                        openpo: (openpo[region] && openpo[region][i]) || 0,
                        actualHW: (actual && actual[region] && actual[region][i] && actual[region][i].hardware) || 0,
                        actualLicense: (actual && actual[region] && actual[region][i] && actual[region][i].license) || 0
                    });
                }
            });
            return integrated;
        }

        function getMonthIndexFromYearMonth(yearMonth) {
            const match = yearMonth.toString().match(/(\d{4})(\d{2})/);
            if (!match) return -1;
            const monthNum = parseInt(match[2]);
            return monthNum >= 1 && monthNum <= 12 ? monthNum - 1 : -1;
        }

        async function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', raw: true });
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: '', raw: true });
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // 側邊欄功能
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('expanded');
        }

        function scrollToSection(sectionId) {
            if (sectionId === 'top') {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                const element = document.getElementById(sectionId);
                if (element) {
                    const offset = 80; // 頂部導航欄高度
                    const elementPosition = element.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - offset;
                    
                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                }
            }
        }

        // 監聽滾動，高亮當前區域
        window.addEventListener('scroll', function() {
            const sections = ['upload', 'integrated', 'janGap', 'salesBudget', 'material2025', 'charts', 'trends'];
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            
            let currentSection = '';
            sections.forEach(sectionId => {
                const element = document.getElementById(sectionId);
                if (element) {
                    const rect = element.getBoundingClientRect();
                    if (rect.top <= 150 && rect.bottom >= 150) {
                        currentSection = sectionId;
                    }
                }
            });
            
            sidebarItems.forEach(item => {
                item.classList.remove('active');
                const onclick = item.getAttribute('onclick');
                if (onclick && onclick.includes(currentSection)) {
                    item.classList.add('active');
                }
            });
        });

        // 篩選功能
        let currentFilters = {
            regions: ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'],
            monthRange: 'all'
        };

        function toggleFilterPanel() {
            const panel = document.getElementById('filterPanel');
            const overlay = document.getElementById('filterOverlay');
            panel.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        function applyFilters() {
            if (!processedData) return;

            // 只抓『區域』checkbox（有 value 屬性的那一組），避免把 showBudget / showRolling 等 checkbox 混進來
            const selectedRegions = Array.from(document.querySelectorAll('#filterPanel input[type="checkbox"][value]:checked'))
                .map(cb => cb.value)
                .filter(v => v);

            // 若使用者不小心全取消，預設回到全部區域
            let regions = selectedRegions.length ? selectedRegions : ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'];
            regions = constrainRegions(regions);

            // 獲取月份範圍
            const monthRange = document.getElementById('monthRangeFilter').value;

            // 更新當前篩選
            currentFilters.regions = regions;
            currentFilters.monthRange = monthRange;

            // 重新生成所有顯示
            selectedRegions = constrainRegions(selectedRegions);

            refreshDashboardWithFilters();
        }

        function refreshDashboardWithFilters() {
            const filteredData = getFilteredData();
            
            // 1. 更新表格
            displayResultsFiltered(filteredData);
            
            // 2. 更新 KPI
            updateKPICardsFiltered(filteredData);
            
            // 3. 更新 EU KPI Target Tab
            if (processedData && processedData['EU']) {
                renderEUKpiTargetTab();
            }
            
            // 4. 更新 KPI Target (Multi-Region)
            if (typeof renderKpiTargetTabMulti === 'function') {
                renderKpiTargetTabMulti();
            }
            
            // 5. 銷毀並重建圖表
            destroyAllCharts();
            
            // 6. 重新創建 Jan Gap 圖表（使用 processedData 而非 filteredData）
            createJanGapChart(processedData);
            
            // 7. 更新 Sales Result 表格
            if (actualData) {
                displayDetailedPerformance(processedData, actualData);
            }
            
            // 8. 重新創建圓餅圖
            createPieChartsFiltered(filteredData);
            
            // 9. 重新創建趨勢圖
            createStackedChartsFiltered(filteredData);
            createInteractiveTrendChartsFiltered(filteredData);
        }

        function displayResultsFiltered(data) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            let regions = currentFilters.regions;
            regions = constrainRegions(regions);

            // Helper function: 計算熱力圖等級
            function getHeatmapLevel(value, min, max) {
                if (max === min) return 0;
                const normalized = (value - min) / (max - min);
                return Math.min(5, Math.floor(normalized * 6));
            }

            // 1. 整合報表
            let html = '<thead><tr><th rowspan="2">區域</th>';
            months.forEach(month => {
                html += `<th colspan="3" class="month-header">${month}</th>`;
            });
            html += '</tr><tr>';
            months.forEach(() => {
                html += '<th class="subheader">Budget</th><th class="subheader">Rolling</th><th class="subheader">Open PO</th>';
            });
            html += '</tr></thead><tbody>';

            const totalsRaw = Array(12).fill(0).map(() => ({ budget: 0, rolling: 0, openpo: 0 }));

            regions.forEach(region => {
                html += `<tr><td>${region}</td>`;
                for (let i = 0; i < 12; i++) {
                    const d = data[region][i];
                    const budgetValue = d.budget;
                    const rollingValue = Math.round(d.rolling / 1000);
                    const openpoValue = (region === 'DEJ') ? 0 : Math.round((d.openpo || 0) / 1000);
                    
                    html += `<td>${budgetValue}</td>`;
                    html += `<td>${rollingValue}</td>`;
                    html += `<td>${openpoValue}</td>`;
                    
                    totalsRaw[i].budget += d.budget;
                    totalsRaw[i].rolling += d.rolling;
                    totalsRaw[i].openpo += (region === 'DEJ') ? 0 : (d.openpo || 0);
                }
                html += '</tr>';
            });

            html += '<tr class="total-row"><td>Total</td>';
            for (let i = 0; i < 12; i++) {
                html += `<td>${totalsRaw[i].budget}</td>`;
                html += `<td>${Math.round(totalsRaw[i].rolling / 1000)}</td>`;
                html += `<td>${Math.round(totalsRaw[i].openpo / 1000)}</td>`;
            }
            html += '</tr></tbody>';
            document.getElementById('resultTable').innerHTML = html;

            // 2. Budget 單獨表格（加入熱力圖）
            let budgetValues = [];
            regions.forEach(region => {
                for (let i = 0; i < 12; i++) {
                    const val = data[region][i].budget;
                    if (val > 0) budgetValues.push(val);
                }
            });
            const budgetMin = Math.min(...budgetValues.filter(v => v > 0));
            const budgetMax = Math.max(...budgetValues);

            let budgetHtml = '<thead><tr><th>區域</th>';
            months.forEach(month => budgetHtml += `<th>${month}</th>`);
            budgetHtml += '<th>Total</th></tr></thead><tbody>';
            
            regions.forEach(region => {
                budgetHtml += `<tr><td>${region}</td>`;
                let regionTotal = 0;
                for (let i = 0; i < 12; i++) {
                    const value = data[region][i].budget;
                    const level = value > 0 ? getHeatmapLevel(value, budgetMin, budgetMax) : 0;
                    budgetHtml += `<td class="heatmap-cell heatmap-level-${level}">${value}</td>`;
                    regionTotal += value;
                }
                budgetHtml += `<td><strong>${regionTotal}</strong></td></tr>`;
            });

            budgetHtml += '<tr class="single-total-row"><td>Total</td>';
            let grandTotal = 0;
            for (let i = 0; i < 12; i++) {
                const monthTotal = regions.reduce((sum, r) => sum + data[r][i].budget, 0);
                budgetHtml += `<td>${monthTotal}</td>`;
                grandTotal += monthTotal;
            }
            budgetHtml += `<td><strong>${grandTotal}</strong></td></tr></tbody>`;
            document.getElementById('budgetTable').innerHTML = budgetHtml;

            // 3. Rolling 單獨表格
            let rollingValues = [];
            regions.forEach(region => {
                for (let i = 0; i < 6; i++) {
                    const value = Math.round(data[region][i].rolling / 1000);
                    if (value > 0) rollingValues.push(value);
                }
            });
            const rollingMin = rollingValues.length > 0 ? Math.min(...rollingValues) : 0;
            const rollingMax = rollingValues.length > 0 ? Math.max(...rollingValues) : 0;

            let rollingHtml = '<thead><tr><th>區域</th>';
            const rollingMonths = months.slice(0, 6);
            rollingMonths.forEach(month => rollingHtml += `<th>${month}</th>`);
            rollingHtml += '<th>Total</th></tr></thead><tbody>';
            
            regions.forEach(region => {
                rollingHtml += `<tr><td>${region}</td>`;
                let regionTotal = 0;
                for (let i = 0; i < 6; i++) {
                    const value = Math.round(data[region][i].rolling / 1000);
                    const level = value > 0 ? getHeatmapLevel(value, rollingMin, rollingMax) : 0;
                    const monthName = rollingMonths[i];
                    rollingHtml += `<td class="heatmap-cell heatmap-level-${level}" 
                                       onclick="showCellDetail('rolling', '${region}', '${monthName}', ${i})"
                                       style="cursor: pointer;"
                                       title="點擊查看${monthName}月明細">${value}</td>`;
                    regionTotal += value;
                }
                rollingHtml += `<td><strong>${regionTotal}</strong></td></tr>`;
            });

            rollingHtml += '<tr class="single-total-row"><td>Total</td>';
            let rollingGrandTotal = 0;
            for (let i = 0; i < 6; i++) {
                const monthTotal = Math.round(regions.reduce((sum, r) => sum + data[r][i].rolling, 0) / 1000);
                rollingHtml += `<td>${monthTotal}</td>`;
                rollingGrandTotal += monthTotal;
            }
            rollingHtml += `<td><strong>${rollingGrandTotal}</strong></td></tr></tbody>`;
            document.getElementById('rollingTable').innerHTML = rollingHtml;

            // 4. Open PO 單獨表格
            let openpoValues = [];
            regions.forEach(region => {
                for (let i = 0; i < 12; i++) {
                    const value = (region === 'DEJ') ? 0 : Math.round((data[region][i].openpo || 0) / 1000);
                    if (value > 0) openpoValues.push(value);
                }
            });
            const openpoMin = openpoValues.length > 0 ? Math.min(...openpoValues) : 0;
            const openpoMax = openpoValues.length > 0 ? Math.max(...openpoValues) : 0;

            let openpoHtml = '<thead><tr><th>區域</th>';
            months.forEach(month => openpoHtml += `<th>${month}</th>`);
            openpoHtml += '<th>Total</th></tr></thead><tbody>';
            
            regions.forEach(region => {
                openpoHtml += `<tr><td>${region}</td>`;
                let regionTotal = 0;
                for (let i = 0; i < 12; i++) {
                    const value = (region === 'DEJ') ? 0 : Math.round((data[region][i].openpo || 0) / 1000);
                    const level = value > 0 ? getHeatmapLevel(value, openpoMin, openpoMax) : 0;
                    const monthName = months[i];
                    openpoHtml += `<td class="heatmap-cell heatmap-level-${level}" 
                                      onclick="showCellDetail('openpo', '${region}', '${monthName}', ${i})"
                                      style="cursor: pointer;"
                                      title="點擊查看${monthName}月明細">${value}</td>`;
                    regionTotal += value;
                }
                openpoHtml += `<td><strong>${regionTotal}</strong></td></tr>`;
            });

            openpoHtml += '<tr class="single-total-row"><td>Total</td>';
            let openpoGrandTotal = 0;
            for (let i = 0; i < 12; i++) {
                const monthTotal = Math.round(regions.reduce((sum, r) => sum + data[r][i].openpo, 0) / 1000);
                openpoHtml += `<td>${monthTotal}</td>`;
                openpoGrandTotal += monthTotal;
            }
            openpoHtml += `<td><strong>${openpoGrandTotal}</strong></td></tr></tbody>`;
            document.getElementById('openpoTable').innerHTML = openpoHtml;

            // 顯示 2025_0105 物料明細（不受篩選影響）
            if (material2025Data) {
                displayMaterial2025(material2025Data);
            }

            // 為表格單元格添加點擊事件
            setTimeout(() => {
                addCellClickEvents();
            }, 100);
        }

        function updateKPICardsFiltered(data) {
            let regions = currentFilters.regions;
            regions = constrainRegions(regions);
            
            let budgetTotal = 0, rollingTotal = 0, openpoTotal = 0, actualHWTotal = 0, actualLicTotal = 0;
            const regionTotals = {};
            
            regions.forEach(region => {
                const budgetSum = data[region].reduce((sum, m) => sum + m.budget, 0);
                const rollingSum = data[region].reduce((sum, m) => sum + m.rolling, 0);
                const openpoSum = data[region].reduce((sum, m) => sum + m.openpo, 0);
                const actualHWSum = data[region].reduce((sum, m) => sum + (m.actualHW || 0), 0);
                const actualLicSum = data[region].reduce((sum, m) => sum + (m.actualLicense || 0), 0);
                
                budgetTotal += budgetSum;
                rollingTotal += rollingSum;
                openpoTotal += openpoSum;
                actualHWTotal += actualHWSum;
                actualLicTotal += actualLicSum;
                
                regionTotals[region] = budgetSum;
            });

            rollingTotal = Math.round(rollingTotal / 1000);
            openpoTotal = Math.round(openpoTotal / 1000);
            actualHWTotal = Math.round(actualHWTotal);
            actualLicTotal = Math.round(actualLicTotal);

            document.getElementById('kpiBudget').textContent = budgetTotal.toLocaleString() + 'K';
            document.getElementById('kpiRolling').textContent = rollingTotal.toLocaleString() + 'K';
            document.getElementById('kpiOpenPO').textContent = openpoTotal.toLocaleString() + 'K';
            document.getElementById('kpiActualHW').textContent = actualHWTotal.toLocaleString() + 'K';
            document.getElementById('kpiActualLic').textContent = actualLicTotal.toLocaleString() + 'K';
        }

        let allCharts = [];

        function destroyAllCharts() {
            allCharts.forEach(chart => {
                if (chart) chart.destroy();
            });
            allCharts = [];
        }

        function createPieChartsFiltered(data) {
            let regions = currentFilters.regions;
            regions = constrainRegions(regions);
            
            const budgetTotals = {};
            const rollingTotals = {};
            const openpoTotals = {};
            const actualHWTotals = {};
            const actualLicTotals = {};
            
            regions.forEach(region => {
                if (data[region]) {
                    const rawTotal = data[region].reduce((sum, m) => sum + m.rolling, 0);
                    rollingTotals[region] = Math.round(rawTotal / 1000);
                    
                    budgetTotals[region] = data[region].reduce((sum, m) => sum + m.budget, 0);
                    
                    const rawOpenPO = (region === 'DEJ') ? 0 : data[region].reduce((sum, m) => sum + (m.openpo || 0), 0);
                    openpoTotals[region] = Math.round(rawOpenPO / 1000);
                    
                    // Actual HW 和 License（數據已經是千元）
                    const hwSum = data[region].reduce((sum, m) => sum + (m.actualHW || 0), 0);
                    const licSum = data[region].reduce((sum, m) => sum + (m.actualLicense || 0), 0);
                    actualHWTotals[region] = Math.round(hwSum);
                    actualLicTotals[region] = Math.round(licSum);
                }
            });

            const createPieChart = (canvasId, chartData, type) => {
                const ctx = document.getElementById(canvasId);
                const total = Object.values(chartData).reduce((a, b) => a + b, 0);
                
                const chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: regions,
                        datasets: [{
                            data: regions.map(r => chartData[r]),
                            backgroundColor: regions.map(r => regionColors[r]),
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: { 
                                position: 'right',
                                labels: {
                                    padding: 12,
                                    font: { size: 11 },
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    generateLabels: function(chart) {
                                        const chartData = chart.data;
                                        if (chartData.labels.length && chartData.datasets.length) {
                                            return chartData.labels.map((label, i) => {
                                                const value = chartData.datasets[0].data[i];
                                                return {
                                                    text: `${label}  ${value}K`,
                                                    fillStyle: chartData.datasets[0].backgroundColor[i],
                                                    hidden: false,
                                                    index: i
                                                };
                                            });
                                        }
                                        return [];
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const chartTotal = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / chartTotal) * 100).toFixed(1);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            },
                            datalabels: { display: false }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const region = regions[index];
                                showMonthlyBarChart(type, region);
                            }
                        }
                    },
                    plugins: [{
                        id: 'centerText',
                        afterDatasetsDraw: function(chart) {
                            const ctx = chart.ctx;
                            const chartArea = chart.chartArea;
                            
                            const centerX = (chartArea.left + chartArea.right) / 2;
                            const centerY = (chartArea.top + chartArea.bottom) / 2;
                            
                            ctx.save();
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            
                            const fontSize = Math.min(chartArea.right - chartArea.left, chartArea.bottom - chartArea.top) / 6;
                            ctx.font = `bold ${fontSize}px Inter, sans-serif`;
                            ctx.fillStyle = '#111827';
                            ctx.fillText(total.toLocaleString(), centerX, centerY);
                            
                            ctx.restore();
                        }
                    }]
                });
                
                allCharts.push(chart);
                return chart;
            };

            pieCharts.budget = createPieChart('budgetPieChart', budgetTotals, 'budget');
            pieCharts.rolling = createPieChart('rollingPieChart', rollingTotals, 'rolling');
            pieCharts.openpo = createPieChart('openpoPieChart', openpoTotals, 'openpo');
            pieCharts.actualHW = createPieChart('actualHWPieChart', actualHWTotals, 'actualHW');
            pieCharts.actualLic = createPieChart('actualLicPieChart', actualLicTotals, 'actualLic');

            const budgetGrandTotal = Object.values(budgetTotals).reduce((a, b) => a + b, 0);
            const rollingGrandTotal = Object.values(rollingTotals).reduce((a, b) => a + b, 0);
            const openpoGrandTotal = Object.values(openpoTotals).reduce((a, b) => a + b, 0);
            const actualHWGrandTotal = Object.values(actualHWTotals).reduce((a, b) => a + b, 0);
            const actualLicGrandTotal = Object.values(actualLicTotals).reduce((a, b) => a + b, 0);

            document.getElementById('budgetTotal').textContent = budgetGrandTotal.toLocaleString() + 'K';
            document.getElementById('rollingTotal').textContent = rollingGrandTotal.toLocaleString() + 'K';
            document.getElementById('openpoTotal').textContent = openpoGrandTotal.toLocaleString() + 'K';
            document.getElementById('actualHWTotal').textContent = actualHWGrandTotal.toLocaleString() + 'K';
            document.getElementById('actualLicTotal').textContent = actualLicGrandTotal.toLocaleString() + 'K';
        }

        function getFilteredData() {
            const filtered = {};
            const monthRanges = {
                'all': [0, 11],
                'q1': [0, 2],
                'q2': [3, 5],
                'q3': [6, 8],
                'q4': [9, 11],
                'h1': [0, 5],
                'h2': [6, 11]
            };
            
            const [startMonth, endMonth] = monthRanges[currentFilters.monthRange];
            
            // 只為選中的區域創建數據
            currentFilters.regions.forEach(region => {
                if (processedData[region]) {
                    filtered[region] = processedData[region].map((monthData, index) => {
                        // 如果月份不在範圍內，返回0
                        if (index < startMonth || index > endMonth) {
                            return { budget: 0, rolling: 0, openpo: 0, actualHW: 0, actualLicense: 0 };
                        }
                        return monthData;
                    });
                }
            });
            
            return filtered;
        }

        function createStackedChartsFiltered(data) {
            let regions = currentFilters.regions;
            regions = constrainRegions(regions);
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            // Budget 堆疊面積圖
            const budgetDatasets = regions.map(region => ({
                label: region,
                data: data[region].map(m => m.budget),
                backgroundColor: regionColors[region] + 'CC',
                borderColor: regionColors[region],
                borderWidth: 1,
                fill: true
            }));

            const budgetChart = new Chart(document.getElementById('budgetStackedChart'), {
                type: 'line',
                data: { labels: months, datasets: budgetDatasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true, pointStyle: 'circle', padding: 15 } },
                        tooltip: {
                            mode: 'index',
                            callbacks: {
                                footer: function(tooltipItems) {
                                    let sum = 0;
                                    tooltipItems.forEach(item => sum += item.parsed.y);
                                    return '總計: ' + sum.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: { stacked: true, beginAtZero: true, ticks: { callback: function(value) { return value.toLocaleString(); } } },
                        x: { stacked: true }
                    }
                }
            });
            allCharts.push(budgetChart);

            // Rolling 堆疊面積圖
            const rollingDatasets = regions.map(region => ({
                label: region,
                data: data[region].map(m => Math.round(m.rolling / 1000)),
                backgroundColor: regionColors[region] + 'CC',
                borderColor: regionColors[region],
                borderWidth: 1,
                fill: true
            }));

            const rollingChart = new Chart(document.getElementById('rollingStackedChart'), {
                type: 'line',
                data: { labels: months, datasets: rollingDatasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true, pointStyle: 'circle', padding: 15 } },
                        tooltip: {
                            mode: 'index',
                            callbacks: {
                                footer: function(tooltipItems) {
                                    let sum = 0;
                                    tooltipItems.forEach(item => sum += item.parsed.y);
                                    return '總計: ' + sum.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: { stacked: true, beginAtZero: true, ticks: { callback: function(value) { return value.toLocaleString(); } } },
                        x: { stacked: true }
                    }
                }
            });
            allCharts.push(rollingChart);

            // Open PO 堆疊面積圖
            const openpoDatasets = regions.map(region => ({
                label: region,
                data: data[region].map(m => Math.round(m.openpo / 1000)),
                backgroundColor: regionColors[region] + 'CC',
                borderColor: regionColors[region],
                borderWidth: 1,
                fill: true
            }));

            const openpoChart = new Chart(document.getElementById('openpoStackedChart'), {
                type: 'line',
                data: { labels: months, datasets: openpoDatasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true, pointStyle: 'circle', padding: 15 } },
                        tooltip: {
                            mode: 'index',
                            callbacks: {
                                footer: function(tooltipItems) {
                                    let sum = 0;
                                    tooltipItems.forEach(item => sum += item.parsed.y);
                                    return '總計: ' + sum.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: { stacked: true, beginAtZero: true, ticks: { callback: function(value) { return value.toLocaleString(); } } },
                        x: { stacked: true }
                    }
                }
            });
            allCharts.push(openpoChart);
        }

        function createInteractiveTrendChartsFiltered(data) {
            let regions = currentFilters.regions;
            regions = constrainRegions(regions);
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            // 計算各區域總量
            const budgetTotals = regions.map(region => ({
                region, total: data[region].reduce((sum, m) => sum + m.budget, 0)
            })).sort((a, b) => b.total - a.total);

            const topBudgetRegions = budgetTotals.slice(0, Math.min(3, regions.length)).map(r => r.region);

            // Budget 互動線圖
            const budgetDatasets = regions.map(region => ({
                label: region,
                data: data[region].map(m => m.budget),
                borderColor: regionColors[region],
                backgroundColor: regionColors[region] + '20',
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: regionColors[region],
                pointBorderColor: regionColors[region],
                pointBorderWidth: 2,
                hidden: !topBudgetRegions.includes(region)
            }));

            const budgetTrendChart = new Chart(document.getElementById('budgetTrendChart'), {
                type: 'line',
                data: { labels: months, datasets: budgetDatasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { usePointStyle: true, pointStyle: 'circle', padding: 15 },
                            onClick: function(e, legendItem, legend) {
                                const index = legendItem.datasetIndex;
                                const ci = legend.chart;
                                const meta = ci.getDatasetMeta(index);
                                meta.hidden = meta.hidden === null ? !ci.data.datasets[index].hidden : null;
                                ci.update();
                            }
                        },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: function(value) { return value.toLocaleString(); } } }
                    }
                }
            });
            allCharts.push(budgetTrendChart);

            // Rolling 互動線圖
            const rollingTotals = regions.map(region => ({
                region,
                total: data[region].reduce((sum, m) => sum + m.rolling, 0)
            })).sort((a, b) => b.total - a.total);
            
            const topRollingRegions = rollingTotals.slice(0, Math.min(3, regions.length)).map(r => r.region);
            
            const rollingDatasets = regions.map(region => ({
                label: region,
                data: data[region].map(m => Math.round(m.rolling / 1000)),
                borderColor: regionColors[region],
                backgroundColor: regionColors[region] + '20',
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: regionColors[region],
                pointBorderColor: regionColors[region],
                pointBorderWidth: 2,
                hidden: !topRollingRegions.includes(region)
            }));
            
            const rollingTrendChart = new Chart(document.getElementById('rollingTrendChart'), {
                type: 'line',
                data: { labels: months, datasets: rollingDatasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { usePointStyle: true, pointStyle: 'circle', padding: 15 },
                            onClick: function(e, legendItem, legend) {
                                const index = legendItem.datasetIndex;
                                const ci = legend.chart;
                                const meta = ci.getDatasetMeta(index);
                                meta.hidden = meta.hidden === null ? !ci.data.datasets[index].hidden : null;
                                ci.update();
                            }
                        },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: function(value) { return value.toLocaleString(); } } }
                    }
                }
            });
            allCharts.push(rollingTrendChart);
            
            // Open PO 互動線圖
            const openpoTotals = regions.map(region => ({
                region,
                total: data[region].reduce((sum, m) => sum + m.openpo, 0)
            })).sort((a, b) => b.total - a.total);
            
            const topOpenpoRegions = openpoTotals.slice(0, Math.min(3, regions.length)).map(r => r.region);
            
            const openpoDatasets = regions.map(region => ({
                label: region,
                data: data[region].map(m => Math.round(m.openpo / 1000)),
                borderColor: regionColors[region],
                backgroundColor: regionColors[region] + '20',
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: regionColors[region],
                pointBorderColor: regionColors[region],
                pointBorderWidth: 2,
                hidden: !topOpenpoRegions.includes(region)
            }));
            
            const openpoTrendChart = new Chart(document.getElementById('openpoTrendChart'), {
                type: 'line',
                data: { labels: months, datasets: openpoDatasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { usePointStyle: true, pointStyle: 'circle', padding: 15 },
                            onClick: function(e, legendItem, legend) {
                                const index = legendItem.datasetIndex;
                                const ci = legend.chart;
                                const meta = ci.getDatasetMeta(index);
                                meta.hidden = meta.hidden === null ? !ci.data.datasets[index].hidden : null;
                                ci.update();
                            }
                        },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: function(value) { return value.toLocaleString(); } } }
                    }
                }
            });
            allCharts.push(openpoTrendChart);
        }

        function resetFilters() {
            // 重置所有checkbox
            document.querySelectorAll('.checkbox-group input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            document.getElementById('monthRangeFilter').value = 'all';
            
            // 重置篩選並刷新（考慮區域限制）
            let allRegions = ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'];
            currentFilters.regions = constrainRegions(allRegions);
            currentFilters.monthRange = 'all';
            
            if (processedData) {
                refreshDashboardWithFilters();
            }
        }

        // 搜尋功能
        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            // 這裡可以實現搜尋邏輯
            console.log('Searching for:', searchTerm);
        }

        // 鍵盤快捷鍵 (Cmd+K 或 Ctrl+K 開啟搜尋)
        document.addEventListener('keydown', function(e) {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            // ESC 關閉選單
            if (e.key === 'Escape') {
                document.getElementById('userMenu').classList.remove('show');
            }
        });

        // 用戶選單功能
        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.classList.toggle('show');
        }

        // 點擊外部關閉選單
        document.addEventListener('click', function(e) {
            const userInfo = document.querySelector('.user-info');
            const userMenu = document.getElementById('userMenu');
            if (userInfo && userMenu && !userInfo.contains(e.target) && !userMenu.contains(e.target)) {
                userMenu.classList.remove('show');
            }
        });

        function showDataInfo() {
            if (!processedData) {
                alert('請先上傳資料檔案');
                return;
            }
            
            let regions = currentFilters.regions.length;
            regions = constrainRegions(regions);
            const months = currentFilters.monthRange === 'all' ? 12 : 
                          currentFilters.monthRange === 'q1' || currentFilters.monthRange === 'q2' || 
                          currentFilters.monthRange === 'q3' || currentFilters.monthRange === 'q4' ? 3 : 6;
            
            const info = `
📊 資料資訊

✅ 已上傳檔案：
- OPEN PO: ${uploadedFiles.openpo ? uploadedFiles.openpo.name : '未上傳'}
- Sales Budget: ${uploadedFiles.budget ? uploadedFiles.budget.name : '未上傳'}
- Rolling: ${uploadedFiles.rolling ? uploadedFiles.rolling.name : '未上傳'}

📈 當前篩選：
- 區域數量: ${regions} 個
- 月份範圍: ${months} 個月

🎯 資料狀態：
- 狀態: 已處理
- 最後更新: ${new Date().toLocaleString('zh-TW')}
            `;
            
            alert(info);
            toggleUserMenu();
        }

        function exportAllData() {
            if (!processedData) {
                alert('請先上傳資料檔案');
                return;
            }
            
            // 調用下載功能
            downloadResults();
            toggleUserMenu();
        }

        function printDashboard() {
            toggleUserMenu();
            setTimeout(() => {
                window.print();
            }, 100);
        }

        function showSettings() {
            document.getElementById('settingsModal').classList.add('show');
            toggleUserMenu();
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function saveSettings() {
            console.log('saveSettings called');
            
            // 儲存設定到 localStorage
            const settings = {
                defaultRegions: [],
                defaultMonthRange: document.getElementById('defaultMonthRange').value,
                showHeatmap: document.getElementById('showHeatmap').checked,
                autoRefresh: document.getElementById('autoRefresh').checked,
                showLegend: document.getElementById('showLegend').checked,
                numberFormat: document.getElementById('numberFormat').value,
                decimalPlaces: document.getElementById('decimalPlaces').value
            };

            // 獲取選中的區域
            ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'].forEach(region => {
                if (document.getElementById('default' + region).checked) {
                    settings.defaultRegions.push(region);
                }
            });

            console.log('Settings to save:', settings);
            
            localStorage.setItem('dashboardSettings', JSON.stringify(settings));
            
            // 立即套用設定（如果有資料的話）
            if (processedData) {
                applySettingsImmediately(settings);
                showToast('設定已儲存並套用！');
            } else {
                showToast('設定已儲存！上傳資料後會自動套用。');
            }
            
            closeSettings();
        }

        function applySettingsImmediately(settings) {
            console.log('applySettingsImmediately called with:', settings);
            
            // 檢查是否有資料
            if (!processedData) {
                console.log('No data available');
                return false;
            }
            
            // 1. 套用區域篩選（考慮區域限制）
            if (settings.defaultRegions.length > 0) {
                // 套用區域限制
                let regionsToApply = constrainRegions(settings.defaultRegions);
                
                // 更新篩選面板的 checkbox
                ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'].forEach(region => {
                    const filterCheckbox = document.querySelector(`.checkbox-group input[value="${region}"]`);
                    if (filterCheckbox) {
                        filterCheckbox.checked = regionsToApply.includes(region);
                    }
                });
                
                // 更新當前篩選
                currentFilters.regions = regionsToApply;
                currentFilters.monthRange = settings.defaultMonthRange || 'all';
                
                // 更新月份範圍下拉選單
                const monthRangeFilter = document.getElementById('monthRangeFilter');
                if (monthRangeFilter) {
                    monthRangeFilter.value = settings.defaultMonthRange || 'all';
                }
                
                // 重新生成 Dashboard
                console.log('Refreshing dashboard with filters');
                refreshDashboardWithFilters();
            }
            
            // 2. 套用顯示選項
            window.dashboardSettings = settings;
            return true;
        }

        function previewSettings() {
            console.log('previewSettings called');
            
            // 收集當前設定
            const settings = {
                defaultRegions: [],
                defaultMonthRange: document.getElementById('defaultMonthRange').value,
                showHeatmap: document.getElementById('showHeatmap').checked,
                autoRefresh: document.getElementById('autoRefresh').checked,
                showLegend: document.getElementById('showLegend').checked,
                numberFormat: document.getElementById('numberFormat').value,
                decimalPlaces: document.getElementById('decimalPlaces').value
            };

            ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'].forEach(region => {
                if (document.getElementById('default' + region).checked) {
                    settings.defaultRegions.push(region);
                }
            });

            console.log('Preview settings:', settings);

            // 檢查是否有資料
            if (!processedData) {
                showToast('請先上傳資料檔案');
                return;
            }

            // 立即套用但不儲存
            const applied = applySettingsImmediately(settings);
            
            if (applied) {
                showToast('預覽效果已套用（未儲存）');
            }
        }

        function showToast(message) {
            // 創建 toast 通知
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 顯示動畫
            setTimeout(() => toast.classList.add('show'), 10);
            
            // 3秒後移除
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function resetSettings() {
            if (confirm('確定要恢復預設設定嗎？')) {
                // 重置所有checkbox
                ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'].forEach(region => {
                    document.getElementById('default' + region).checked = true;
                });
                document.getElementById('defaultMonthRange').value = 'all';
                document.getElementById('showHeatmap').checked = true;
                document.getElementById('autoRefresh').checked = true;
                document.getElementById('showLegend').checked = true;
                document.getElementById('numberFormat').value = 'comma';
                document.getElementById('decimalPlaces').value = '0';

                localStorage.removeItem('dashboardSettings');
                alert('設定已恢復為預設值！');
            }
        }

        // 載入儲存的設定
        function loadSettings() {
            const savedSettings = localStorage.getItem('dashboardSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                
                // 套用區域設定
                ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'].forEach(region => {
                    const checkbox = document.getElementById('default' + region);
                    if (checkbox) {
                        checkbox.checked = settings.defaultRegions.includes(region);
                    }
                });

                // 套用其他設定
                if (document.getElementById('defaultMonthRange')) {
                    document.getElementById('defaultMonthRange').value = settings.defaultMonthRange || 'all';
                }
                if (document.getElementById('showHeatmap')) {
                    document.getElementById('showHeatmap').checked = settings.showHeatmap !== false;
                }
                if (document.getElementById('autoRefresh')) {
                    document.getElementById('autoRefresh').checked = settings.autoRefresh !== false;
                }
                if (document.getElementById('showLegend')) {
                    document.getElementById('showLegend').checked = settings.showLegend !== false;
                }
                if (document.getElementById('numberFormat')) {
                    document.getElementById('numberFormat').value = settings.numberFormat || 'comma';
                }
                if (document.getElementById('decimalPlaces')) {
                    document.getElementById('decimalPlaces').value = settings.decimalPlaces || '0';
                }
            }
        }

        // 頁面載入時載入設定
        document.addEventListener('DOMContentLoaded', loadSettings);

        function showHelp() {
            const helpText = `
📖 使用說明

1️⃣ 上傳檔案
- 點擊三個上傳區域上傳 Excel 檔案
- 需要：OPEN PO、Sales Budget、Rolling

2️⃣ 查看數據
- KPI 卡片：顯示總計數字
- 表格：顯示詳細月份數據
- 圓餅圖：點擊可查看區域詳情
- 趨勢圖：顯示月份變化

3️⃣ 使用篩選
- 點擊右上角「篩選」按鈕
- 選擇要查看的區域和月份
- 點擊「套用」生效

4️⃣ 側邊欄
- 點擊圖標快速跳轉到各區域
- 點擊 ☰ 展開/收合側邊欄

5️⃣ 匯出數據
- �點擊「下載報表」按鈕
- 或在用戶選單選擇「匯出全部數據」
            `;
            alert(helpText);
            toggleUserMenu();
        }

        // 顯示單元格詳細資料
        function showCellDetail(type, region, month, monthIndex) {
            // UI permission gate: only allow viewing detail for your own region (or ADMIN).
            if (!requireRegionAccess(region)) {
                return;
            }
            console.log('showCellDetail called:', { type, region, month, monthIndex });
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Sales Budget 不顯示明細
            if (type === 'budget') {
                showToast('Sales Budget 無細項明細');
                return;
            }
            
            if (!rawData || !rawData[type] || rawData[type].length === 0) {
                showToast('無詳細資料');
                console.log('No rawData available');
                return;
            }

            console.log('rawData sample:', rawData[type][0]);

            let filteredData = [];
            
            if (type === 'rolling') {
                // Rolling: 顯示 Material, Billing Qty, Customer Name, Amount (USD)
                const targetYearMonth = `2026${String(monthIndex + 1).padStart(2, '0')}`;
                
                filteredData = rawData[type].filter(row => {
                    const regionPF = (row['REGION_PF'] || '').trim();
                    const customerName = (row['Customer Name'] || '').trim();
                    const rowYearMonth = (row['YEAR/MONTH'] || '').toString().trim();
                    
                    // 先檢查月份
                    if (rowYearMonth !== targetYearMonth) return false;

                    // Apply region filters (與showDetailTable完全相同)
                    if (region === 'MN' && regionPF === 'MCAN-CASC') return true;
                    if (region === 'DEJ' && regionPF === 'DEJ-SSS') return true;
                    if (region === 'VU' && regionPF === 'VUS-VIP') return true;
                    if (region === 'VJP' && (regionPF === 'VTW-VIP' || regionPF === 'VTW-VSWSO') && 
                        customerName.includes('TAKEBISHI')) return true;
                    if (region === 'TW' && (regionPF === 'VTW-VIP' || regionPF === 'VTW-VSWSO') && 
                        ['TW-BAS', 'SEEDTEK', 'TOTAL TECHNOLOGY', 'ZERO ONE', 'GOOD WILL', 'RAH INFOTECH']
                        .some(c => customerName.toUpperCase().includes(c.toUpperCase()))) return true;
                    if (region === 'ANZ' && (regionPF === 'VTW-VIP' || regionPF === 'VTW-VSWSO') && 
                        ['VSP', 'SECUSAFE', 'CLEAR DIGITAL']
                        .some(c => customerName.toUpperCase().includes(c.toUpperCase()))) return true;
                    if (region === 'EU' && (regionPF === 'VTW-VIP' || regionPF === 'VTW-VSWSO') && 
                        ['ATKM', 'TEB', 'KAMTEK']
                        .some(c => customerName.toUpperCase().includes(c.toUpperCase()))) return true;
                    
                    return false;
                }).map(row => {
                    const material = (row['MATERIAL'] || row['APR Material'] || '').toString().trim();
                    const model = (materialReferenceData && materialReferenceData[material] && materialReferenceData[material].model)
                        ? materialReferenceData[material].model
                        : '-';
                    return {
                        'Material': material || '-',
                        'Model': model,
                        'Billing Qty': row['Billing QTY'] || row['Billing Qty'] || 0,
                        'Customer Name': row['Customer Name'] || '-',
                        'Amount (USD)': Math.round(parseFloat(row['AMOUNT_USD'] || 0) / 1000)
                    };
                }).filter(item => item['Amount (USD)'] > 0);
                
            } else if (type === 'openpo') {
                // Open PO: 使用與showDetailTable完全相同的邏輯
                if (region === 'DEJ') {
                    filteredData = [];
                } else
                filteredData = rawData[type].filter(row => {
                    const description = row['Description'] || row['Sales Organization'] || '';
                    const customerName = row['客戶名稱'] || row['Customer'] || '';
                    const deliveryDate = row['請求交貨日期'] || '';

                    // Check region (與showDetailTable完全相同)
                    let matchRegion = false;
                    if (region === 'EU' && description.includes('歐非')) matchRegion = true;
                    else if (region === 'TW' && (
                        (description.includes('亞太') && customerName.includes('DELTA')) ||
                        description.includes('拉美')
                    )) matchRegion = true;
                    else if (region === 'ANZ' && description.includes('亞太') && 
                        (customerName.includes('SECUSAFE') || customerName.includes('VIDEO SECURITY') || 
                         customerName.includes('SENSATEK'))) matchRegion = true;
                    else if (region === 'VJP' && description.includes('日本') && 
                        customerName.includes('DX ANTENNA')) matchRegion = true;
                    else if (region === 'DEJ' && description.includes('日本業務部') &&
                        customerName.includes('DELTA ELECTRONICS (J')) matchRegion = true;

                    if (!matchRegion) return false;

                    // Check month (與showDetailTable完全相同)
                    const dateStr = deliveryDate.toString();
                    let deliveryMonth = -1;

                    if (/^\d+$/.test(dateStr) && parseInt(dateStr) > 1000) {
                        const excelDate = parseInt(dateStr);
                        const excelEpoch = new Date(1899, 11, 30);
                        const jsDate = new Date(excelEpoch.getTime() + excelDate * 86400000);
                        deliveryMonth = jsDate.getMonth();
                    } else {
                        let dateMatch = dateStr.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
                        if (dateMatch) {
                            const first = parseInt(dateMatch[1]);
                            const third = parseInt(dateMatch[3]);
                            if (third <= 99) {
                                deliveryMonth = first - 1;
                            } else if (third >= 2000) {
                                deliveryMonth = first > 12 ? parseInt(dateMatch[2]) - 1 : first - 1;
                            }
                        }
                    }

                    return deliveryMonth === monthIndex;
                }).map((row, index) => {
                    // 使用 processOpenPORow 來計算扣除和逐月
                    const processed = processOpenPORow(row, index);
                    const undeliveredAmount = parseFloat(row['本國未交金額'] || row['本国未交金额'] || 0);
                    
                    return {
                        'Material': row['物料號碼'] || row['APR Material'] || '-',
                        'Material Description': row['物料說明'] || row['Master Data'] || '-',
                        'Order Qty': row['訂購數量'] || row['確認數量'] || 0,
                        'Undelivered Amount': Math.round(undeliveredAmount / 1000),
                        'Deduction': Math.round(processed.扣除 / 1000),
                        'Monthly': Math.round(processed.逐月 / 1000)
                    };
                }).filter(item => item['Undelivered Amount'] > 0);
            }

            console.log('Filtered data count:', filteredData.length);

            if (filteredData.length === 0) {
                showToast('該月份無詳細資料');
                return;
            }

            // 設置標題
            const typeNames = {
                'openpo': 'Open PO',
                'rolling': 'Rolling Forecast'
            };
            document.getElementById('detailModalTitle').textContent = 
                `${typeNames[type]} - ${region} - ${month} 明細`;

            // 生成詳細資料表格
            let html = `
                <div class="detail-info">
                    <div class="detail-info-row">
                        <span class="detail-label">區域</span>
                        <span class="detail-value">${region}</span>
                    </div>
                    <div class="detail-info-row">
                        <span class="detail-label">月份</span>
                        <span class="detail-value">${month}</span>
                    </div>
                    <div class="detail-info-row">
                        <span class="detail-label">項目數量</span>
                        <span class="detail-value">${filteredData.length} 筆</span>
                    </div>
                </div>
                <table class="detail-table">
                    <thead>
                        <tr>
            `;

            // 根據類型生成不同的表頭
            if (type === 'rolling') {
                html += `
                            <th>Material</th>
                            <th>Model</th>
                            <th>Billing Qty</th>
                            <th>Customer Name</th>
                            <th>Amount (USD)</th>
                `;
            } else if (type === 'openpo') {
                html += `
                            <th>物料號碼</th>
                            <th>物料說明</th>
                            <th>訂購數量</th>
                            <th>本國未交金額</th>
                            <th>扣除</th>
                            <th>逐月</th>
                `;
            }

            html += `
                        </tr>
                    </thead>
                    <tbody>
            `;

            // 根據類型生成不同的表格內容
            filteredData.forEach(item => {
                if (type === 'rolling') {
                    html += `
                        <tr>
                            <td>${item.Material}</td>
                            <td>${item.Model || '-'}</td>
                            <td>${Number(item['Billing Qty'] || 0).toLocaleString()}</td>
                            <td>${item['Customer Name']}</td>
                            <td><strong>${item['Amount (USD)'].toLocaleString()}</strong></td>
                        </tr>
                    `;
                } else if (type === 'openpo') {
                    html += `
                        <tr>
                            <td>${item.Material}</td>
                            <td>${item['Material Description']}</td>
                            <td>${item['Order Qty'].toLocaleString()}</td>
                            <td><strong>${item['Undelivered Amount'].toLocaleString()}</strong></td>
                            <td>${item['Deduction'].toLocaleString()}</td>
                            <td>${item['Monthly'].toLocaleString()}</td>
                        </tr>
                    `;
                }
            });

            // 為 Open PO 添加總計行和計算說明
            if (type === 'openpo') {
                let totalUndelivered = 0;
                let totalDeduction = 0;
                let totalMonthly = 0;
                
                filteredData.forEach(item => {
                    totalUndelivered += item['Undelivered Amount'];
                    totalDeduction += item['Deduction'];
                    totalMonthly += item['Monthly'];
                });
                
                const calculatedAmount = Math.round((totalUndelivered - totalDeduction + totalMonthly) / 30);
                
                html += `
                    <tr style="background-color: #f3f4f6; font-weight: bold;">
                        <td colspan="3" style="text-align: right;">總計：</td>
                        <td><strong>${totalUndelivered.toLocaleString()}</strong></td>
                        <td>${totalDeduction.toLocaleString()}</td>
                        <td>${totalMonthly.toLocaleString()}</td>
                    </tr>
                    <tr style="background-color: #fef3c7;">
                        <td colspan="3" style="text-align: right;"><strong>Open PO 計算：</strong></td>
                        <td colspan="3" style="text-align: left;">
                            <strong>(${totalUndelivered.toLocaleString()} - ${totalDeduction.toLocaleString()} + ${totalMonthly.toLocaleString()}) ÷ 30 = ${calculatedAmount.toLocaleString()}</strong>
                        </td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            document.getElementById('detailModalBody').innerHTML = html;
            document.getElementById('cellDetailModal').classList.add('show');
        }

        function closeCellDetail() {
            document.getElementById('cellDetailModal').classList.remove('show');
        }



        // ==================== UI Access Control (Front-end Only) ====================
        // Auth state stored in localStorage so it persists across refresh.
        // NOTE: This is NOT secure against users who know how to inspect browser data.
        const AUTH_STORAGE_KEY = 'dashboard_auth_v1';

        // Configure passcodes here (demo values). Replace with your real passcodes.
        // Tip: keep them short for convenience, but understand they can be discovered in the HTML.
        const REGION_PASSCODES = {
            'DEJ': 'dej123',
            'VU': 'vu123',
            'VJP': 'vjp123',
            'TW': 'tw123',
            'ANZ': 'anz123',
            'MN': 'mn123',
            'EU': 'eu123',
            'ADMIN': 'admin123'
        };

        function getAuth() {
            try {
                const raw = localStorage.getItem(AUTH_STORAGE_KEY);
                return raw ? JSON.parse(raw) : null;
            } catch {
                return null;
            }
        }

        function setAuth(auth) {
            localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(auth));
        }

        function clearAuth() {
            localStorage.removeItem(AUTH_STORAGE_KEY);
        }

        function canViewRegion(targetRegion) {
            const auth = getAuth();
            if (!auth || !auth.region) return false;
            if (auth.region === 'ADMIN') return true;
            // Normalize
            const tr = String(targetRegion || '').toUpperCase().trim();
            return tr === auth.region;
        }

        function getAuthLabel() {
            const auth = getAuth();
            if (!auth || !auth.region) return '未登入';
            const name = auth.name ? auth.name : 'User';
            return `${name}（${auth.region}）`;
        }

        function showToast(message) {
            const el = document.getElementById('noAccessToast');
            if (!el) return;
            el.textContent = message;
            el.classList.add('show');
            window.clearTimeout(window.__toastTimer);
            window.__toastTimer = window.setTimeout(() => {
                el.classList.remove('show');
            }, 2200);
        }

        function requireRegionAccess(region, onOk) {
            // Standalone report: enforce auth by default.
            // If you really need a fully open report, set window.STANDALONE_BYPASS_AUTH = true.
            if (window.IS_STANDALONE_REPORT && window.STANDALONE_BYPASS_AUTH === true) {
                if (typeof onOk === "function") onOk();
                return true;
            }
            const auth = getAuth();
            if (!auth) {
                showToast('尚未登入：請先登入後再查看明細');
                showLoginModal();
                return false;
            }
            if (!canViewRegion(region)) {
                showToast(`無權限：你目前是 ${auth.region}，不可查看 ${region} 明細`);
                return false;
            }
            if (typeof onOk === 'function') onOk();
            return true;
        }

        
        // ==================== Region-only View Mode ====================
        // If enabled, the dashboard will ONLY show the current region's data (ADMIN sees all).
        // This is UI-level access control; do not treat as security.
        window.REGION_ONLY_MODE = true;

        function getActiveRegion() {
            const auth = getAuth();
            if (!auth || !auth.region) return null;
            return String(auth.region || '').toUpperCase().trim();
        }

        function isRegionOnlyMode() {
            const r = getActiveRegion();
            if (!window.REGION_ONLY_MODE) return false;
            if (!r) return false;
            if (r === 'ADMIN') return false;
            return true;
        }

        // Returns array of regions currently allowed to be visible in charts/tables.
        function getVisibleRegions() {
            const r = getActiveRegion();
            if (!window.REGION_ONLY_MODE) return null; // null means "no restriction"
            if (!r) return null; // not logged in -> no restriction (can also choose to hide everything)
            if (r === 'ADMIN') return null;
            return [r];
        }

        function applyRegionOnlyUI() {
            const visible = getVisibleRegions();
            // If no restriction, keep existing default settings.
            if (!visible) {
                // Reset to all regions when no restriction (logged out or ADMIN)
                currentFilters.regions = ['TW', 'ANZ', 'EU', 'VJP', 'MN', 'DEJ', 'VU'];
            } else {
                // Set to only visible regions
                currentFilters.regions = visible;
            }

            // 1) Update settings defaults (checkboxes)
            const ids = ['TW','ANZ','EU','VJP','MN','DEJ','VU'];
            ids.forEach(code => {
                const cb = document.getElementById('default' + code);
                if (cb) cb.checked = currentFilters.regions.includes(code);
            });

            // 2) If filter panel has region checkboxes, force them to single selection.
            const regionCheckboxes = Array.from(document.querySelectorAll('.filter-panel input[type="checkbox"]'))
                .filter(el => (el.closest('.checkbox-group') && /^(TW|ANZ|EU|VJP|MN|DEJ|VU)$/i.test((el.value||el.id||'').replace('default','')) ) );

            // The above detection may miss because the HTML uses inline labels; fallback by label text if needed.
            // We'll just enforce by value/id if present.
            regionCheckboxes.forEach(cb => {
                const v = (cb.value || cb.id || '').toUpperCase();
                const match = ids.find(x => v.includes(x));
                if (match) {
                    cb.checked = currentFilters.regions.includes(match);
                    cb.disabled = visible ? true : false;  // Disable only in region-only mode
                }
            });

            // 3) Update topbar hint
            const badge = document.getElementById('authBadgeText');
            if (badge) {
                // keep enforceAuthUI's label but add hint
                badge.title = visible ? `Region-only mode: 只顯示 ${visible.join(', ')} 資料` : 'Viewing all regions';
            }
            
            // Note: 不在這裡自動渲染，由調用者（如 login/logout）決定是否需要渲染
        }

        // Wrap an existing region list with region-only constraint
        function constrainRegions(regions) {
            const visible = getVisibleRegions();
            if (!visible) return regions;
            if (!Array.isArray(regions)) return visible.slice();
            return regions.filter(r => visible.includes(String(r).toUpperCase().trim()));
        }

        // Filter a data array of rows by region (common columns)
        function filterRowsByRegion(rows, regionCode) {
            if (!Array.isArray(rows) || !regionCode) return rows;
            const rc = String(regionCode).toUpperCase().trim();
            return rows.filter(row => {
                const r = (row['Region'] || row['REGION'] || row['REGION_PF'] || row['region'] || '').toString().toUpperCase().trim();
                // Some datasets use REGION_PF codes; keep existing per-region rules elsewhere.
                // Here we only apply when a clean Region exists.
                if (r === rc) return true;
                // If row has no region field, keep it (avoid accidental data loss)
                if (!r) return true;
                return false;
            });
        }
        // ==================== /Region-only View Mode ====================

function enforceAuthUI() {
            // Update top badge
            const badgeText = document.getElementById('authBadgeText');
            if (badgeText) badgeText.textContent = getAuthLabel();

            // Update top-right user name/avatar
            const auth = getAuth();
            const userNameEl = document.querySelector('.user-name');
            const avatarEl = document.querySelector('.user-avatar');
            const menuNameEl = document.querySelector('.user-menu-name');

            if (auth && auth.region) {
                const displayName = auth.name || 'User';
                if (userNameEl) userNameEl.textContent = displayName;
                if (menuNameEl) menuNameEl.textContent = `${displayName} (${auth.region})`;
                if (avatarEl) avatarEl.textContent = (displayName[0] || 'U').toUpperCase();
            } else {
                if (userNameEl) userNameEl.textContent = 'Daniel';
                if (menuNameEl) menuNameEl.textContent = 'Daniel Wang';
                if (avatarEl) avatarEl.textContent = 'D';
            }

            // Optional: disable region-tagged elements (if you add data-region attributes in HTML)
            document.querySelectorAll('[data-region]').forEach(el => {
                const region = el.getAttribute('data-region');
                if (!region) return;
                if (canViewRegion(region)) {
                    el.classList.remove('restricted');
                    el.removeAttribute('aria-disabled');
                } else {
                    el.classList.add('restricted');
                    el.setAttribute('aria-disabled', 'true');
                }
            });

            // Region-only mode UI enforcement
            try { applyRegionOnlyUI(); } catch (e) { console.warn(e); }
        }

        function showLoginModal() {
            const modal = document.getElementById('loginModal');
            if (!modal) return;
            modal.classList.add('show');
            modal.setAttribute('aria-hidden', 'false');

            // Prefill from auth
            const auth = getAuth();
            const nameEl = document.getElementById('loginName');
            const regionEl = document.getElementById('loginRegion');
            const passEl = document.getElementById('loginPass');
            const errEl = document.getElementById('loginError');
            if (errEl) { errEl.classList.remove('show'); errEl.textContent = ''; }
            if (nameEl) nameEl.value = auth?.name || '';
            if (regionEl) regionEl.value = auth?.region || '';
            if (passEl) passEl.value = '';

            // Prevent background scroll
            document.body.style.overflow = 'hidden';
        }

        function closeLoginModal() {
            const modal = document.getElementById('loginModal');
            if (!modal) return;
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = 'auto';
        }

        function applyDemoLogin() {
            // Quick demo: set TW with demo passcode
            document.getElementById('loginName').value = 'TW User';
            document.getElementById('loginRegion').value = 'TW';
            document.getElementById('loginPass').value = REGION_PASSCODES['TW'];
        }

        function login() {
            const name = (document.getElementById('loginName').value || '').trim();
            const region = (document.getElementById('loginRegion').value || '').trim().toUpperCase();
            const pass = (document.getElementById('loginPass').value || '').trim();
            const errEl = document.getElementById('loginError');

            function showErr(msg) {
                if (!errEl) return;
                errEl.textContent = msg;
                errEl.classList.add('show');
            }

            if (!region) return showErr('請選擇區域');
            if (!pass) return showErr('請輸入通關碼');

            const expected = REGION_PASSCODES[region];
            if (!expected) return showErr('未知的區域');
            if (pass !== expected) return showErr('通關碼錯誤');

            setAuth({ name: name || 'User', region, ts: Date.now() });
            closeLoginModal();
            enforceAuthUI();
            showToast(`登入成功：${region} - 正在切換至該區域資料`);
            
            // 重新渲染儀表板以套用區域過濾
            if (typeof refreshDashboardWithFilters === 'function' && processedData) {
                setTimeout(() => refreshDashboardWithFilters(), 100);
            }
        }

        function logout() {
            clearAuth();
            enforceAuthUI();
            showToast('已登出 - 切換回全區域檢視');
            
            // 重新渲染儀表板以顯示所有區域
            if (typeof refreshDashboardWithFilters === 'function' && processedData) {
                setTimeout(() => refreshDashboardWithFilters(), 100);
            }
        }

        // Close login modal by clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('loginModal');
            if (!modal) return;
            if (e.target === modal) closeLoginModal();
        });

        // Initialize auth UI on load
        document.addEventListener('DOMContentLoaded', function() {
            enforceAuthUI();
        });

        // ==================== 表格彈窗功能 ====================
        
        function showTableModal(type) {
            const modal = document.getElementById('tableModal');
            const title = document.getElementById('tableModalTitle');
            const body = document.getElementById('tableModalBody');
            
            let tableContent = '';
            let tableTitle = '';
            
            if (type === 'budget') {
                tableTitle = '💰 Sales Budget - 各區域月份預算明細 (USD, K)';
                const budgetTable = document.getElementById('budgetTable');
                if (budgetTable && budgetTable.innerHTML) {
                    tableContent = `
                        <div class="table-wrapper">
                            <table class="single-table">
                                ${budgetTable.innerHTML}
                            </table>
                        </div>
                    `;
                } else {
                    tableContent = '<p style="text-align: center; color: #6b7280; padding: 2rem;">尚未生成表格數據</p>';
                }
            } else if (type === 'rolling') {
                tableTitle = '📈 Rolling Forecast - 各區域滾動預測明細 (USD, K)';
                const rollingTable = document.getElementById('rollingTable');
                if (rollingTable && rollingTable.innerHTML) {
                    tableContent = `
                        <div class="table-wrapper">
                            <table class="single-table">
                                ${rollingTable.innerHTML}
                            </table>
                        </div>
                    `;
                } else {
                    tableContent = '<p style="text-align: center; color: #6b7280; padding: 2rem;">尚未生成表格數據</p>';
                }
            } else if (type === 'openpo') {
                tableTitle = '🔄 Open PO - 各區域未交訂單明細 (USD, K)';
                const openpoTable = document.getElementById('openpoTable');
                if (openpoTable && openpoTable.innerHTML) {
                    tableContent = `
                        <div class="table-wrapper">
                            <table class="single-table">
                                ${openpoTable.innerHTML}
                            </table>
                        </div>
                    `;
                } else {
                    tableContent = '<p style="text-align: center; color: #6b7280; padding: 2rem;">尚未生成表格數據</p>';
                }
            }
            
            title.textContent = tableTitle;
            body.innerHTML = tableContent;
            modal.style.display = 'flex';
            
            // 防止背景滾動
            document.body.style.overflow = 'hidden';
        }
        
        function closeTableModal(event) {
            // 如果點擊的是背景或關閉按鈕
            if (!event || event.target.id === 'tableModal' || event.type === 'click') {
                const modal = document.getElementById('tableModal');
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }
        
        // ESC 鍵關閉彈窗
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeTableModal();
            }
        });

        // 點擊模態框外部關閉
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('cellDetailModal');
            if (e.target === modal) {
                closeCellDetail();
            }
        });

    </script>
</div> <!-- 關閉 main-content -->
<!-- ==================== Login Modal (UI Access Control) ==================== -->
<div aria-hidden="true" class="login-modal" id="loginModal">
<div aria-labelledby="loginTitle" aria-modal="true" class="login-card" role="dialog">
<div class="login-card-header">
<div>
<div class="login-card-title" id="loginTitle">🔐 權限登入（前端 UI 控制）</div>
<div style="font-size:0.85rem; color: var(--text-secondary); margin-top:0.2rem;">登入後才可查看各區「機種 / 單價 / 明細」</div>
</div>
<button class="btn-secondary" onclick="closeLoginModal()">關閉</button>
</div>
<div class="login-card-body">
<div class="login-grid">
<div class="login-field">
<label for="loginName">顯示名稱（可選）</label>
<input id="loginName" placeholder="例如 Daniel" type="text"/>
</div>
<div class="login-field">
<label for="loginRegion">區域（必填）</label>
<select id="loginRegion">
<option value="">請選擇</option>
<option value="DEJ">DEJ</option>
<option value="VU">VU</option>
<option value="VJP">VJP</option>
<option value="TW">TW</option>
<option value="ANZ">ANZ</option>
<option value="MN">MN</option>
<option value="EU">EU</option>
<option value="ADMIN">ADMIN（可看全部）</option>
</select>
</div>
<div class="login-field">
<label for="loginPass">通關碼（必填）</label>
<input id="loginPass" placeholder="請輸入區域通關碼" type="password"/>
</div>
</div>
<div class="login-hint">
<div style="font-weight:700; margin-bottom:0.25rem;">⚠️ 注意</div>
<div>這是「前端 UI 權限」：會把沒有權限的按鈕灰掉、阻止開啟明細 modal。</div>
<div>若明細資料已經載入到瀏覽器，熟悉技術的人仍可能從開發者工具取得資料。</div>
</div>
<div class="login-error" id="loginError"></div>
<div class="login-actions">
<button class="btn-secondary" onclick="applyDemoLogin()">快速 Demo 登入</button>
<button class="btn-primary" onclick="login()">登入</button>
</div>
</div>
</div>
</div>
<div class="no-access-toast" id="noAccessToast"></div>
</body>
</html>